<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr" dir="ltr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Script-Type" content="text/javascript"/>
    <meta http-equiv="Content-Style-Type" content="text/css"/>
    <meta http-equiv="Content-Language" content="fr"/>
    <title>tutoriel:pacemaker_configuration_ip_virtuelle_plus_script_lsb - Documentation Ubuntu Francophone</title>
    <meta name="Description" content="Documentation francophone pour la distribution Ubuntu" lang="fr" />
    <meta name="language" content="fr-FR" />

    <!--[if IE 8]>
    <meta http-equiv="X-UA-Compatible" content="IE=8" />
    <![endif]-->
        <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="date" content="2015-03-23T19:21:46+0100"/>
<meta name="keywords" content="lucid,tutoriel,haute disponibilite"/>
<link rel="search" type="application/opensearchdescription+xml" href="../lib/exe/opensearch.php" title="Documentation Ubuntu Francophone"/>
<link rel="start" href="../index.html"/>
<link rel="contents" href="http://doc.ubuntu-fr.org/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=index" title="Plan du site"/>
<link rel="alternate" type="application/rss+xml" title="Derniers changements" href="../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Namespace actuel" href="../feed.php?mode=list&amp;ns=tutoriel"/>
<link rel="edit" title="Modifier cette page" href="http://doc.ubuntu-fr.org/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=edit"/>
<link rel="alternate" type="text/html" title="HTML brut" href="http://doc.ubuntu-fr.org/_export/xhtml/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"/>
<link rel="alternate" type="text/plain" title="Wiki balise" href="http://doc.ubuntu-fr.org/_export/raw/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"/>
<link rel="canonical" href="pacemaker_configuration_ip_virtuelle_plus_script_lsb"/>
<link rel="stylesheet" type="text/css" href="../lib/exe/css.php?t=ubuntu-2010&amp;tseed=4af22dedc19f28c99fa67afabbb173df"/>
<script type="text/javascript">/*<![CDATA[*/var NS='tutoriel';var JSINFO = {"id":"tutoriel:pacemaker_configuration_ip_virtuelle_plus_script_lsb","namespace":"tutoriel"};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../lib/exe/js.php?tseed=4af22dedc19f28c99fa67afabbb173df"></script>
    <link rel="shortcut icon" href="http://www-static.ubuntu-fr.org/theme2010/images/commun/ubuntu/icone.png" type="image/x-icon" />
    <link rel="apple-touch-icon" href="http://www-static.ubuntu-fr.org/theme2010/images/commun/ubuntu/touch-ico.png" />

    <link rel="stylesheet" media="screen" type="text/css" title="Design Ubuntu-fr" href="http://www-static.ubuntu-fr.org/theme2010/css/doc.css" />
    <link rel="stylesheet" media="screen" type="text/css" title="Design Ubuntu-fr" href="http://www-static.ubuntu-fr.org/theme2010/css/doc-ubuntu.css" />
    <link rel="stylesheet" media="print" type="text/css" title="Design Ubuntu-fr" href="http://www-static.ubuntu-fr.org/theme2010/css/doc-print.css" />

    <script type="text/javascript">
      var menu_hidden;
      var static_url = "UFR_STATIC";
    </script>
    <script src="http://www-static.ubuntu-fr.org/theme2010/js/menu.js" type="text/javascript"></script>
    <script src="http://www-static.ubuntu-fr.org/theme2010/js/common.js" type="text/javascript"></script>
  </head>
  <body>

    <div id="accessibar">
      <a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#main" tabindex="1">Contenu</a> | <a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#qsearch__in" tabindex="2">Rechercher</a> | <a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#navigation" tabindex="3">Menus</a>
    </div>

    <div id="page">

      <div id="header">

        <div id="logo">
          <h1>Ubuntu-fr</h1>
          <a href="../index.html" title="Accueil de la documentation">Communauté francophone d'utilisateurs d'Ubuntu</a>
        </div>

        <form action="http://ubuntu-fr.org/recherche" accept-charset="utf-8" id="search" onsubmit="if (document.getElementById('qsearch__in').value == 'Recherche rapide....') {document.getElementById('qsearch__in').value = '';}">
          <fieldset>
            <label for="qsearch__in">Recherche : </label><input type="text" value="Recherche rapide...." id="qsearch__in" accesskey="f" name="sk_q" alt="[F]" size="34" tabindex="4" />
            <label for="tsearch_field">Chercher dans : </label><select name="sk_engine" tabindex="5" id="tsearch_field" title="Chercher dans">
              <option value="all">Site</option>
              <option selected="selected" value="doc">Documentation</option>
              <option value="forum">Forum</option>
              <option value="planet">Planet</option>
            </select>
            <input type="submit" value="ok" class="button" alt="Lancer la recherche" tabindex="5" />
          </fieldset>
        </form>
        <!--[if lte IE 7]><div class="clear"></div><![endif]-->

        <form action="pacemaker_configuration_ip_virtuelle_plus_script_lsb" accept-charset="utf-8" id="login_top" method="post">
          <fieldset>
            <label for="u_field">Identifiant : </label><input type="text" value="Identifiant" name="u" id="u_field" size="9" /><label for="p_field">Mot de passe : </label><input type="password" value="Mot de passe" name="p" id="p_field" size="9" alt="Mot de passe" /><input type="submit" value="connexion" id="connect" /> / <a href="http://forum.ubuntu-fr.org/register.php">inscription</a>
          </fieldset>
        </form>
 

      </div>

      <div id="navbar">
          <h2 id="pagetitle"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb" >tutoriel:pacemaker_configuration_ip_virtuelle_plus_script_lsb</a></h2>
      </div>

      
      <div id="main" class="dokuwiki">

        <div id="hidemenu" title="Masquer le menu"></div>

        <div id="pagerror"></div>
                <div class="notetag">Selon les <a href="../tags">tags</a> présents sur cette page, les informations qu'elle contient  n'ont pas été vérifiées depuis <a href="../lucid">Ubuntu 10.04 LTS.</a><br />
<a href="../wiki/participer_wiki">Apportez votre aide…</a>
</div>
<!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table des matières</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#pre-requis">Pré-requis</a></div></li>
<li class="level1"><div class="li"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#configuration">Configuration</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#parametrage_des_options_generales">Paramétrage des options générales</a></div></li>
<li class="level2"><div class="li"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#parametrage_du_service_nginx">Paramétrage du service nginx</a></div></li>
<li class="level2"><div class="li"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#parametrage_de_l_ip_virtuelle">Paramétrage de l&#039;ip virtuelle</a></div></li>
<li class="level2"><div class="li"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#lien_entre_les_ressources">Lien entre les ressources</a></div></li>
<li class="level2"><div class="li"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#verification_et_application_de_la_configuration">Vérification et application de la configuration</a></div></li>
<li class="level2"><div class="li"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#afficher_l_etat_du_cluster">Afficher l&#039;état du cluster</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#tester_sa_configuration">Tester sa configuration</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#meurtre_du_processus_nginx">Meurtre du processus nginx</a></div></li>
<li class="level2"><div class="li"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#blocage_du_redemarrage_du_serveur_nginx">Blocage du redémarrage du serveur nginx</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="pacemaker_configuration_ip_virtuelle_plus_script_lsb#voir_aussi">Voir aussi</a></div></li>
</ul>
</div>
</div>
<!-- TOC END -->
<div class="tags"><span>
	<a href="../lucid" class="wikilink1" title="lucid" rel="tag">Lucid</a>,
	<a href="http://doc.ubuntu-fr.org/tutoriel" class="wikilink1" title="tutoriel" rel="tag">tutoriel</a>,
	<a href="../haute_disponibilite" class="wikilink1" title="haute_disponibilite" rel="tag">haute disponibilité</a>
</span></div>
<hr />

<h1 class="sectionedit1" id="cluster_de_deux_machines_ip_virtuelle_supervision_d_un_service">Cluster de deux machines ip virtuelle + supervision d&#039;un service</h1>
<div class="level1">

<p>
Ce tutoriel est une sous-partie de la documentation pacemaker. Il décrit les différentes étapes de configuration du cluster par l&#039;intermédiaire de la commande crm. Je vous conseille néanmoins de configurer les ressources avec l&#039;interface java de Linbit.
</p>

<p>
Le but de cette configuration est de créer un cluster de serveur web (ou de reverse proxy) de deux machines. Une adresse virtuelle est partagée entre les deux machines, lorsque l&#039;une d&#039;entre elle est hors ligne l&#039;autre machine peut prendre le relai automatiquement.
</p>

<p>
Détail des étapes de la configuration:
</p>
<ol>
<li class="level1"><div class="li"> Adresse ip virtuelle partagée entre les deux membres du cluster ici 192.168.1.100</div>
</li>
<li class="level1"><div class="li"> Lancement, arrêt et supervision d&#039;un service par l&#039;intermédiaire d&#039;un script d&#039;initialisation compatible LSB (ici nginx)</div>
</li>
<li class="level1"><div class="li"> Clonage du service, nginx sera démarré sur les deux machines</div>
</li>
<li class="level1"><div class="li"> Ordonnancement des ressources le service, nginx devra être démarré pour que l&#039;adresse ip virtuelle soit attribuée à un membre du cluster</div>
</li>
</ol>
<div class="table sectionedit2"><table class="inline">
	<thead>
	<tr class="row0">
		<td class="col0 leftalign">              </td><th class="col1 leftalign"> Nom de poste                  </th><th class="col2 leftalign"> Adresse ip          </th>
	</tr>
	</thead>
	<tr class="row1">
		<th class="col0 leftalign"> pc 1      </th><td class="col1 leftalign"> machine1            </td><td class="col2 leftalign"> 192.168.1.101    </td>
	</tr>
	<tr class="row2">
		<th class="col0 leftalign"> pc 2      </th><td class="col1"> machine2 </td><td class="col2 centeralign">             192.168.1.102     </td>
	</tr>
</table></div>

</div>
<div class='secedit editbutton_section editbutton_1'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Cluster de deux machines ip virtuelle + supervision d'un service] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="51-1314" /><input type="submit" value="Modifier" class="button" title="Cluster de deux machines ip virtuelle + supervision d'un service" /></div></form></div>
<h2 class="sectionedit3" id="pre-requis">Pré-requis</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Bien connaître le principe de fonctionnement de <a href="../pacemaker" class="wikilink1" title="pacemaker">pacemaker</a>.</div>
</li>
<li class="level1"><div class="li"> Comprendre le principe de la norme LSB pour les scripts d&#039;initialisation. </div>
</li>
</ul>

<p>
<p><div class="noteclassic">
Les scripts d&#039;initialisation sont ceux disponibles dans le répertoire /etc/init.d/. Pacemaker va les utiliser pour démarrer, arrêter et superviser l&#039;état du service. C&#039;est pourquoi ces scripts doivent respecter les normes lsb. Pacemaker a par exemple besoin que les scripts possèdent un argument status. Pour plus d&#039;informations visitez cette <a href="http://wiki.debian.org/LSBInitScripts" class="urlextern" title="http://wiki.debian.org/LSBInitScripts"  rel="nofollow">page</a>

</div></p>
</p>
<ul>
<li class="level1"><div class="li"> Avoir effectué le tutoriel officiel en anglais est une bonne chose. <a href="http://www.clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Clusters_from_Scratch/index.html" class="urlextern" title="http://www.clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Clusters_from_Scratch/index.html"  rel="nofollow">lien</a> </div>
</li>
<li class="level1"><div class="li"> Ne pas avoir peur de lire la documentation officielle de pacemaker qui se trouve <a href="http://www.clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Pacemaker_Explained/index.html" class="urlextern" title="http://www.clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Pacemaker_Explained/index.html"  rel="nofollow">ici</a>.</div>
</li>
</ul>

</div>
<div class='secedit editbutton_section editbutton_3'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Pré-requis] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="1315-2255" /><input type="submit" value="Modifier" class="button" title="Pré-requis" /></div></form></div>
<h2 class="sectionedit4" id="configuration">Configuration</h2>
<div class="level2">

<p>
Entrer dans le mode de configuration du cluster
</p>
<pre class="code">sudo crm configure</pre>

</div>
<div class='secedit editbutton_section editbutton_4'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Configuration] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="2256-2357" /><input type="submit" value="Modifier" class="button" title="Configuration" /></div></form></div>
<h3 class="sectionedit5" id="parametrage_des_options_generales">Paramétrage des options générales</h3>
<div class="level3">

<p>
Premierement nous allons désactiver deux fonctionnalités inutile pour notre cluster 
</p>
<ul>
<li class="level1"><div class="li"> mode stonith &quot;shot the other node in the head&quot; permet lorsqu&#039;une machine n&#039;est plus joignable d&#039;être sur que cette machine soit bien hors ligne</div>
</li>
<li class="level1"><div class="li"> quorum indique le nombre minimal de membres pour prendre une décision. Ce paramètre est utile pour les cluster de plus de deux machines</div>
</li>
</ul>

<p>
Désactivation du mode stonith
</p>
<pre class="code">property stonith-enabled=false</pre>

<p>
Désctivation du paramètre quorum
</p>
<pre class="code">property no-quorum-policy=ignore </pre>

</div>
<div class='secedit editbutton_section editbutton_5'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Paramétrage des options générales] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="2358-2930" /><input type="submit" value="Modifier" class="button" title="Paramétrage des options générales" /></div></form></div>
<h3 class="sectionedit6" id="parametrage_du_service_nginx">Paramétrage du service nginx</h3>
<div class="level3">

<p>
Avant toute chose pensez à désactiver le démarrage automatique du démon avec la commande ci dessous 
</p>
<pre class="code">sudo update-rc.d -f nginx remove</pre>

<p>
Ensuite nous allons indiquer à pacemaker de superviser le processus nginx. Pour cela il est nécessaire que le logiciel possède un script de démarrage et d&#039;arrêt dans le répertoire /etc/init.d. Ce script doit en outre respecter les normes LSB (si il est est déjà présent il doit sûrement les respecter). A l&#039;avenir c&#039;est pacemaker qui démarrera nginx par intermédiaire de ce script. 
</p>

<p>
Instruction permettant à pacemaker de superviser un programme par l&#039;intermédiaire de son script systemV (init script)
</p>

<p>
Syntaxe de base
</p>
<pre class="code">primitive &lt;nom de la ressource (ce que vous voulez)&gt; lsb::&lt;nom du démon&gt; op monitor interval=5s</pre>

<p>
Dans notre cas 
</p>
<pre class="code">primitive reverse-proxy lsb::nginx op monitor interval=5s</pre>

<p>
Clonage de la ressource pour que le démon nginx soit démarré sur les deux machines en même temps. Cela permet une migration plus rapide. Pacemaker n&#039;ayant pas à démarrer le processus puis à faire migrer l&#039;adresse ip.
</p>

<p>
Syntaxe de base
</p>
<pre class="code">clone &lt;nom de la ressource&gt; &lt;nom de la ressource à cloner&gt;</pre>

<p>
Dans notre cas 
</p>
<pre class="code">clone clone_reverse_proxy reverse-proxy </pre>

</div>
<div class='secedit editbutton_section editbutton_6'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Paramétrage du service nginx] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="2931-4199" /><input type="submit" value="Modifier" class="button" title="Paramétrage du service nginx" /></div></form></div>
<h3 class="sectionedit7" id="parametrage_de_l_ip_virtuelle">Paramétrage de l&#039;ip virtuelle</h3>
<div class="level3">

<p>
Création d&#039;une ip virtuelle partagée entre les deux membres du cluster
</p>
<pre class="code">  primitive &lt;nom de la ressource&gt; ocf:heartbeat:IPaddr2 params ip=&quot;&lt;adresse ip virtuelle&gt;&quot; broadcast=&quot;&lt;adresse de broadcast&gt;&quot; cidr_netmask=&quot;&lt;masque en écriture décimal&gt;&quot; nic=&quot;&lt;nom de l&#039;interface virtuelle&gt;&quot; meta target-role=&quot;started&quot; migration-threshold=&quot;2&quot; resource-stickiness=&quot;100&quot;
 op monitor interval=&quot;&lt;interval de temps de supervision&gt;&quot;</pre>

<p>
explications:
</p>
<div class="table sectionedit8"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> Options         </th><th class="col1 leftalign"> explications           </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign"> target-role   </td><td class="col1 leftalign"> started ou stopped l&#039;état dans lequel pacemaker doit maintenir la ressource     </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> migration-threshold   </td><td class="col1 leftalign"> nombre maximal d&#039;échec de la ressource, après lesquels la machine est déclarée inéligible pour recevoir la ressource     </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign"> resource-stickiness   </td><td class="col1 leftalign"> Ce paramètre est utile lorsque l&#039;on définit une règle &quot;location&quot; indiquant la machine élue par défaut pour héberger la ressource. Nous ferons une configuration de ce type plus tard. Ce paramètre empêche la ressource de retourner sur la machine élue par défaut après que celle ci est défaillit et soit revenue en ligne. La ressource devra être migrée manuellement.  La valeure numérique attribuée à ce paramètre doit être supérieure à celle attribuée dans la règle &quot;location&quot;.   </td>
	</tr>
</table></div>

<p>
Dans notre cas 
</p>
<pre class="code"> 
  primitive ip_virtuelle ocf:heartbeat:IPaddr2 params ip=&quot;192.168.1.100&quot; broadcast=&quot;192.168.1.255&quot; cidr_netmask=&quot;24&quot; nic=&quot;eth0:0&quot; meta target-role=&quot;started&quot; migration-threshold=&quot;2&quot; resource-stickiness=&quot;100&quot;
 op monitor interval=&quot;10s&quot;</pre>

</div>
<div class='secedit editbutton_section editbutton_7'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Paramétrage de l'ip virtuelle] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="4200-5793" /><input type="submit" value="Modifier" class="button" title="Paramétrage de l'ip virtuelle" /></div></form></div>
<h3 class="sectionedit9" id="lien_entre_les_ressources">Lien entre les ressources</h3>
<div class="level3">

<p>
Par défaut pacemaker répartie les ressources entre les membres du cluster. Bien qu&#039;ici une des ressources soit clonée il est préférable de créér un lien entre les deux ressources  <em>clone_reverse_proxy</em> et <em>ip_virtuelle</em>
</p>

<p>
Syntaxe de base 
</p>
<pre class="code">colocation link-ressources INFINITY: &lt;nom de la deuxième ressource&gt;  &lt;nom de la première ressource&gt;</pre>

<p>
Dans notre cas 
</p>
<pre class="code">colocation link-ressources INFINITY: ip_virtuelle clone_reverse_proxy </pre>

<p>
Il est aussi nécessaire d&#039;établir un ordre de démarrage entre les ressources. En effet l&#039;ip virtuelle ne doit être activée que si le démon nginx est lancée
</p>

<p>
Syntaxe de base 
</p>
<pre class="code">order &lt;nom de la ressource&gt; mandatory: &lt;première ressource à lancer&gt;  &lt;deuxième ressource&gt;</pre>

<p>
Dans notre cas 
</p>
<pre class="code">order demon_before mandatory: clone_reverse_proxy  ip_virtuelle</pre>

<p>
Il peut aussi être intéressant de choisir une machine préférée pour accueillir la ressource. Ici nous voulons que l&#039;adresse ip virtuelle soit activée par défaut sur la machine1.
</p>

<p>
Syntaxe de base
</p>
<pre class="code">location &lt;nom ressource&gt; &lt;nom de la ressource&gt; &lt;score&gt;: &lt;nom du poste&gt;</pre>

<p>
Dans notre cas 
</p>
<pre class="code">location node-master ip_virtuelle 50: machine1</pre>

</div>
<div class='secedit editbutton_section editbutton_9'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Lien entre les ressources] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="5794-6992" /><input type="submit" value="Modifier" class="button" title="Lien entre les ressources" /></div></form></div>
<h3 class="sectionedit10" id="verification_et_application_de_la_configuration">Vérification et application de la configuration</h3>
<div class="level3">

<p>
Vérifier que votre configuration est correcte, normalement l&#039;analyse ne doit pas rapporter d&#039;erreurs
</p>
<pre class="code">verify</pre>

<p>
Puis appliquez votre configuration au cluster
</p>
<pre class="code">commit</pre>

</div>
<div class='secedit editbutton_section editbutton_10'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Vérification et application de la configuration] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="6993-7225" /><input type="submit" value="Modifier" class="button" title="Vérification et application de la configuration" /></div></form></div>
<h3 class="sectionedit11" id="afficher_l_etat_du_cluster">Afficher l&#039;état du cluster</h3>
<div class="level3">

<p>
Affichage de l&#039;état du cluster, avec les compteurs d&#039;échecs
</p>
<pre class="code">sudo crm_mon -1f</pre>

<p>
Vous devriez voir un résultat semblable
</p>
<pre class="code">Online: [ machine1 machine2 ]
Clone Set: clone_reverse_proxy
   Started: [ machine1 machine2 ]
ip_virtuelle	(ocf::heartbeat:IPaddr2):	Started machine1</pre>

</div>
<div class='secedit editbutton_section editbutton_11'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Afficher l'état du cluster] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="7226-7551" /><input type="submit" value="Modifier" class="button" title="Afficher l'état du cluster" /></div></form></div>
<h2 class="sectionedit12" id="tester_sa_configuration">Tester sa configuration</h2>
<div class="level2">

<p>
Vous pouvez facilement vous rendre compte des migrations de ressources dans le cluster en personnalisant les pages internet des serveurs webs nginx. Le chemin de la page d&#039;accueil est <em>/var/www/nginx-default/index.html</em> .
</p>

</div>
<div class='secedit editbutton_section editbutton_12'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Tester sa configuration] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="7552-7812" /><input type="submit" value="Modifier" class="button" title="Tester sa configuration" /></div></form></div>
<h3 class="sectionedit13" id="meurtre_du_processus_nginx">Meurtre du processus nginx</h3>
<div class="level3">

<p>
Effectuer les commandes sur le poste hébergeant l&#039;adresse ip virtuelle.
</p>
<pre class="code">ps -aux | grep nginx
kill &lt;numéro processus&gt;</pre>

<p>
Vous devriez voir que le compteur d&#039;échec a été incrémenté 
</p>
<pre class="code">Online: [ machine1 machine2 ]
Clone Set: clone_reverse_proxy
   Started: [ machine1 machine2 ]
ip_virtuelle	(ocf::heartbeat:IPaddr2):	Started machine1
Migration summary:
* Node machine2: 
* Node machine1: 
   reverse-proxy:0: migration-threshold=1000000 fail-count=1</pre>

<p>
et si vous effectuez cette commande 
</p>
<pre class="code">sudo /etc/init.d/nginx status</pre>

<p>
Elle devrait vous retourner ce retour 
</p>
<pre class="code">nginx is running</pre>

<p>
Le processus a bien été redémarré après qu&#039;il a été tué. Il n&#039;y a pas eu de migration de l&#039;adresse ip.
</p>

</div>
<div class='secedit editbutton_section editbutton_13'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Meurtre du processus nginx] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="7813-8572" /><input type="submit" value="Modifier" class="button" title="Meurtre du processus nginx" /></div></form></div>
<h3 class="sectionedit14" id="blocage_du_redemarrage_du_serveur_nginx">Blocage du redémarrage du serveur nginx</h3>
<div class="level3">

<p>
Cette fois ci nous allons être un peu plus pervers. Nous allons empêcher le serveur nginx de redémarrer. Normalement l&#039;adresse ip devrait migrer vers l&#039;autre machine.
</p>

<p>
Éditer le fichier /etc/nginx/nginx.conf et ajouter cette ligne au début du fichier
</p>
<pre class="code">plop !</pre>

<p>
Tuer à nouveau le processus du démon nginx 
</p>

<p>
Vous devriez obtenir ce résultat
</p>
<pre class="code">Online: [ machine1 machine2 ]
Clone Set: clone_reverse_proxy
   Started: [ machine2 ]
   Stopped: [ reverse-proxy:0 ]
ip_virtuelle	(ocf::heartbeat:IPaddr2):	Started machine2
Migration summary:
* Node machine2: 
* Node machine1: 
   reverse-proxy:0: migration-threshold=1000000 fail-count=1000000</pre>

<p>
On peut voir que l&#039;adresse ip virtuelle a été migrée vers la machine 2 et que le compteur d&#039;échec a été fixé à sa valeur maximale.
</p>

</div>
<div class='secedit editbutton_section editbutton_14'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Blocage du redémarrage du serveur nginx] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="8573-9430" /><input type="submit" value="Modifier" class="button" title="Blocage du redémarrage du serveur nginx" /></div></form></div>
<h2 class="sectionedit15" id="voir_aussi">Voir aussi</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <strong>(fr)</strong> <a href="../pacemaker" class="wikilink1" title="pacemaker">fiche du logiciel pacemaker</a></div>
</li>
</ul>
<hr />

<p>
<em>Contributeurs principaux : <a href="http://doc.ubuntu-fr.org/utilisateurs/miam_miam" class="wikilink1" title="utilisateurs:miam_miam">Miam Miam</a>.</em>
</p>

</div>
<div class='secedit editbutton_section editbutton_15'><form class="button btn_secedit" method="post" action="pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1427134906" /><input type="hidden" name="summary" value="[Voir aussi] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="range" value="9431-" /><input type="submit" value="Modifier" class="button" title="Voir aussi" /></div></form></div>
<!-- cachefile /srv/www/doc.ubuntu-fr.org/htdocs/data/cache/5/5603283eecee5f9011bda602d51b0022.xhtml used -->

        <br style="clear:both;" />
        <div id="pageinfo">
            <!--  |  | -->
            <!-- ?tpl_pageinfo()? -->
            <br />
            Le contenu de ce wiki est sous licence : <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" rel="license" target="_blank">CC BY-SA v3.0</a>
        </div> 
      </div>

      
      <div id="navigation">

        <ul>
          <li class="menu"><a href="http://www.ubuntu-fr.org" class="title" id="menu-accueil"><span>Accueil</span></a></li>
          <li class="menu" id="active">
            <a href="../index.html"  class="title" id="menu-doc"><span>Documentation</span></a>
            <ul>
              <li id="navWiki" class="cat">
                <h2>Actions</h2>
                <ul>
                  <li><a href="http://doc.ubuntu-fr.org/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=index"  class="action index" accesskey="x" rel="nofollow" title="Plan du site [X]">Plan du site</a></li>
                  <li><a href="http://doc.ubuntu-fr.org/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=edit&amp;rev=0"  class="action edit" accesskey="e" rel="nofollow" title="Modifier cette page [E]">Modifier cette page</a></li>
                  <li><a href="http://doc.ubuntu-fr.org/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]">Anciennes révisions</a></li>
                  <li></li>
                  <li><a href="http://doc.ubuntu-fr.org/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Derniers changements [R]">Derniers changements</a></li>
                  <li><a href="http://doc.ubuntu-fr.org/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=backlink"  class="action backlink" rel="nofollow" title="Liens vers cette page">Liens vers cette page</a></li>
                  <li></li>
                  <li></li>
                  <li></li>
                </ul>
              </li>
              <li id="navDivers" class="cat">
                <h2>Divers</h2>
                <ul>
                  <li><bdi><a href="../wiki/participer_wiki" class="wikilink1" title="wiki:participer_wiki">Participer à la documentation</a></bdi></li>
                  <li><bdi><a href="../documentation_hors_ligne" class="wikilink1" title="documentation_hors_ligne">Documentation hors ligne</a></bdi></li>
                  <li><a href="http://www.ubuntu-fr.org/telechargement" title="T&eacute;l&eacute;charger Ubuntu">T&eacute;l&eacute;charger Ubuntu</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="menu"><a href="http://forum.ubuntu-fr.org"  class="title" id="menu-forum"><span>Forum</span></a></li>
          <li class="menu"><a href="http://planet.ubuntu-fr.org"  class="title" id="menu-planet"><span>Planet</span></a></li>
        </ul>

      </div>
      <div id="references-ufr">
        <ul id="legal-ufr">
          <li><a href="http://www.ubuntu-fr.org/contacts">Contact</a></li>
        </ul>

        <ul id="sponsors-ufr">
          <li><a href="http://www.dokuwiki.org/dokuwiki" id="dokuwiki">Propulsé par Dokuwiki</a></li>
        </ul>
      </div>

    </div>
    <!-- $Id$ -->

    <!-- Piwik Image Tracker -->
    <!-- img src="http://piwik.infra.ubuntu-fr.org/piwik.php?idsite=2&amp;rec=1" style="border:0" alt="" /-->
    <!-- End Piwik -->

  </body>
</html>
