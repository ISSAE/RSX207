<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr" dir="ltr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Script-Type" content="text/javascript"/>
    <meta http-equiv="Content-Style-Type" content="text/css"/>
    <meta http-equiv="Content-Language" content="fr"/>
    <title>tutoriel:network_tpme - Documentation Ubuntu Francophone</title>
    <meta name="Description" content="Documentation francophone pour la distribution Ubuntu" lang="fr" />
    <meta name="language" content="fr-FR" />

    <!--[if IE 8]>
    <meta http-equiv="X-UA-Compatible" content="IE=8" />
    <![endif]-->
        <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="noindex,nofollow"/>
<link rel="search" type="application/opensearchdescription+xml" href="../lib/exe/opensearch.php" title="Documentation Ubuntu Francophone"/>
<link rel="start" href="../index.html"/>
<link rel="contents" href="http://doc.ubuntu-fr.org/tutoriel/network_tpme?do=index" title="Plan du site"/>
<link rel="alternate" type="application/rss+xml" title="Derniers changements" href="../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Namespace actuel" href="../feed.php?mode=list&amp;ns=tutoriel"/>
<link rel="alternate" type="text/html" title="HTML brut" href="../_export/xhtml/tutoriel/network_tpme"/>
<link rel="alternate" type="text/plain" title="Wiki balise" href="http://doc.ubuntu-fr.org/_export/raw/tutoriel/network_tpme"/>
<link rel="stylesheet" type="text/css" href="../lib/exe/css.php?t=ubuntu-2010&amp;tseed=4af22dedc19f28c99fa67afabbb173df"/>
<script type="text/javascript">/*<![CDATA[*/var NS='tutoriel';var JSINFO = {"id":"tutoriel:network_tpme","namespace":"tutoriel"};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../lib/exe/js.php?tseed=4af22dedc19f28c99fa67afabbb173df"></script>
    <link rel="shortcut icon" href="http://www-static.ubuntu-fr.org/theme2010/images/commun/ubuntu/icone.png" type="image/x-icon" />
    <link rel="apple-touch-icon" href="http://www-static.ubuntu-fr.org/theme2010/images/commun/ubuntu/touch-ico.png" />

    <link rel="stylesheet" media="screen" type="text/css" title="Design Ubuntu-fr" href="http://www-static.ubuntu-fr.org/theme2010/css/doc.css" />
    <link rel="stylesheet" media="screen" type="text/css" title="Design Ubuntu-fr" href="http://www-static.ubuntu-fr.org/theme2010/css/doc-ubuntu.css" />
    <link rel="stylesheet" media="print" type="text/css" title="Design Ubuntu-fr" href="http://www-static.ubuntu-fr.org/theme2010/css/doc-print.css" />

    <script type="text/javascript">
      var menu_hidden;
      var static_url = "UFR_STATIC";
    </script>
    <script src="http://www-static.ubuntu-fr.org/theme2010/js/menu.js" type="text/javascript"></script>
    <script src="http://www-static.ubuntu-fr.org/theme2010/js/common.js" type="text/javascript"></script>
  </head>
  <body>

    <div id="accessibar">
      <a href="network_tpme?do=edit&amp;rev=0#main" tabindex="1">Contenu</a> | <a href="network_tpme?do=edit&amp;rev=0#qsearch__in" tabindex="2">Rechercher</a> | <a href="network_tpme?do=edit&amp;rev=0#navigation" tabindex="3">Menus</a>
    </div>

    <div id="page">

      <div id="header">

        <div id="logo">
          <h1>Ubuntu-fr</h1>
          <a href="../index.html" title="Accueil de la documentation">Communauté francophone d'utilisateurs d'Ubuntu</a>
        </div>

        <form action="http://ubuntu-fr.org/recherche" accept-charset="utf-8" id="search" onsubmit="if (document.getElementById('qsearch__in').value == 'Recherche rapide....') {document.getElementById('qsearch__in').value = '';}">
          <fieldset>
            <label for="qsearch__in">Recherche : </label><input type="text" value="Recherche rapide...." id="qsearch__in" accesskey="f" name="sk_q" alt="[F]" size="34" tabindex="4" />
            <label for="tsearch_field">Chercher dans : </label><select name="sk_engine" tabindex="5" id="tsearch_field" title="Chercher dans">
              <option value="all">Site</option>
              <option selected="selected" value="doc">Documentation</option>
              <option value="forum">Forum</option>
              <option value="planet">Planet</option>
            </select>
            <input type="submit" value="ok" class="button" alt="Lancer la recherche" tabindex="5" />
          </fieldset>
        </form>
        <!--[if lte IE 7]><div class="clear"></div><![endif]-->

        <form action="network_tpme?do=edit&amp;rev=0" accept-charset="utf-8" id="login_top" method="post">
          <fieldset>
            <label for="u_field">Identifiant : </label><input type="text" value="Identifiant" name="u" id="u_field" size="9" /><label for="p_field">Mot de passe : </label><input type="password" value="Mot de passe" name="p" id="p_field" size="9" alt="Mot de passe" /><input type="submit" value="connexion" id="connect" /> / <a href="http://forum.ubuntu-fr.org/register.php">inscription</a>
          </fieldset>
        </form>
 

      </div>

      <div id="navbar">
          <h2 id="pagetitle"><a href="network_tpme" >tutoriel:network_tpme</a></h2>
      </div>

      
      <div id="main" class="dokuwiki">

        <div id="hidemenu" title="Masquer le menu"></div>

        <div id="pagerror"></div>
                
<p>
<strong>Quelques recommandations avant de créer ou de modifier cette page :</strong>
</p>
<ol>
<li class="level1"><div class="li"> Lisez le <a href="../wiki/participer_wiki" class="wikilink1" title="wiki:participer_wiki">guide du contributeur</a> et la <a href="../wiki/ligne_editoriale" class="wikilink1" title="wiki:ligne_editoriale">ligne éditoriale</a>.</div>
</li>
<li class="level1"><div class="li"> Découvrez la <a href="http://doc.ubuntu-fr.org/wiki/syntaxe" class="wikilink1" title="wiki:syntaxe">syntaxe</a> et entraînez-vous dans le <a href="../playground/playground" class="wikilink1" title="playground:playground">bac à sable</a>.</div>
</li>
<li class="level1"><div class="li"> Utilisez les modèles (<a href="../wiki/modeles/application" class="wikilink1" title="wiki:modeles:application">application</a>, <a href="../wiki/modeles/materiel" class="wikilink1" title="wiki:modeles:materiel">matériel</a>, <a href="../wiki/modeles/portable" class="wikilink1" title="wiki:modeles:portable">ordinateur portable</a>, <a href="../wiki/modeles/tutoriel" class="wikilink1" title="wiki:modeles:tutoriel">tutoriel</a>, <a href="../wiki/modeles/utilisateur" class="wikilink1" title="wiki:modeles:utilisateur">utilisateur</a>, <a href="../wiki/modeles/portail" class="wikilink1" title="wiki:modeles:portail">portail</a>) et les <a href="../wiki/mini-tutoriels" class="wikilink1" title="wiki:mini-tutoriels">mini-tutoriels</a>.</div>
</li>
<li class="level1"><div class="li"> Rapportez toutes créations ou modifications importantes sur <a href="../wiki/liste_discussion#coordination_de_la_documentation" class="wikilink1" title="wiki:liste_discussion">la liste de discussion</a>.</div>
</li>
</ol>

<!-- cachefile /srv/www/doc.ubuntu-fr.org/htdocs/data/cache/f/fcdb5fe1d67011f56447459483d05597.xhtml used -->
<script type="text/javascript">/*<![CDATA[*/
textChanged = false/*!]]>*/</script>
    <div class="editBox" role="application">

    <div class="toolbar group">
        <div id="draft__status"></div>
        <div id="tool__bar"><a href="http://doc.ubuntu-fr.org/lib/exe/mediamanager.php?ns=tutoriel"
            target="_blank">Sélection de fichiers</a></div>
    </div>
    <form id="dw__editform" method="post" action="network_tpme?do=edit&amp;rev=0" accept-charset="utf-8"><div class="no">
<input type="hidden" name="sectok" value="3bbdeeb4168d06af7a8bbdbdb8925be6" /><input type="hidden" name="id" value="tutoriel:network_tpme" /><input type="hidden" name="rev" value="0" /><input type="hidden" name="date" value="1345544516" /><input type="hidden" name="prefix" value="." /><input type="hidden" name="suffix" value="" /><input type="hidden" name="changecheck" value="e264ef6c190742e444f4f76e45858805" /><input type="hidden" name="target" value="section" /><textarea name="wikitext" id="wiki__text" dir="auto" class="edit" cols="80" rows="10" tabindex="1">
{{tag&gt;bureau_à_distance réseau serveur tutoriel dns BROUILLON}}

----



====== Création d'un réseau d'entreprise pour une TPME ou une PME ======

Si vous désirez monter un réseau d'entreprise de taille raisonnable (disons une vingtaine de postes voire plus via quelques aménagements), que vous désirez y incorporer du Windows pour quelques postes clients et que en plus, vous désirez expérimenter cela dans des machines virtuelles, ce tutoriel complet, complexe, pas uniquement réservé pour les gourous mais quand même... est pour vous.

Bonne lecture et expérimentation.


===== Description du projet =====

Ce projet a pour but premier de servir d'aide mémoire et de partager mon expérience avec des gens de tous horizons. Ce tutoriel pourrait devenir une base d'échanges d'idées ou de critiques positives sur la gestion d'un réseau en général.

Bien, commençons déjà par un schéma (car un dessin vaut mieux qu'un long discours).

{{tutoriel:network-03.png?480|Cliquez pour agrandir.}}

Comme vous pouvez vous en rendre compte, le réseau est somme toute fort classique. 2 Serveurs (PRIMARY et SECONDARY) ainsi que 2 WKS (CLIENT-1 &quot;Windows&quot; et CLIENT-2 &quot;Ubuntu DESKTOP&quot;) et pour finir 2 switches (VSWITCH1 et VSWITCH2). Vous remarquerez également que tout ce joli petit monde est &quot;émulé&quot; ou &quot;virtualisé&quot;. Nous verrons dans un instant comment réaliser tout cela. Bien entendu libre à vous d'utiliser des machines physiques pour réaliser l'installation.



==== La virtualisation ====

Pour exécuter ce projet, vous pouvez utiliser un virtualiseur comme VMWARE ou VIRTUALBOX. Ceci dit, de grosses différences séparent ces deux virtualiseurs et donc vous obligeront à plus ou moins de manipulations afin d'obtenir le même résultat. Celles-ci seront expliquées au fur et à mesure de l'évolution.



==== Primary Server ====

Sous cette appellation se trouve campée la clé de voute du système informatique. La plupart des services peuvent être secondés par un Secondary Server ou Backup Server. C'est d'ailleurs préférable, mais celui-ci ne vous permettra que de gagner du temps avant une chute inévitable. C'est pourquoi il est important d'apporter un maximum de soins aux scripts d'activations des services mais également à la structure même du réseau, clients compris.

Voici les fonctionnalités assumées par le Primary Server :
  * DHCP Serveur
  * DNS Serveur
  * Time Serveur
  * SAMBA DOMAIN Controleur Serveur
  * LDAP Serveur


==== Secondary Serveur ====

Le Secondary server sera utilisé pour soulager certaines fonctions du Primary Serveur en jouant le rôle de Backup mais également en proposant des fonctions inédites dans votre réseau d'entreprise.

Voici les fonctionnalités assumées par le Secondary Serveur:
  * Backup DNS Serveur
  * ... (plus de détails à venir)

==== Les clients ====

L'aspect client sera ici traité indépendamment mais allant dans la même direction. Je m'explique, le but ici n'est pas d'offrir des fonctions différentes pour chaque famille d'OS, mais de démontrer l'hétérogénéité de Linux en tant que serveur offrant des fonctionnalités à des clients de tous horizons (sous certaines conditions).


===== L'installation du virtualiseur et sa configuration =====


==== VMWARE ====

VMWARE jouit d'une assez bonne réputation dans le monde professionnel. Longtemps avant les autres, cette entreprise a su occuper une niche dans le monde informatique en offrant la possibilité de réduire les coûts des infrastructures en entreprise dédiées aux tests et à la phase de Quality Acceptance.

=== Installation de VMWARE ===

Pour installer VMWARE Server vous pouvez modifier votre fichier /etc/apt/sources.list via l'environnement graphique //Système -&gt; Administration -&gt; Sources logicielles ...// et sélectionner logiciels de tierces parties dépôt &quot;partner&quot; puis [[:tutoriel:comment_installer_un_paquet|installez le paquet]] **vmware-server**.

[[http://www.taltan.fr/post/2007/11/01/VMware-Server-104-sur-Ubuntu-710-Gutsy-Gibbon]]

Pour plus d'information sur la création d'une machine virtuel avec vmware, vous pouvez consulter ce lien. 

[[http://www.vmware.com/support/pubs/server_pubs.html]].

Sachez juste qu'à l'heure de l'écriture de ce document une version bêta 2.0 est déjà téléchargeable et installable. Je n'en parlerai pas volontairement ici. Je me contenterai d'utiliser la version 1.4 dite stable.

=== Configuration des cartes virtuelles ===

Voilà une chose intéressante. VMWARE permet la configuration du subnet utilisé par chacune de ces cartes via une application en ligne de commande. Sous Windows cette opération est réalisée via un onglet dans le paramétrage de l'application. Pour quoi VMWARE n'a pas réédité la même logique, ... Bon retroussons nos manches et allons-y.

  sudo vmware-config-network.pl

&lt;note important&gt;toutes les questions qui vous seront posées peuvent soit être validée par défaut &quot;la valeur entre []&quot; avec la touche ENTER, soit par une nouvelle valeur. Si vous devez répondre spécifiquement à une de ces questions, je vous l'indiquerai&lt;/note&gt;

  Making sure services for VMware Server are stopped.
  
  Stopping VMware services:
   Virtual machine monitor                                             done
   Bridged networking on /dev/vmnet0                                   done
   DHCP server on /dev/vmnet1                                          done
   Host-only networking on /dev/vmnet1                                 done
   DHCP server on /dev/vmnet8                                          done
   NAT service on /dev/vmnet8                                          done
   Host-only networking on /dev/vmnet8                                 done
   Virtual ethernet                                                    done
  
  You have already setup networking.
  
  Would you like to skip networking setup and keep your old settings as they are?(yes/no) [yes] no
  
  Do you want networking for your virtual machines? (yes/no/help) [yes] 
  
  Would you prefer to modify your existing networking configuration using the 
  wizard or the editor? (wizard/editor/help) [wizard] 
  
  The following bridged networks have been defined:
  
  . vmnet0 is bridged to eth0
  
  Do you wish to configure another bridged network? (yes/no) [no] no
  
  Do you want to be able to use NAT networking in your virtual machines? (yes/no)[yes] yes
  
  Configuring a NAT network for vmnet8.
  
  The NAT network is currently configured to use the private subnet 172.16.179.0/255.255.255.0.  Do you want to keep these settings? [yes] no  
  
  Do you want this program to probe for an unused private subnet? (yes/no/help) [yes] no
  
  What will be the IP address of your host on the private network? 192.168.254.0
  
  What will be the netmask of your private network? 255.255.255.0
  
  The following NAT networks have been defined:
  
  . vmnet8 is a NAT network on private subnet 192.168.254.0.
  
  Do you wish to configure another NAT network? (yes/no) [no] no
  
  Do you want to be able to use host-only networking in your virtual machines? [yes] yes
  
  Configuring a host-only network for vmnet1.
  
  The host-only network is currently configured to use the private subnet 
  172.16.30.0/255.255.255.0.
  Do you want to keep these settings? [yes] no
  
  Do you want this program to probe for an unused private subnet? (yes/no/help)   [yes] no
  
  What will be the IP address of your host on the private network? 192.168.2.0
  
  What will be the netmask of your private network? 255.255.255.0
  
  The following host-only networks have been defined:
  
  . vmnet1 is a host-only network on private subnet 192.168.2.0.
  
  Do you wish to configure another host-only network? (yes/no) [no] yes
  
  Configuring a host-only network for vmnet2.
  
  Do you want this program to probe for an unused private subnet? (yes/no/help) [yes] no
  
  What will be the IP address of your host on the private network? 192.168.3.0
  
  What will be the netmask of your private network? 255.255.255.0
  
  The following host-only networks have been defined:
  
  . vmnet1 is a host-only network on private subnet 192.168.2.0.
  . vmnet2 is a host-only network on private subnet 192.168.3.0.
  
  Do you wish to configure another host-only network? (yes/no) [no] no
  
  Generating SSL Server Certificate
  
  Starting VMware services:
   Virtual machine monitor                                             done
   Virtual ethernet                                                    done
   Bridged networking on /dev/vmnet0                                   done
   Host-only networking on /dev/vmnet1 (background)                    done
   Host-only networking on /dev/vmnet2 (background)                    done
   Host-only networking on /dev/vmnet8 (background)                    done
   NAT service on /dev/vmnet8                                          done
   Starting VMware virtual machines...                                 done
  

Bien, vous voici en possession de deux nouvelles interfaces réseau virtuelles qui correspondent sur notre schéma d'implantation à VSWITCH-1 et VSWITCH-2.
A ce stade vous pouvez créer votre machine virtuelle et ne connecter pour le moment qu'une seule carte réseau &quot;eth0&quot; qui sera connectée via un bridge &quot;VMNET8&quot; entre VMWARE et votre réseau local. Cela permettra de voir votre machine directement au travers de votre réseau comme s'il s'agissait d'une machine physique connectée à votre subnet.

{{tutoriel:vmware-config-01.png?640}}




==== VirtualBox ====

Suivez ce lien (du même auteur =)) [[tutoriel:network_tpme_virtualbox]]

Plusieurs différences majeures sont à signaler entre les virtualiser VirtualBox et VMWare.

  * Virtualbox:
    * Version OSE et non OSE :
      * La version non OSE : contient des pilotes pour l'USB2 et la possibilité d'utiliser RDP pour prendre le contrôle à distance de la machine virtuel. Cette version est payante pour une utilisation en entreprise.
      * La version OSE : open source, gratuite et supportée par Ubuntu dans les dépôts offciels. Elle peut-être utilisée en entreprise en toute gratuité.
    * Un gros défaut, il est obligatoire de démarrer les machines virtuels dans un GUI alors que VMWARE serveur permet le démarrage des machines virtuels en mode service.

&lt;note important&gt;C'est une erreur, VirtualBox n'a pas forcément besoin d'une GUI : &quot;VBoxHeadless -startvm toto&quot; lance une vm qui attend une connexion rdesktop ...&lt;/note&gt;

  * VMWare Serveur :
    * La version 1.04 : disponible gratuitement, elle intègre une interface web (téléchargeable) l'USB, l'utilisation des cartes physique scsi si çà vous intéresse (vieux scanner ...) est gratuite en entreprise. Il est possible de démarrer automatiquement au logon de la machine host une ou plusieurs machines virtuelles et de les éteindres proprement au logoff.
    * La version 2.0 bêta 1 : ne dispose plus d'une interface GTK mais uniquement d'une interface web (très lente), :!: vous oblige à travailler en root :!: et est normalement plus rapide ... 


===== Installation d'Ubuntu Server 7.10 =====
Démarrez votre machine virtuelle en ayant prit soins de modifier la configuration du cd-rom afin qu'il utilise soit un disque gravé contenant l'image de Ubuntu Server 7.10, soit de pointer directement sur l'image iso de l'Ubuntu Server 7.10

{{tutoriel:vmware-ubuntu-serv-01.png|}}

  F2 -&gt; Français
  F3 -&gt; Belgium ou Français en fonction du votre
  F4 -&gt; 1024 * 768

&lt;note tip&gt;Vous pouvez à tout moment de l'installation voir la progression détaillée en utilisant la combinaison de touche ALT+F4 et pour revenir à l'écran normal d'installation la combinaison ALT+F1&lt;/note&gt;

  Nom de la machine -&gt; primary
  Méthode de partitionnement -&gt; Assistée - Utiliser le disque entier
  Configurer l'horloge -&gt; UTC
  Nom complet du nouvel utilisateur -&gt; [votre choix]
  Identifiant de votre compte utilisateur -&gt; [votre choix]
  Mot de passe pour le nouvel utilisateur -&gt; [votre choix]
  Confirmation du mot de passe -&gt; [votre choix]
  N'installer aucun des serveurs proposés par l'installateur, nous le ferons plus tard.











===== Configuration post installation =====
- Activation du compte root
  sudo passwd root

&lt;note warning&gt; Activer le compte root est dangereux il est plus prudent d'utiliser &quot;sudo&quot; pour lancer les commandes root, si vous souhaiter activer le compte root pensez a lui interdire le login par ssh ( &quot;sudo nano /etc/ssh/sshd_config&quot;  et modifier la ligne &quot;permitrootlogin yes&quot; en &quot;permitrootlogin no&quot;) comme ca vous pourrez vous connecter en root avec la commande &quot;sudo login root&quot; une fois que vous êtes connecté comme utilisateur &lt;/note&gt;


Editez le fichier &quot;/etc/network/interfaces&quot; section [eth0] (laisser la section loopback)
  auto eth0
  iface eth0 inet static
  address 192.168.254.10
  netmask 255.255.255.0
  network 192.168.254.0
  broadcast 192.168.254.255
  gateway 192.168.254.2 


Redémarrez la machine
  sudo reboot

&lt;note tip&gt;un sudo /etc/init.d/networking restart suffit&lt;/note&gt;

&lt;note important&gt;Après le redémarrage, utilisez toujours le compte root pour exécuter les différentes marches à suivre, sauf si cela est contre indiqué.&lt;/note&gt;

&lt;note warning&gt; Utiliser le compte root est dangereux préférez utiliser &quot;sudo&quot; pour lancer vos commandes root&lt;/note&gt;

Vérifier la connexion réseau
  ifconfig
  ping 192.168.254.10
  ping www.google.com

- Copie du fichier .bash_logout (Inutile si vous n'avez pas activer le compte root)
  cp /home/[default user]/.bash_logout /root/

- Modification du fichier sources.list (gardez juste la référence au cd-rom d'installation et placez la en commentaire, le reste, vous pouvez le supprimer)
  deb http://archive.ubuntu.com/ubuntu/ gutsy main restricted
  deb http://security.ubuntu.com/ubuntu/ gutsy-security main restricted
  deb http://archive.ubuntu.com/ubuntu/ gutsy-updates main restricted
  
  deb http://archive.ubuntu.com/ubuntu/ gutsy universe multiverse
  deb http://security.ubuntu.com/ubuntu/ gutsy-security universe multiverse
  deb http://archive.ubuntu.com/ubuntu/ gutsy-updates universe multiverse

- Upgrade de la distribution
  apt-get update
  apt-get dist-upgrade

-  Installation de quelques applications supplémentaires pour l'administration
  apt-get install sysvconfig mc build-essential linux-headers-$(uname -r)

- Activation de la couleur dans le terminal
  cd /root/
  Editez le fichier /root/.bashrc, cherchez la ligne &quot;PS1=.....&quot; et dé-commentez la.
  Relancer le script &quot;. .bashrc&quot;

- Configuration de GRUB
  Editez le fichier /boot/grub/menu.lst
  Cherchez la ligne &quot;kernel&quot; du premier module de démarrage et supprimez l'option &quot;quiet&quot;
  Commentez la ligne hiddenmenu
  Redémarrez la machine

&lt;note warning&gt;Pour des raisons de stabilité, les pilotes framebuffer ont été black listé. Donc, n'ajoutez pas de ligne vga=xxx dans votre menu.lst car vous auriez un superbe écran noir au démarrage de votre serveur. Voir le fichier /etc/modprobe.d/blacklist-framebuffer&lt;/note&gt;

===== Installation des VMWARE tools =====
Activez l'installation des vmware-tools dans le menu VM -&gt; Install VMWARE tools du menu de VMWARE Server
- Monter le cd-rom
  mount /media/cdrom0

- Créez un répertoire d'installation
  mkdir /root/vmware-tools

- Copiez le fichier tar.gz
  cp /media/cdrom/VMwareTools*.tar.gz /root/vmware-tools

- Installation des VMware tools
  cd /root/vmware-tools
  tar xvzf VMwareTools*.tar.gz
  cd vmware-tools-distrib
  ./vmware-install.pl
  Répondez aux questions par la valeur par défaut entre []
  reboot







===== Installation du VSWITCH-1 =====
  * Arrêtez le serveur et éditez sa configuration.
  * Ajoutez une nouvelle carte réseau et connectez la sur VMNET2.
  * Démarrez le serveur.

Editez le fichier &quot;/etc/network/interfaces&quot; section [eth1]
  auto eth1
  iface eth1 inet static
  address 192.168.2.1
  netmask 255.255.255.0
  network 192.168.2.0
  broadcast 192.168.2.255
  gateway 192.168.254.10

Editez le fichier /etc/resolv.conf et ajustez son contenu si nécessaire
  search yourdomain.local
  nameserver 192.168.2.1
  nameserver 192.168.254.2

Relancez le service &quot;networking&quot;
  service networking restart

Vérifiez la connexion réseau
  ifconfig
  ping 192.168.254.10
  ping www.google.be



===== Transformez le primary server en routeur  =====

Editez le fichier /etc/rc.local et ajoutez ces lignes afin d'activer le [[http://fr.wikipedia.org/wiki/Network_address_translation|NATing]]

  echo 1 &gt;/proc/sys/net/ipv4/ip_forward
  iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

Redémarrez le serveur et vérifiez la route

  iptables -t nat -L

  Chain PREROUTING (policy ACCEPT)
  target     prot opt source             destination
  
  Chain POSTROUTING (policy ACCEPT)
  target     prot opt source             destination
  MASQUERADE  0    --  anywhere           anywhere
  
  Chain OUTPUT (policy ACCEPT)
  target     prot opt source             destination



===== Création d'un serveur DNS =====

Une bonne documentation explicative sur Bind c'est par ici [[:bind9]]

Installation de bind9

  apt-get install bind9

[[:tutoriel:comment_editer_un_fichier|Editez le fichier]] **/etc/bind/named.conf**.

  zone &quot;.&quot; {
    type hint;
    file &quot;/etc/bind/db.root&quot;;
  };
    
  zone &quot;localhost&quot; IN {
    type master;
    file &quot;/etc/bind/db.local&quot;;
    allow-update { none; };
  };
  
  zone &quot;127.in-addr.arpa&quot; IN {
    type master;
    file &quot;/etc/bind/db.127&quot;;
    allow-update { none; };
  };
  
  zone &quot;0.in-addr.arpa&quot; IN {
    type master;
    file &quot;/etc/bind/db.0&quot;;
    allow-update { none; };
  };
  
  zone &quot;255.in-addr.arpa&quot; IN {
    type master;
    file &quot;/etc/bind/db.255&quot;;
    allow-update { none; };
  };
  
  include &quot;/etc/bind/named.conf.local&quot;;

- Editez le fichier /etc/bind/named.conf.local

  zone &quot;yourdomain.local&quot; IN {
    type master;
    file &quot;/var/cache/bind/db.yourdomain.local&quot;;
    allow-update { none; };
  };
  
  zone &quot;2.168.192.in-addr.arpa&quot; IN {
    type master;
    file &quot;/var/cache/bind/rev.yourdomain.local&quot;;
    allow-update { none; };
  };

- Créez le fichier /var/cache/bind/db.yourdomain.local
  $TTL 86400
  @  IN  SOA primary.yourdomain.local.  root.yourdomain.local. (
      2008012701
      1w
      1d
      4w
      1w )
  @  IN  NS  primary.yourdomain.local.
  primary  IN A 192.168.2.1


- Créez le fichier /var/cache/bind/rev.yourdomain.local
  $TTL 86400
  @  IN  SOA primary.yourdomain.local.  root.yourdomain.local. (
      2008012701
      1w
      1d
      4w
      1w )
  @  IN  NS  primary.yourdomain.local.
  1  IN  PTR primary.yourdomain.local.

- Changez le group d'appartenance pour les fichiers
  chgrp bind /var/cache/bind/*

- Editez le fichier /etc/hosts
  127.0.0.1 localhost
  192.168.2.1 primary.yourdomain.local
  
  définition loopback IPV6 à garder
  ...
  ..
  .

- Modifiez le fichier /etc/resolv.conf
  search yourdomain.local
  nameserver 192.168.2.1
  nameserver 192.168.254.10

- Editez le fichier /etc/bind/named.conf.options
  options {
           directory &quot;/var/cache/bind&quot;;
           forward only;
           forwarders { 192.168.254.2; };
           auth-nxdomain no;
           allow-recursion { localnets; };
  };

- Editez le fichier /etc/default/bind9
  RESOLVCONF=yes

- Reboot


==== Vérification de la configuration ====
- Vérifiez les fichiers de configuration
  named-checkconf (si ok rien n'est retourné)
  cd /var/cache/bind/
  named-checkzone -d yourdomain.local db.yourdomain.local
  named-checkzone -d 192.168.2.1 rev.yourdomain.local 
 

- Démarrez une seconde console ALT+F2 et tapez
  tail -f /var/log/syslog

- Revenez sur la première console et redémarrez le service bind9
  service bind9 restart

- Passez sur la seconde console et analysez les messages d'erreur s'il y en a.

- Si tout est OK passez sur la première console
  ping primary.yourdomain.local
  Cela devrait vous retourner l'adresse 192.168.2.1

- Si il y a une erreur, re-vérifiez les log du système, les scripts, ...






===== Création d'un serveur DHCP =====

Une bonne documentation explicative sur dhcp3-server c'est par ici [[:dhcp3-server]]

- Installation de dhcp3-server
  apt-get install dhcp3-server
  Cela installera le paquet et le configurera, mais génèrera également une erreur à l'activation. C'est normal nous allons corriger cela.

- Editez le fichier /etc/dhcp3/dhcpd.conf
  ddns-update-style none;
  option domain-name &quot;yourdomain.local&quot;;
  option domain-name-servers 192.168.2.1;
  default-lease-time 600;
  max-lease-time 7200;
  log-facility local7;
  
  subnet 192.168.2.0 netmask 255.255.255.0 {
    option routers 192.168.2.1;
    option subnet-mask 255.255.255.0;
    range 192.168.2.150 192.168.2.200;
  }

- Editez le fichier /etc/syslog.conf et ajoutez la ligne suivante sous les autres du même type
  local7.*       -/var/log/dhcp.log

- Relancez le service &quot;sysklogd&quot;
  service sysklogd restart
  Cela affichera une erreur d'accès au fichier dhcpd.log. C'est normal


==== Vérification de la configuration ====
Vous pouvez connecter une machine virtuelle, un Windows 2000 par exemple (plus rapide que XP et moins gourmand). La carte réseau de cette machine virtuelle doit être connectée sur VMNET2. Configurez cette machine virtuelle pour accepter le DHCP et dans une console tapez &quot;ipconfig&quot;. Normalement vous devriez recevoir une adresse IP entre 192.168.2.150 et 192.168.2.200

Vérifiez le DNS par la même occasion en faisant un ping primary.yourdomain.local

Vérifiez pour finir le routage pour l'extérieur avec un ping www.google.be


===== Inscription DHCP et DNS dynamique =====
- Editez le fichier /etc/bind/named.conf.local et remplacez les lignes:
  allow-update { none; }; -&gt; allow-update { 127.0.0.1; };

- Editez le fichier /etc/dhcp3/dhcpd.conf et ajoutez ou modifiez ces quelques lignes au début du fichier.

  ddns-update-style interim;
  ddns-updates on;
  ignore client-updates;
  update-static-leases on;
  allow-unknow-clients;

- Ajoutez ces lignes à la fin du même fichier

  zone yourdomain.local. { primary 127.0.0.1; }
  zone 2.168.192.in-addr.arpa. { primary 127.0.0.1; }


==== Vérification de la configuration ====
- Redémarrez les services DHCP et DNS
  service bind9 restart
  service dhcp3-server restart

- Sur le client Windows 2000
  ipconfig /release
  ipconfig /renew
  
  ping www.google.be

- Sur primary serveur vérifiez la présence des fichiers:
  /var/cache/bind/db.yourdomain.local.jnl
  /var/cache/bind/rev.yourdomain.local.jnl








==== Un client Linux ====
- Editez le fichier du client linux /etc/dhcp3/dhclient.conf et ajoutez cette ligne.
  send host-name &quot;[client name]&quot;;

&lt;note tip&gt;Il est bon de ne pas s'énerver si une résolution de nom avec ping sur primary ou www.google.be ne fonctionne pas. La première chose à faire est de connecter une console sur primary et d'utiliser la commande &quot;tail -f /var/log/syslog&quot; afin de voir les messages d'erreurs et les messages d'inscriptions. Il existe également des outils pour vérifier le bon fonctionnement d'un DNS et d'un DHCP &quot;host -v primary.yourdomain.local&quot; et &quot;dig SOA yourdomain.local&quot;. Pour plus d'information sur ces commandes, Google est ton ami&lt;/note&gt;

&lt;note important&gt;Le nom du client doit être unique dans votre réseau, sinon vous aurez des conflits DNS&lt;/note&gt;

&lt;note warning&gt;A ce stade, vous devriez pouvoir accéder au monde extérieur au départ de n'importe quelle machine de votre réseau. Vous devriez pouvoir utiliser la dénomination unique de chacune de vos machine pour résoudre une adresse servie par DNS &quot;ping primary, ping [client name], ...&quot; Si tel n'est pas le cas, il y a probablement une explication dans les logs serveur ou client. Bon débugging&lt;/note&gt;



===== Limiter le champ d'action du DNS au réseau local =====
Pour que votre DNS ne résolve que les adresses local à yourdomain.local vous devez encore réaliser ces quelques modifications

Éditez le fichier /etc/resolv.conf et supprimez la ligne de référence à l'adresse menant à l'extérieur. Vous ne devriez plus avoir que deux lignes dans votre fichier.
  search yourdomain.local
  nameserver 192.168.2.1

Editez le fichier /etc/bind/named.conf et commentez toutes les lignes de la zone « . » attention, les commentaires sont précédés de « %%//%% » et non de « # ».

Editez le fichier /etc/bind/named.conf.options et adaptez le en fonction.

  options {
           directory &quot;var/cache/bind&quot;;
           forward only;
           forwarders { 192.168.254.2; };
           auth-nxdomain no;
           allow-recursion { localnets; };
  };

Editez enfin le fichier /etc/default/bind9
  RESOLVCONF = no


===== Création d'un time serveur NTP =====
Pour vérifiez l'heure UTC actuelle en Belgique, vous pouvez vous rendre à cette adresse [[http://www.pool.ntp.org/zone/be]] Redémarrez votre serveur et modifiez si nécessaire l'heure incluse dans le bios de votre vmware.

- Editez le fichier /etc/default/rcS
  UTC=yes

- Installez les applications suivantes
  apt-get install ntp


==== Configuration du serveur NTP ====
- Editez le fichier /etc/ntp.conf
  
  driftfile /var/lib/ntp/drift
  
  statsdir /var/log/ntpstats/
  statistics loopstats peerstats clockstats
  filegen loopstats file loopstats type day enable
  filegen peerstats file peerstats type day enable
  filegen clockstats file clockstats type day enable
  
  #Pour la Belgique
  server be.pool.ntp.org
  server 3.be.pool.ntp.org
  server 3.europe.pool.ntp.org
  server 0.europe.pool.ntp.org
  server ntp.ubuntu.com
  # Synchronize on local clock
  server 127.127.1.0
  fudge 127.127.0 stratum 10
  
  restrict -4 default kod notrap nomodify nopeer noquery
  restrict -6 default kod notrap nomodify nopeer noquery
  restrict 127.0.0.1
  restrict ::1
  
  restrict 192.168.2.0 mask 255.255.255.0 nomodify notrap

&lt;note tip&gt;Vous trouverez plus d'informations à cette adresse http://www.pool.ntp.org/zone/be&lt;/note&gt;


- Editer /etc/init.d/ntp et chercher la ligne
  PIDFILE=/var/run/ntpd.pid
- Ajouter à la suite la ligne
  LOGFILE=/var/log/ntp.log
- Chercher la ligne
  start-stop-daemon --start --quiet --oknodo --pidfile $PIDFILE --startas $DAEMON -- -p $PIDFILE $NTPD_OPTS
- Remplacer-la par
  start-stop-daemon --start --quiet --oknodo --pidfile $PIDFILE --startas $DAEMON -- -p $PIDFILE -l $LOGFILE $NTPD_OPTS
  

- Stoppez le service
  service ntp stop

- Editez le fichier /etc/default/ntpdate et modifiez le
  NTPSERVERS =&quot;3.be.pool.ntp.org&quot;

- Pour vérifier une bonne synchronisation, vous pouvez exécuter cette commande.
  ntpdate -dv 3.be.pool.ntp.org
  La sortie est relativement longue

- Relancez le serveur NTP
  service ntp start

==== Client linux ====
- Editez le fichier /etc/default/ntpdate
  NTPSERVERS=&quot;192.168.2.1&quot;


==== Client Windows ====
- Pour WinXP la gestion de l'heure possède un onglet Temps Internet ou vous pouvez renseigner l'adresse 192.168.2.1

- Pour Win2K, il a le service Windows Time.
  Changez le mode de démarrage du service sur auto
  
  Dans une console:
  net time /setsntp:192.168.2.1
  net stop w32time
  net start w32time




























===== Création du serveur LDAP =====

- Installation du serveur LDAP et de quelques outils
  apt-get install slapd db4.2-util ldap-utils
- Répondez aux questions ncursus avec le password de root
- Reconfigurez slapd avec dpkg-reconfigure
  dpkg-reconfigure slapd

  Le nom du domaine : yourdomain.local 
  Nom de votre organisation: yourdomain
  Mot de passe de l'administrateur : [root password]
  Module de base de données à utiliser : BDB
  Faut-il supprimer la base de données à la purge du paquet ? NON
  Faut-il déplacer l'ancienne base de données ? NON
  Faut-il autoriser le protocole LDAPv2 ? NON 
- Installez les schema LDAP inclus dans un paquet samba
  aptitude install samba-doc
- Décompression et copie dans la bonne directory
  gunzip -c /usr/share/doc/samba-doc/examples/LDAP/samba.schema.gz &gt; /etc/ldap/schema/samba.schema
- Dans une seconde console, cryptez le password de l'administrateur avec la commande slappasswd
  slappasswd
  New password: 
  Re-enter new password: 
  {SSHA} ............
- Éditez le fichier /etc/ldap/slapd.conf 
  ajoutez cette ligne en dessous des autres include:
  include         /etc/ldap/schema/samba.schema
  
  cherchez la ligne rootdn et supprimez le #
  ajoutez juste en dessous de rootdn la ligne suivante
  rootpw          {SSHA} ..........

- Redémarrez le serveur LDAP. Normalement cela doit aller très rapidement:
  invoke-rc.d slapd restart
 Si vous trouvez une erreur vous pouvez en connaître les causes en utilisant la commande suivante.
  slapd -d 16383

=== Interpid Ibex (8.04) et superieur ===

d'après la doc : [[http://doc.ubuntu-fr.org/slapd]] ça à un peu changé. on n'utilise plus de fichier /etc/ldap/slapd.conf
En suivant le document [[https://help.ubuntu.com/8.10/serverguide/C/openldap-server.html]], je propose la methode suivante

- Installation du serveur LDAP et de quelques outils
  apt-get install slapd db4.2-util ldap-utils
- Répondez aux questions ncursus avec le password de root
- Reconfigurez slapd avec dpkg-reconfigure
  dpkg-reconfigure slapd

  Le nom du domaine : yourdomain.local 
  Nom de votre organisation: yourdomain
  Mot de passe de l'administrateur : [root password]
  Module de base de données à utiliser : HDB
  Faut-il supprimer la base de données à la purge du paquet ? NON
  Faut-il déplacer l'ancienne base de données ? NON
  Faut-il autoriser le protocole LDAPv2 ? NON 
- Installez les schemas LDAP inclus dans un paquet samba
  aptitude install samba-doc
- Décompression et copie dans la bonne directory
  gunzip -c /usr/share/doc/samba-doc/examples/LDAP/samba.schema.gz &gt; /etc/ldap/schema/samba.schema
- Dans une seconde console, cryptez le password de l'administrateur avec la commande slappasswd
  slappasswd
  New password: 
  Re-enter new password: 
  {SSHA} ............
- créer le répertoire temporaire :
  mkdir /tmp/ldif_output
- On crèe un fichier de conversion schema_convert.conf avec les lignes :
  include /etc/ldap/schema/core.schema
  include /etc/ldap/schema/cosine.schema
  include /etc/ldap/schema/inetorgperson.schema
  include /etc/ldap/schema/nis.schema
  include /etc/ldap/schema/samba.schema
- On utilise la commande slaptest pour créer les fichiers LDIF :
slaptest -f schema_convert.conf -F /tmp/ldif_output
- On édit le fichier /tmp/ldif_output/cn\=config/cn\=schema/cn\=\{4\}samba.ldif et on modifie les lignes comme suit :
  dn: cn={4}samba
devient :
  dn: cn=samba,cn=schema,cn=config
Et :
  cn: {4}samba
devient : 
  cn: samba
- On supprime toute les dernières lignes à partir de et inclus structuralObjectClass
  structuralObjectClass: olcSchemaConfig
  entryUUID: 69111144-6367-102e-950a-c54deb20c32c
  creatorsName: cn=config
  createTimestamp: 20091111234059Z
  entryCSN: 20091111234059.910631Z#000000#000#000000
  modifiersName: cn=config
  modifyTimestamp: 20091111234059Z

- On copie le nouveau LDIF dans /etc/ldap/schema pour pouvoir l'avoir sous la main en cas de besoin
  cp /tmp/ldif_output/cn\=config/cn\=schema/cn\=\{4\}samba.ldif /etc/ldap/schema/samba.ldif
- On applique cette modification à la base LDAP
  ldapadd -x -D cn=admin,cn=config -W -f /etc/ldap/schema/samba.ldif
- On fait le nettoyage :
  rm -rf /tmp/ldif_output
- On Relance le serveur LDAP par acquis de conscience (normalement c'est dynamique) :
  invoke-rc.d slapd restart













===== Création du serveur SAMBA =====
- Installation du serveur SAMBA
  aptitude install samba smbclient smbfs
- Éditez le fichier /etc/samba/smb.conf et supprimez l'intégralitée du contenu du fichier
  #======================= Global Settings =======================
  
  [global]
  
  workgroup = &lt;Your DOMAIN name&gt;
  netbios name = primary
  server string = Samba-LDAP PDC Server
  domain master = Yes
  local master = Yes
  domain logons = Yes
  os level = 40
  #passwd program = /usr/sbin/smbldap-passwd ?u %u
  ldap passwd sync = Yes
  passdb backend = ldapsam:ldap://127.0.0.1/
  ldap admin dn = cn=admin,dc=yourdomain,dc=local
  ldap suffix = dc=yourdomain,dc=local
  ldap group suffix = ou=Groups
  ldap user suffix = ou=Users
  ldap machine suffix = ou=Machines
  add user script = /usr/sbin/smbldap-useradd -m &quot;%u&quot;
  ldap delete dn = Yes
  delete user script = /usr/sbin/smbldap-userdel &quot;%u&quot;
  add machine script = /usr/sbin/smbldap-useradd -w &quot;%u&quot;
  add group script = /usr/sbin/smbldap-groupadd -p &quot;%g&quot;
  #delete group script = /usr/sbin/smbldap-groupdel &quot;%g&quot;
  add user to group script = /usr/sbin/smbldap-groupmod -m &quot;%u&quot; &quot;%g&quot;
  delete user from group script = /usr/sbin/smbldap-groupmod -x &quot;%u&quot; &quot;%g&quot;
  set primary group script = /usr/sbin/smbldap-usermod -g &quot;%g&quot; &quot;%u&quot;
  logon path = \\%L\profile\%U
  logon drive = H:
  logon home = \\%L\%U
  socket options = TCP_NODELAY SO_RCVBUF=8192 SO_SNDBUF=8192
  case sensitive = No
  default case = lower
  preserve case = yes
  short preserve case = Yes
  #character set = iso8859-1
  #domain admin group = @admin
  dns proxy = No
  wins support = Yes
  hosts allow = 192.168.2. 127.
  ### A changer 192.168.2  
  winbind use default domain = Yes
  nt acl support = Yes
  msdfs root = Yes
  hide files = /desktop.ini/ntuser.ini/NTUSER.*/
  ### FIN DE LA PARTIE GLOBALE #####
  
  #======================= Share Settings =======================
  [netlogon]
  path = /home/netlogon
  writable = No
  browseable = No
  write list = Administrateur
  
  [profile]
  path = /home/export/profile
  browseable = No
  writeable = Yes
  profile acls = yes
  create mask = 0700
  directory mask = 0700
  
  [homes]
  comment = Repertoire Personnel
  browseable = No
  writeable = Yes
  
  [partage]
  comment = Repertoire commun
  browseable = Yes
  writeable = Yes
  public = No
  path = /home/partage
  
&lt;note 8.04&gt; en Interpid Ibex (8.04) et supérieur, il faut rajouter la ligne ldap ssl = off dans la section global. C'est moins sécurisé mais plus simple a mettre en œuvre. Si on veux plus de sécurité il faut mettre en place TLS avec le paramètre ldap ssl = tls, générer des certificats et modifier le ldap (cf https://help.ubuntu.com/8.10/serverguide/C/openldap-server.html)&lt;/note&gt;

==== Création des partages SAMBA ====
Le fichier smb.conf défini quelques share SAMBA
  /home/netlogon 
  Contient les éventuels scripts qui sont exécutés à chaque connexion d'un utilisateur (.bat)

  /home/export/profile 
  Contient les profils windows de chaque utilisateur, ils sont créés automatiquement pour les nouveaux

  /home/partage 
  Partage commun à tous les utilisateurs du domaine

  /home/lenomdelutilisateur 
  Les répertoires personnels linux sont aussi partagés

- Créez les répertoires
  mkdir -p /home/netlogon
  mkdir -p /home/export/profile
  mkdir -p /home/partage 

- Installez les sécuritées
  chmod a+w /home/export
  chmod a+w /home/export/profile
  chmod a+w /home/partage





===== Liaison SAMBA et LDAP =====
- Installez les smbldap-tools
  apt-get install smbldap-tools

- Créez le fichier /etc/smbldap-tools/smbldap_bind.conf et copiez / modifiez ces lignes
  slaveDN=&quot;cn=admin,dc=yourdomain,dc=local&quot;
  slavePw=[votre mot de passe en clair]
  masterDN=&quot;cn=admin,dc=yourdomain,dc=local&quot;
  masterPw=[votre mot de passe en clair]
- Votre mot de passe étant en clair dans le fichier, il faut modifier la sécurité
  chmod 600 /etc/smbldap-tools/smbldap_bind.conf
- Créez le fichier /etc/smbldap-tools/smbldap.conf et copiez / modifiez ces lignes
  slaveLDAP=&quot;127.0.0.1&quot;
  slavePort=&quot;389&quot;
  masterLDAP=&quot;127.0.0.1&quot;
  masterPort=&quot;389&quot;
  ldapTLS=&quot;0&quot;
  verify=&quot;require&quot;
  suffix=&quot;dc=youdomaine,dc=local&quot; 
  ### A changer : yourdomain
  usersdn=&quot;ou=Users,${suffix}&quot;
  computersdn=&quot;ou=Machines,${suffix}&quot;
  groupsdn=&quot;ou=Groups,${suffix}&quot;
  idmapdn=&quot;ou=Idmap,${suffix}&quot;
  # sambaUnixIdPooldn=&quot;cn=NextFreeUnixId,${suffix}&quot;
  sambaUnixIdPooldn=&quot;sambaDomainName=YOUR_DOMAIN,${suffix}&quot; 
  ### A changer : yourdomain
  scope=&quot;sub&quot;
  hash_encrypt=&quot;SSHA&quot;
  crypt_salt_format=&quot;%s&quot;
  
  userLoginShell=&quot;/bin/bash&quot;
  userHome=&quot;/home/%U&quot;
  userHomeDirectoryMode=&quot;700&quot;
  #Nom d'affichage - utiliser smbldap-useradd -c
  userGecos=&quot;User&quot;
  defaultUserGid=&quot;513&quot;
  defaultComputerGid=&quot;515&quot;
  skeletonDir=&quot;/etc/skel&quot;
  #Les mots de passe expirent dans 10ans
  defaultMaxPasswordAge=&quot;3650&quot;
  
  with_smbpasswd=&quot;0&quot;
  smbpasswd=&quot;/usr/bin/smbpasswd&quot;
  
  with_slappasswd=&quot;0&quot;
  slappasswd=&quot;/usr/sbin/slappasswd&quot;
- Stopez le serveur SAMBA
  service samba stop
- Ajoutez dans SAMBA le mot de passe de l'administrateur [root]
  smbpasswd -w votremotdepasseroot
  
  Setting stored password for &quot;cn=admin,dc=olituks,dc=local&quot; in secrets.tdb
- Redémarrez le serveur SAMBA
  service samba start




==== Vérifiez l'installation ====
- Avec la commade net getlocalsid vous allez obtenir le SID du PDC SAMBA
  net getlocalsid
  SID for domain PRIMARY is: S-1-5-21-.......

==== Peuplez le directory LDAP ====
  smbldap-populate

  smbldap-populate
  Populating LDAP directory for domain olituks (S-1-5-21-1103990800-3677365298-610989769)
  (using builtin directory structure)
  
  entry dc=olituks,dc=local already exist. 
  adding new entry: ou=Users,dc=yourdomain,dc=local
  adding new entry: ou=Groups,dc=yourdomain,dc=local
  adding new entry: ou=Machines,dc=yourdomain,dc=local
  adding new entry: ou=Idmap,dc=yourdomain,dc=local
  adding new entry: uid=root,ou=Users,dc=yourdomain,dc=local
  adding new entry: uid=nobody,ou=Users,dc=yourdomain,dc=local
  adding new entry: cn=Domain Admins,ou=Groups,dc=yourdomain,dc=local
  adding new entry: cn=Domain Users,ou=Groups,dc=yourdomain,dc=local
  adding new entry: cn=Domain Guests,ou=Groups,dc=yourdomain,dc=local
  adding new entry: cn=Domain Computers,ou=Groups,dc=yourdomain,dc=local
  adding new entry: cn=Administrators,ou=Groups,dc=yourdomain,dc=local
  adding new entry: cn=Account Operators,ou=Groups,dc=yourdomain,dc=local
  adding new entry: cn=Print Operators,ou=Groups,dc=yourdomain,dc=local
  adding new entry: cn=Backup Operators,ou=Groups,dc=yourdomain,dc=local
  adding new entry: cn=Replicators,ou=Groups,dc=yourdomain,dc=local
  adding new entry: cn=NextFreeUnixId,dc=yourdomain,dc=local
  
  Please provide a password for the domain root: 
  Changing UNIX and samba passwords for root
  New password: 
  Retype new password: 

Cette commande crée:
 Les différentes OU (Organisation Unit) qui contiendront vos Machines, Users et Groups
 Deux UID : root et nobody qui seront dans OU = Users
 Plusieurs CN (Common Name): Les groupes qui seront dans OU = Groups









==== Test de LDAP ====
- Création du premier utilisateur test de LDAP
  smbldap-useradd -a -c &quot;Test Test&quot; -m -P test
  Changing UNIX and samba passwords for test
  New password: 
  Retype new password:

  *  -a : désigne un utilisateur
  * -c : Information Gecos : Le nom entier
  * -m : Créé le répertoire personnel
  * -P : création du mot de passe
  Pour plus d'aide smbldap-useradd -?

- Vérifiez que les utilisateurs test et root sont bien dans LDAP
  smbldap-usershow test
  
  dn: uid=test,ou=Users,dc=yourdomain,dc=local
  objectClass: top,person,organizationalPerson,inetOrgPerson,posixAccount,shadowAccount,sambaSamAccount
  cn: test
  sn: test
  givenName: test
  uid: test
  uidNumber: 1000
  gidNumber: 513
  homeDirectory: /home/test
  loginShell: /bin/bash
  gecos: Test Test
  sambaLogonTime: 0
  sambaLogoffTime: 2147483647
  sambaKickoffTime: 2147483647
  sambaPwdCanChange: 0
  displayName: Test Test
  sambaSID: S-1-5-21-573247406-3271121105-2462534053-3000
  sambaPrimaryGroupSID: S-1-5-21-573247406-3271121105-2462534053-513
  sambaLMPassword: 01FC5A6BE7BC6929AAD3B435B51404EE
  sambaAcctFlags: [U]
  sambaNTPassword: 0CB6948805F797BF2A82807973B89537
  sambaPwdLastSet: 1203761173
  sambaPwdMustChange: 1519121173
  userPassword: {SSHA}4AxHgHKTY3axTAMx02Zu22k4jeJVbGN3

  smbldap-usershow root
  
  dn: uid=root,ou=Users,dc=olituks,dc=local
  cn: root
  sn: root
  objectClass: top,person,organizationalPerson,inetOrgPerson,sambaSamAccount,posixAccount,shadowAccount
  gidNumber: 0
  uid: root
  uidNumber: 0
  homeDirectory: /home/root
  sambaLogonTime: 0
  sambaLogoffTime: 2147483647
  sambaKickoffTime: 2147483647
  sambaPwdCanChange: 0
  sambaPrimaryGroupSID: S-1-5-21-1103990800-3677365298-610989769-512
  sambaSID: S-1-5-21-1103990800-3677365298-610989769-500
  loginShell: /bin/false
  gecos: Netbios Domain Administrator
  sambaLMPassword: 69C840086777BE8372D82CC5E4DD778E
  sambaAcctFlags: [U]
  sambaNTPassword: 98748519A0FAAEC727B0A34CA66C3358
  sambaPwdLastSet: 1202326380
  sambaPwdMustChange: 1517686380
  userPassword: {SSHA}..................














==== Modification du système d'authentification sur primary====


- Installation des paquets nécessaires
  apt-get install auth-client-config libpam-ldap libnss-ldap libpam-mount smbfs

- Répondez aux questions qui vous sont posées comme suit.
  Should debconf manage LDAP configuration?: Yes
  LDAP server Uniform Resource Identifier: ldapi://192.168.2.1/
  Distinguished name of the search base: dc=yourdomain,dc=local
  LDAP version to use: 3
  Make local root Database admin: Yes
  Does the LDAP database require login? No
  LDAP account for root: cn=admin,dc=yourdomain,dc=local
  LDAP root account password: [root password]

&lt;note tip&gt;Étant donné qu'il n'y a pas de mots de passe dans ce fichier nous   pouvons nous permettre de ne pas limiter l'accès uniquement à root et permettre ainsi à tous le monde de pouvoir voir l'annuaire&lt;/note&gt; 

- Editez le fichier /etc/ldap.conf et modifiez le
  base dc=yourdomain,dc=local
  uri ldap://192.168.2.1/
  rootbinddn cn=admin,dc=yourdomain,dc=local
  bind_policy soft
  pam_password md5

- Copiez ensuite le fichier /etc/ldap.conf dans /etc/ldap/ldap.conf
  cp /etc/ldap.conf /etc/ldap/ldap.conf

- Éditez le fichier /etc/nsswitch.conf et modifiez le comme suit.
  passwd:         compat ldap
  group:          compat ldap
  shadow:         compat ldap

&lt;note warning&gt;Il est préférable de garder une console en réserve avec un compte root activé car si ici il y a un problème, vous ne pourrez plus vous authentifier !!!!&lt;/note&gt;

- Éditez le fichier /etc/pam.d/common-pammount
  auth 		optional pam_mount.so use_first_pass
  session 	optional pam_mount.so use_first_pass

- Créez un nouveau fichier /etc/auth-client-config/profile.d/open_ldap et copiez / collez la suite.
  [open_ldap]
  nss_passwd=passwd: compat ldap
  nss_group=group: compat ldap
  nss_shadow=shadow: compat ldap
  nss_netgroup=netgroup: compat ldap
  pam_auth=auth sufficient pam_unix.so
   auth required pam_group.so use_first_pass
   auth required pam_mount.so use_first_pass
   auth required pam_ldap.so use_first_pass
  pam_account=account sufficient pam_unix.so
   account required pam_ldap.so use_first_pass
   account required pam_mount.so use_first_pass
  pam_password=password sufficient pam_unix.so nullok obscure min=4 max=8 md5
   password required pam_mount.so use_first_pass
   password required pam_ldap.so use_first_pass
  pam_session=session sufficient pam_unix.so
   session optional pam_mkhomedir.so skel=/etc/skel/
   session optional pam_mount.so use_first_pass
  
&lt;note warning&gt;Il est important pour ce fichier de garder la même ventilation que celle introduite. Si tel n'est pas le cas, vous pourriez avoir des problèmes avec la commande qui activera l'authentification LDAP pour le client.&lt;/note&gt;

- Créez un backup du fichier nsswitch.conf
  cp /etc/nsswitch.conf /etc/nsswitch.conf.bak

- Créez un backup des fichiers de configuration de pam
  cd /etc/pam.d/
  mkdir pam.d.bak
  cp * pam.d.bak/

- Activez l'authentification LDAP pour votre client
  auth-client-config -a -p open_ldap

Si tout se passe bien avec cette commande, vous devriez pouvoir au prochain reboot vous connecter avec un login LDAP et ou local.


==== Ajout du client Windows ====
- Démarrez votre client Windows 2000
  Ouvrez une session en local admin
  Clickez droit sur My Computer -&gt; Properties
  Cochez la case DOMAIN NAME et insérer YOURDOMAIN
  Introduisez le password pour root.
  Attendez d'avoir le message de bien venue.
  Redémarez.

&lt;note important&gt;Il est possible que juste après le premier démarrage de votre Windows2000 il ne vous permettent pas de vous connecter au DOMAIN. Il faut dans ce cas attendre une ou deux minutes le temps que le client retrouve ses jeunes avec le domain controleur SAMBA. Le message qui vous est indiqué, est qu'il ne trouve pas l'utilisateur ROOT.&lt;/note&gt;

- Connectez vous au logon avec le compte test que vous aviez créé lors de la configuration validation de LDAP. Cet utilisateur n'est pas connu de linux. Il se trouve configuré uniquement dans l'annulaire LDAP. Si la connexion fonctionne, c'est la preuve par 9 que tout est fonctionnel.

- Vérifiez les mapping automatique dans votre client Windows.
  Vous devriez avoir un drive P:\

- Faite un logoff du client windows et passez sur le serveur primary

- Ouvrez la directory /home/export/profile/test vous devriez avoir des fichiers windows dans ce folder qui sont en réalité les fichiers du profil utilisateur test.

- Vous trouverez également une directory test dans la root de home qui est en réalité le mapping sur la directory P:\ du windows client. Mais également la directory home d'un logon sur linux. De cette manière, vous pouvez partager vos fichiers privés (réservé à l'utilisateur test par exemple)













=== Configuration du client linux ====

&lt;note tip&gt;Le client linux à ce stade doit être capable de se connecter à la session et d'avoir une configuration réseau fournie par le DHCP / DNS. Il doit être à jour et avoir un accès au monde extérieur. Si ce n'est pas le cas, allez voir plus haut ce qu'il faut faire pour que cela fonctionne.&lt;/note&gt;

**Exécutez les même modifications du système d'authentification que celles exécutées sur le serveur PRIMARY avant d'ajouter celle-ci !**

 - Éditez le fichier /etc/pam.d/gdm et remplacez son contenu
  #%PAM-1.0
  
  auth required	pam_mount.so
  auth required	pam_group.so use_first_pass
  auth sufficient	pam_ldap.so use_first_pass
  auth required	pam_unix.so use_first_pass
  auth required	pam_env.so
  
  account sufficient pam_ldap.so
  account sufficient pam_unix.so
  
  password required pam_unix.so nullok obscure min=4 max=8 md5
  
  session required pam_unix.so
  session optional pam_mkhomedir.so skel=/etc/skel/
  session optional pam_mount.so

- Éditez le fichier /etc/pam.d/gdm-autologin et remplacez son contenu (le contenu est le même que pour le fichier précédent)
  #%PAM-1.0
  
  auth required	pam_mount.so
  auth required	pam_group.so use_first_pass
  auth sufficient	pam_ldap.so use_first_pass
  auth required	pam_unix.so use_first_pass
  auth required	pam_env.so
  
  account sufficient pam_ldap.so
  account sufficient pam_unix.so
  
  password required pam_unix.so nullok obscure min=4 max=8 md5
  
  session required pam_unix.so
  session optional pam_mkhomedir.so skel=/etc/skel/
  session optional pam_mount.so  
===== Automount des répertoires partagés sur le client linux =====
- Editez le fichier /etc/security/pam_mount.conf et à la ligne 173 ajoutez ces lignes.
  volume * smbfs 192.168.2.1 &amp; /media/&amp;' sur primary' uid=&amp;,gid=&amp;,dmask=777,fmask=777 - -
  volume * smbfs IP_MonServeur profscommun /media/profscommun' sur MonServeur' uid=&amp;,gid=&amp;,dmask=777,fmask=777 - -
  volume * smbfs IP_MonServeur classes /media/classes' sur MonServeur' uid=&amp;,gid=&amp;,dmask=777,fmask=777 - -
  volume * smbfs IP_MonServeur public /media/public' sur sur MonServeur' uid=&amp;,gid=&amp;,dmask=777,fmask=777 - -
  volume * smbfs IP_MonServeur install /media/install' sur sur MonServeur' uid=&amp;,gid=&amp;,dmask=777,fmask=777 - -


===== Utilisation de la carte son, USB, lecteur amovible, ... =====
- Editez le fichier /etc/security/group.conf et ajoutez ces lignes
&lt;code&gt;**;*;*;Al00002400;floppy,audio,cdrom,video,plugdev,scanner&lt;/code&gt;

==== Les test avant le grand saut ====
- Utilisez la commande suivante pour lister le contenu de l'annuaire LDAP
  getent passwd

Si vous voyez l'utilisateur test créé précédemment et connu uniquement de LDAP c'est gagné. Vous devriez être en mesure de vous authentifier. Si non, il y a un problème. Le mieux comme toujours est de regarder les logs et de vérifier les fichier de customisation.
- redémarrez la machine et connectez vous avec l'utilisateur test de l'annuaire LDAP.

Cela devrait vous montrer dans GDM un petit panneau indiquant la création de la directory home pour votre nouvel utilisateur et vous donnez accès après quelques échanges réseau avec le serveur au bureau linux en tant que simple utilisateur.





===== Problèmes rencontrés pendant la configuration du server et des clients =====
&lt;note important&gt;Lors de mes tests en VMWARE Serveur j'ai constaté deux phénomènes très étranges.&lt;/note&gt;
 
  * Le premier étant sur le serveur primary, un blocage régulier au démarrage de bind oblige de redémarrer le serveur une ou deux fois avant de pouvoir l'utiliser.

  * Le second c'est avec le client linux. (l'étape ou vous devriez être arrivé maintenant). UDEV m'a créé une mauvaise règle dans /etc/udev/rules.d/70-persistent-net.rules. La règle n'était pas bonne car l'adresse MAC de la carte réseau virtuel avait changé, sans doute, suite à l'installation des vmware tools. Donc, au démarrage de la machine client linux, le nom de l'interface était passé à eth2 plus tôt que eth0. J'ai modifié le fichier 70-persistent-net.rules en indiquant à eth0 que l'adresse mac avait changé et tout est rentré dans l'ordre. Ce problème-ci était important, car il m'empêchait de me connecter à LDAP serveur, de joindre les adresses extérieures tout en me permettant de me connecter dans mon subnet et donc de voir le client windows et primary via uniquement leur adresse IP ! de quoi y perdre son latin quoi ...

Là aussi, si vous avez des idées, je suis preneur.





===== Installation de Webmin sur primary =====

[[tutoriel:comment_modifier_sources_maj|Ajoutez le dépôt]] suivant à vos sources de mises à jour puis [[:tutoriel:comment_installer_un_paquet|installez le paquet]] **webmin**.

&lt;file&gt;
deb http://download.webmin.com/download/repository sarge contrib
Récuperer les cles 
sudo wget http://www.webmin.com/jcameron-key.asc
sudo apt-key add jcameron-key.asc

faire un sudo update 
aptitude install webmin
&lt;/file&gt;

----

//Contributeurs : [[utilisateurs:olituks|olituks]].//</textarea>
<div id="wiki__editbar" class="editBar">
<div id="size__ctl">
</div>
<div class="editButtons">
<div id="plugin__captcha_wrapper"><input type="hidden" name="70fd0767e20036d51294113c2bd88559" value="Wu70sYrLSqjeMqhK9FhknWxf4ojKriaTCSQdJKUesE0=" /><label for="plugin__captcha">Merci de recopier le code ci-contre pour prouver que vous êtes humain :</label> <span id="plugin__captcha_code">KR Y K I</span> <input type="text" size="5" name="7c1bcff7d09c7bb14876c0c54d43e086" class="edit" /> <label class="no">Merci de laisser ce champ vide : <input type="text" name="f43d55b62292cd75c893b080922dddad" /></label></div><input name="do[save]" type="submit" value="Enregistrer" class="button" id="edbtn__save" accesskey="s" tabindex="4" title="Enregistrer [S]" />
<input name="do[preview]" type="submit" value="Aperçu" class="button" id="edbtn__preview" accesskey="p" tabindex="5" title="Aperçu [P]" />
<input name="do[draftdel]" type="submit" value="Annuler" class="button" tabindex="6" />
</div>
<div class="summary">
<label class="nowrap" for="edit__summary"><span>Résumé</span> <input type="text" id="edit__summary" name="summary" class="edit" size="50" tabindex="2" /></label>
</div>
</div>
<div class="license">
Note : En modifiant cette page, vous acceptez que le contenu soit placé sous les termes de la licence suivante : <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" rel="license" class="urlextern">CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported</a></div>
</div></form>
</div>
<script type="text/javascript">
   var saveBtn = document.getElementById('edbtn__save');
   saveBtn.disabled = true;
   saveBtn.style.color = 'gray';
   saveBtn.style.backgroundColor = '#EEEEEE';
   saveBtn.value = 'Enregistrer (Click \'Aperçu\' first)';
</script>
        <br style="clear:both;" />
        <div id="pageinfo">
            <!--  |  | -->
            <!-- ?tpl_pageinfo()? -->
            <br />
            Le contenu de ce wiki est sous licence : <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" rel="license" target="_blank">CC BY-SA v3.0</a>
        </div> 
      </div>

      
      <div id="navigation">

        <ul>
          <li class="menu"><a href="http://www.ubuntu-fr.org" class="title" id="menu-accueil"><span>Accueil</span></a></li>
          <li class="menu" id="active">
            <a href="../index.html"  class="title" id="menu-doc"><span>Documentation</span></a>
            <ul>
              <li id="navWiki" class="cat">
                <h2>Actions</h2>
                <ul>
                  <li><a href="http://doc.ubuntu-fr.org/tutoriel/network_tpme?do=index"  class="action index" accesskey="x" rel="nofollow" title="Plan du site [X]">Plan du site</a></li>
                  <li><a href="http://doc.ubuntu-fr.org/tutoriel/network_tpme?do="  class="action show" accesskey="v" rel="nofollow" title="Afficher la page [V]">Afficher la page</a></li>
                  <li><a href="network_tpme?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]">Anciennes révisions</a></li>
                  <li></li>
                  <li><a href="network_tpme?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Derniers changements [R]">Derniers changements</a></li>
                  <li><a href="network_tpme?do=backlink"  class="action backlink" rel="nofollow" title="Liens vers cette page">Liens vers cette page</a></li>
                  <li></li>
                  <li></li>
                  <li></li>
                </ul>
              </li>
              <li id="navDivers" class="cat">
                <h2>Divers</h2>
                <ul>
                  <li><bdi><a href="../wiki/participer_wiki" class="wikilink1" title="wiki:participer_wiki">Participer à la documentation</a></bdi></li>
                  <li><bdi><a href="../documentation_hors_ligne" class="wikilink1" title="documentation_hors_ligne">Documentation hors ligne</a></bdi></li>
                  <li><a href="http://www.ubuntu-fr.org/telechargement" title="T&eacute;l&eacute;charger Ubuntu">T&eacute;l&eacute;charger Ubuntu</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="menu"><a href="http://forum.ubuntu-fr.org"  class="title" id="menu-forum"><span>Forum</span></a></li>
          <li class="menu"><a href="http://planet.ubuntu-fr.org"  class="title" id="menu-planet"><span>Planet</span></a></li>
        </ul>

      </div>
      <div id="references-ufr">
        <ul id="legal-ufr">
          <li><a href="http://www.ubuntu-fr.org/contacts">Contact</a></li>
        </ul>

        <ul id="sponsors-ufr">
          <li><a href="http://www.dokuwiki.org/dokuwiki" id="dokuwiki">Propulsé par Dokuwiki</a></li>
        </ul>
      </div>

    </div>
    <!-- $Id$ -->

    <!-- Piwik Image Tracker -->
    <!-- img src="http://piwik.infra.ubuntu-fr.org/piwik.php?idsite=2&amp;rec=1" style="border:0" alt="" /-->
    <!-- End Piwik -->

  </body>
</html>
