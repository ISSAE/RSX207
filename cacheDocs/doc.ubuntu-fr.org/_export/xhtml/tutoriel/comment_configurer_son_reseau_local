<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>tutoriel:comment_configurer_son_reseau_local</title>
<meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="date" content="2014-03-09T10:14:48+0100"/>
<meta name="keywords" content="reseau,tutoriel,dns,brouillon"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../../lib/exe/opensearch.php" title="Documentation Ubuntu Francophone"/>
<link rel="start" href="../../../index.html"/>
<link rel="contents" href="../../../tutoriel/comment_configurer_son_reseau_local?do=index" title="Plan du site"/>
<link rel="alternate" type="application/rss+xml" title="Derniers changements" href="../../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Namespace actuel" href="../../../feed.php?mode=list&amp;ns=tutoriel"/>
<link rel="alternate" type="text/html" title="HTML brut" href="comment_configurer_son_reseau_local"/>
<link rel="alternate" type="text/plain" title="Wiki balise" href="../../raw/tutoriel/comment_configurer_son_reseau_local"/>
<link rel="canonical" href="../../../tutoriel/comment_configurer_son_reseau_local"/>
<link rel="stylesheet" type="text/css" href="../../../lib/exe/css.php?t=ubuntu-2010&amp;tseed=4af22dedc19f28c99fa67afabbb173df"/>
<script type="text/javascript">/*<![CDATA[*/var NS='tutoriel';var JSINFO = {"id":"tutoriel:comment_configurer_son_reseau_local","namespace":"tutoriel"};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../../lib/exe/js.php?tseed=4af22dedc19f28c99fa67afabbb173df"></script>
</head>
<body>
<div class="dokuwiki export">
<!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table des matières</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="comment_configurer_son_reseau_local#methode_basiqueconfiguration_statique">Méthode basique : configuration statique</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="comment_configurer_son_reseau_local#fixer_l_adresse_ip_de_nos_machines">1. Fixer l&#039;adresse IP de nos machines</a></div></li>
<li class="level2"><div class="li"><a href="comment_configurer_son_reseau_local#activer_le_partage_de_connexions">2. Activer le partage de connexions</a></div></li>
<li class="level2"><div class="li"><a href="comment_configurer_son_reseau_local#renseigner_le_fichieretchosts">3. Renseigner le fichier /etc/hosts</a></div></li>
<li class="level2"><div class="li"><a href="comment_configurer_son_reseau_local#configurer_sa_resolution_dns">4. Configurer sa résolution DNS</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="comment_configurer_son_reseau_local#methode_avanceeconfiguration_dynamique_et_centralisee">Méthode avancée : Configuration dynamique et centralisée</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="comment_configurer_son_reseau_local#dnsmasq">1. dnsmasq</a></div></li>
<li class="level2"><div class="li"><a href="comment_configurer_son_reseau_local#iptables">2. iptables</a></div></li>
<li class="level2"><div class="li"><a href="comment_configurer_son_reseau_local#ajustements">3. ajustements</a></div></li>
<li class="level2"><div class="li"><a href="comment_configurer_son_reseau_local#les_autres_machines">4. les autres machines</a></div></li>
<li class="level2"><div class="li"><a href="comment_configurer_son_reseau_local#comment_ca_marche">5. Comment ça marche ?</a></div></li>
<li class="level2"><div class="li"><a href="comment_configurer_son_reseau_local#en_cas_de_probleme">6. En cas de problème</a></div></li>
<li class="level2"><div class="li"><a href="comment_configurer_son_reseau_local#version_simple_pour_se_connecter_a_une_machine_d_un_reseau">7. Version simple pour se connecter à une machine d&#039;un réseau</a></div></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->
<div class="tags"><span>
	<a href="../../../reseau" class="wikilink1" title="reseau" rel="tag">réseau</a>,
	<a href="http://doc.ubuntu-fr.org/tutoriel" class="wikilink1" title="tutoriel" rel="tag">tutoriel</a>,
	<a href="../../../dns" class="wikilink1" title="dns" rel="tag">dns</a>,
	<a href="../../../brouillon" class="wikilink1" title="brouillon" rel="tag">BROUILLON</a>
</span></div>
<hr />

<p>
<p><div class="notewarning">Cette page est plutôt complexe pour un débutant, je vous conseille plutôt d&#039;aller sur cette page: <a href="../../../partage_de_connexion_internet" class="wikilink1" title="partage_de_connexion_internet">partage de connexion internet</a>
</div></p>
</p>

<h1 class="sectionedit1" id="comment_configurer_son_reseau_local">Comment configurer son réseau local ?</h1>
<div class="level1">

<p>
<p><div class="notewarning">Cette page mériterait une réorganisation :
Doc très intéressante mais :
</p>
<ul>
<li class="level1"><div class="li"> En la lisant on hésite entre le format &quot;tutoriel pas à pas&quot; et &quot;une doc&quot;.</div>
</li>
<li class="level1"><div class="li"> Les procédures sont décrites principalement pour agir directement sur les fichiers de configuration avec Gedit (Editeur de texte), la version par interface graphique est parfois référencée mais bizarrement dans une section intitulée avancée.</div>
</li>
<li class="level1"><div class="li"> Enfin le titre de la page (Config réseau) correspond à une page qui parle d&#039;ICS (partage de connexion internet</div>
</li>
<li class="level1"><div class="li">Un réglage d&#039;ip statique apparait dans une section parlant de dynamique</div>
</li>
</ul>

<p>
A conserver mais sûrement réorganiser !
</div></p>
Cette page s&#039;adresse à ceux qui possèdent plusieurs PC Ubuntu reliés entre eux via des câbles réseau et un répétiteur (hub) ou commutateur (switch) :
</p>

<p>
<a href="../../../_detail/applications/config_rl2.png?id=tutoriel%253Acomment_configurer_son_reseau_local" class="media" title="applications:config_rl2.png"><img src="../../../_media/applications/config_rl2.png" class="mediacenter" alt="" /></a>
</p>

<p>
Si votre modem est en fait un routeur, il sera sans doute plus intéressant pour vous de raccorder ce routeur directement au switch. En effet, en choisissant de faire assurer le partage ICS à une machine de votre réseau, il faut bien comprendre que cette machine devra être démarrée avant toutes les autres pour que ça fonctionne, et qu&#039;elle devra rester allumée pour que tout fonctionne bien (1ere allumée, dernière éteinte).
</p>

<p>
Par contre, si vous n&#039;avez pas de routeur, si vous avez une vieille machine que vous voulez dédier à cette fonction, si vous voulez contrôler d&#039;un peu plus près le trafic vers internet, ou mettre en place des fonctions avancées, cette documentation est faite pour vous. 
</p>

<p>
Cette page documente donc les façons de mettre en place la fonction ICS (Internet Connection Sharing = Partage de Connexion Internet) sur une des machines du réseau, qu&#039;elle soit dédiée au rôle de serveur, ou qu&#039;elle soit le PC d&#039;un utilisateur.
Dans les deux cas de figure, j’appellerai cette machine <em class="u">le serveur ICS</em>, même si c&#039;est un poste de travail utilisateur.
</p>

<p>
De plus, elle permettra de &quot;tutoyer&quot; les machines du réseau en les appelant par leur nom au lieu de les appeler par leurs adresses IP.
</p>

<p>
Ce guide part du principe que la connexion internet arrive via la carte réseau identifiée eth1. C&#039;est le genre de connexion qu&#039;on met en place quand on dispose d&#039;une freebox ou d&#039;un sagem 908 qu&#039;on raccorde à notre PC ICS avec un câble réseau RJ45.
Si vous vous connectez en ppp vers internet, alors il y a de grandes chances que votre liaison s&#039;appelle  ppp0 au lieu de eth1. Cette connexion peut porter encore bien d&#039;autres noms suivant la façon dont vous vous raccordez sur internet (liaison <abbr title="Universal Serial Bus">USB</abbr> vers votre modem, liaison wifi vers une Xbox, etc).
Ce n&#039;est pas l&#039;objet de cette documentation : on part du principe que votre connexion vers internet fonctionne, et il vous suffira de remplacer eth1 par le nom de votre connexion vers internet.
</p>

<p>
J&#039;impose aussi que le serveur ICS récupère ses informations de connexion via <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>.
</p>
<ul>
<li class="level1"><div class="li"> Ceux qui ont pu surfer tout de suite sur internet sans modifier le paramétrage réseau sont précisément dans ce cas de figure (donc pas d&#039;inquiétude)</div>
</li>
<li class="level1"><div class="li"> ceux qui ont déjà dû aller modifier leurs fichiers /etc/network/interfaces, /etc/resolv.conf,etc… devront tenir compte des modifications effectuées, et lire ce guide avec attention pour vérifier que tout le paramétrage reste compatible.</div>
</li>
</ul>

<p>
Pour simplifier, je considère aussi que toutes mes machines sont connectées au réseau local par l&#039;interface réseau <strong>eth0</strong> , y compris le serveur ICS.
</p>

<p>
Comme on a affaire à un réseau de moins de 254 machines on prendra un masque en 255.255.255.0 , on choisira d&#039;établir notre réseau dans la plage d&#039;adresse 192.168.<strong>X.Y</strong> (ce n&#039;est pas obligatoire, et ceux que cela intéresse peuvent suivre ce lien :
<a href="http://www.games-creators.org/wiki/Adresse_IP" class="urlextern" title="http://www.games-creators.org/wiki/Adresse_IP"  rel="nofollow">http://www.games-creators.org/wiki/Adresse_IP</a>
ou celui-ci :
<a href="http://www.france-hardware.com/articles/22/imprimer.html" class="urlextern" title="http://www.france-hardware.com/articles/22/imprimer.html"  rel="nofollow">http://www.france-hardware.com/articles/22/imprimer.html</a> )
</p>
<ul>
<li class="level1"><div class="li"> Le <strong>X</strong> représente alors l&#039;identification de mon réseau : je décide ici de choisir le chiffre 10.</div>
</li>
<li class="level1"><div class="li"> Le <strong>Y</strong> permet de distinguer les machines les unes des autres au sein de mon réseau 192.168.10.y : chaque machine DOIT avoir une valeur différente.</div>
</li>
</ul>

<p>
De plus, je vais décider que le serveur qui voit internet aura l&#039;adresse IP 192.168.10.1 sur notre réseau local. Il est en effet obligatoire de décider de cette adresse une fois pour toutes.
</p>

<p>
Je vais vous proposer 2 façons de configurer votre réseau local:
</p>
<ul>
<li class="level1"><div class="li"> Méthode basique : configuration statique.</div>
</li>
<li class="level1"><div class="li"> Méthode avancée : configuration dynamique et centralisée.</div>
</li>
</ul>

<p>
À vous de choisir votre méthode en fonction de vos désirs et de votre niveau de connaissance.
On peut aussi mixer les deux solutions (avec précaution) : rien n&#039;interdit par exemple d&#039;avoir une partie de ces machines en configuration statique, et une autre en configuration dynamique.
</p>

</div>
<!-- EDIT1 SECTION "Comment configurer son réseau local ?" [205-5052] -->
<h2 class="sectionedit2" id="methode_basiqueconfiguration_statique">Méthode basique : configuration statique</h2>
<div class="level2">

<p>
Cette méthode est la plus simple à mettre en place, mais aussi la plus lourde à tenir à jour, surtout si vous avez des modifications de parc assez régulières (des machines qui viennent et repartent de votre réseau régulièrement): il va falloir <strong>garder dans un coin la liste de toutes les valeurs que vous avez déjà utilisées</strong> afin de ne pas redonner une même valeur à une nouvelle machine.
</p>

</div>
<!-- EDIT2 SECTION "Méthode basique : configuration statique" [5053-5516] -->
<h3 class="sectionedit3" id="fixer_l_adresse_ip_de_nos_machines">1. Fixer l&#039;adresse IP de nos machines</h3>
<div class="level3">

<p>
Une fois qu&#039;on a déterminé quelle adresse IP on voulait donner à une machine, il faut faire en sorte que cette machine prenne cette adresse IP et n&#039;en change plus jamais.
</p>

<p>
Avec les droits d&#039;administrateur, <a href="../../../tutoriel/comment_modifier_un_fichier" class="wikilink1" title="tutoriel:comment_modifier_un_fichier">éditez le fichier</a> <strong>/etc/network/interfaces</strong>, pour modifier le fichier ainsi :
</p>
<pre class="file">iface eth0 inet dhcp</pre>

<p>
Il deviendra alors (exemple avec une Freebox) :
</p>
<pre class="file">auto eth0
iface eth0 inet static
        address 192.168.10.2
        netmask 255.255.255.0
        gateway 192.168.10.1

# Configuration derrière une FREEBOX HD 
auto eth1
iface eth1 inet static
        address 192.168.0.10
        netmask 255.255.255.0
        gateway 192.168.0.254</pre>

<p>
Redémarrez ensuite le réseau :
</p>
<pre class="code">sudo /etc/init.d/networking restart</pre>

<p>
<p><div class="notewarning">Attention sur Ubuntu 12.04 LTS le fichier /etc/network/interfaces sert aussi de source pour la configuration de la résolution <abbr title="Domain Name System">DNS</abbr>. En effet, le paquet resolvconf est utilisé pour réaliser une auto configuration du /etc/resolv.conf sur la base d&#039;info issues de l&#039;éventuel serveur dhcp quand on garde une configuration &quot;dhcp&quot; dans le /etc/network/interfaces sinon à défaut directement dans ce fichier de config.
</p>

<p>
En cas de configuration en &quot;IP fixe&quot; via le /etc/network/interfaces, il faut alors rajouter une entrée dns-nameservers ip_du-<abbr title="Domain Name System">DNS</abbr> en dessous de la ligne &quot;gateway&quot; dans l&#039;exemple ci dessus.  Il est aussi possible de désinstaller resolvconf et donc alors de donner classiquement les infos de <abbr title="Domain Name System">DNS</abbr> dans le /etc/resolv.conf (01/06/2012) 
</div></p>
</p>

</div>
<!-- EDIT3 SECTION "1. Fixer l'adresse IP de nos machines" [5517-7143] -->
<h3 class="sectionedit4" id="activer_le_partage_de_connexions">2. Activer le partage de connexions</h3>
<div class="level3">

<p>
Sur la machine ICS, voici les commandes à exécuter :
</p>
<pre class="code">echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward            # activation du &quot;pontage&quot; entre les deux cartes réseaux
sudo iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -o eth1 -j MASQUERADE</pre>

<p>
Note : si vous essayez la commande <code>sudo echo 1 &gt; /proc/sys/net/ipv4/ip_forward</code>, elle ne fonctionnera pas ; les redirections (&gt;) sont indépendantes de sudo, seul <code>echo</code> sera exécuté en root.
</p>

<p>
La commande iptables permet d&#039;activer un mécanisme permettant à toutes les machines du réseau local d&#039;aller sur internet en se faisant passer pour LA machine réellement connectée à internet.
Ce mécanisme s&#039;appelle <abbr title="Network Address Translation">NAT</abbr> (Network Address Translation) ou masquage d&#039;adresse IP (Masquerading).
</p>

<p>
Maintenant qu&#039;on a fixé nos adresses IP locales, et qu&#039;on a activé le partage de connexion, toutes nos machines sont capables d&#039;aller sur internet, mais seulement de la façon la plus basique qui soit:
Essayez la commande <strong>ping 212.27.33.233</strong>, et vous verrez que cette machine qui n&#039;est pas du tout sur votre réseau local va vous répondre ( on obtient des lignes du style <strong>Réponse de 212.27.33.233 : octets=32 temps=22 ms TTL=51</strong> ).
</p>

<p>
Toutefois, on ne peut pas encore utiliser de noms pour s&#039;adresser aux autres machines de notre réseau local, ni pour s&#039;adresser aux machines qui sont sur internet.
</p>

<p>
<strong>NOTE </strong>: Ces deux commandes sont &quot;volatiles&quot; : leur effet disparaîtra au prochain redémarrage du serveur ICS. Pour rendre leur effet permanent, il faudra les activer dans un script de démarrage de la machine (voir la méthode avancée) <strong>OU</strong> <a href="../../../tutoriel/comment_modifier_un_fichier" class="wikilink1" title="tutoriel:comment_modifier_un_fichier">modifier le fichier</a> <strong>/etc/network/options</strong> :
</p>

<p>
Le contenu du fichier est le suivant :
</p>
<pre class="file">ip_forward=no
spoofprotect=yes
syncookies=no</pre>

<p>
Il suffit de changer le paramètre <strong>ip_forwarding</strong> en <strong>yes</strong>.
L&#039;option <strong>spoofprotect</strong> active la protection contre l&#039;ip spoofing.
Enfin, la dernière option <strong>syncookies</strong> protège la machine des attaques de type SYN flood.
</p>

</div>
<!-- EDIT4 SECTION "2. Activer le partage de connexions" [7144-9231] -->
<h3 class="sectionedit5" id="renseigner_le_fichieretchosts">3. Renseigner le fichier /etc/hosts</h3>
<div class="level3">

<p>
On va s&#039;occuper de donner des noms aux machines de notre réseau local. En fait elles ont déjà chacune un nom, mais il n&#039;y a qu&#039;elles-mêmes qui le connaissent. Il faut faire en sorte que toutes les machines du réseau sachent que par exemple la machine 192.168.10.3 s&#039;appelle aragorn.
Il faudra faire le tour de toutes les autres machines de votre réseau afin d&#039;<a href="../../../tutoriel/comment_modifier_un_fichier" class="wikilink1" title="tutoriel:comment_modifier_un_fichier">éditer le fichier</a> <strong>/etc/hosts</strong>
</p>

<p>
Voici par exemple le fichier /etc/hosts d&#039;une machine nommée pippin:
</p>
<pre class="file">127.0.0.1       localhost.localdomain   localhost       pippin
192.168.10.1    serveurICS
192.168.10.2    gandalf
192.168.10.3    aragorn
192.168.10.4    boromir

# ce qui suit fait partie de l&#039;installation par défaut d&#039;Ubuntu. A laisser tel quel.
# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
ff02::3 ip6-allhosts</pre>

<p>
A noter que le fichier /etc/hosts de la machine boromir sera différent. Il devra ressembler à ceci:
</p>
<pre class="file">127.0.0.1       localhost.localdomain   localhost       boromir
192.168.10.1    serveurICS
192.168.10.2    gandalf
192.168.10.3    aragorn
192.168.10.5    pippin
...</pre>

<p>
A ce stade de notre configuration, vos machines sont capables de se parler entre elles, et on peut les interpeller par leur nom : <strong>ping gandalf</strong> fonctionnera et ça sera la machine gandalf qui vous répondra.
Mais c&#039;est à vous d&#039;assurer la cohérence du tout: si vous renseignez <em>gandlaf</em> au lieu de <em>gandalf</em> sur une de vos machine, alors <strong>ping gandalf</strong> ne fonctionnera pas à partir de cette machine…
</p>

</div>
<!-- EDIT5 SECTION "3. Renseigner le fichier /etc/hosts" [9232-10962] -->
<h3 class="sectionedit6" id="configurer_sa_resolution_dns">4. Configurer sa résolution DNS</h3>
<div class="level3">

<p>
Il reste encore à faire en sorte qu&#039;au lieu de devoir taper <strong>ping 213.95.41.13</strong>, on puisse taper <strong>ping ubuntu-fr.org</strong>. Si on veut pouvoir surfer sur internet, c&#039;est même obligatoire.
</p>

<p>
On va devoir renseigner le fichier /etc/resolv.conf de chaque machine.
</p>

<p>
Si votre machine ICS a bien fait son travail lorsqu&#039;elle s&#039;est connectée à internet, son fichier /etc/resolv.conf sera déjà renseigné. 
</p>

<p>
Le contenu du fichier /etc/resolv.conf est fourni par un serveur chez votre fournisseur d&#039;accès internet.
Il suffit donc de noter le contenu du fichier /etc/resolv.conf de votre machine ICS, et de le recopier sur toutes vos autres machines
</p>

</div>
<!-- EDIT6 SECTION "4. Configurer sa résolution DNS" [10963-11655] -->
<h2 class="sectionedit7" id="methode_avanceeconfiguration_dynamique_et_centralisee">Méthode avancée : Configuration dynamique et centralisée</h2>
<div class="level2">

<p>
L&#039;idée de cette solution, c&#039;est de concentrer (quasiment) tout le paramétrage sur le seul serveur ICS. De plus, on va optimiser notre réseau en allant interroger les <abbr title="Domain Name System">DNS</abbr> de notre fournisseur d&#039;accès que lorsque c&#039;est strictement nécessaire.
On va utiliser un logiciel appelé <strong>dnsmasq</strong>. Ce logiciel regroupe un serveur <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> et un serveur relais <abbr title="Domain Name System">DNS</abbr>.
</p>
<ul>
<li class="level1"><div class="li"> Le serveur <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> permet de ne plus renseigner les adresses IP sur chaque machine. Chaque machine devient &quot;cliente <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>&quot;, et le serveur distribue les adresses IP disponibles dans une plage d&#039;adresses qu&#039;on lui a spécifié.</div>
</li>
<li class="level1"><div class="li"> Le relais <abbr title="Domain Name System">DNS</abbr> évite de passer par la liaison internet à chaque fois qu&#039;il y a un nom à résoudre : toutes les machines interrogent le serveur relais <abbr title="Domain Name System">DNS</abbr>. Si on lui a déjà posé la question, il répond tout de suite, sinon, c&#039;est lui qui interroge les serveurs <abbr title="Domain Name System">DNS</abbr> du fournisseur d&#039;accès, et qui ensuite donne la réponse (mais il la garde en mémoire au cas où on lui repose la question).</div>
</li>
</ul>

<p>
De plus, le relais <abbr title="Domain Name System">DNS</abbr> va également mémoriser les noms de nos machines locales. C&#039;est très important , car comme les machines vont être en <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> , on ne saura pas avec quelle adresse IP elle vont se retrouver (sauf à passer la commande <strong>ifconfig</strong> sur place, mais ça n&#039;est pas le but). Par contre, le nom sera toujours à jour.
</p>

<p>
On va en profiter pour sécuriser un peu mieux le démarrage de notre serveur.
</p>

</div>
<!-- EDIT7 SECTION "Méthode avancée : Configuration dynamique et centralisée" [11656-13129] -->
<h3 class="sectionedit8" id="dnsmasq">1. dnsmasq</h3>
<div class="level3">

<p>
Sur le serveur ICS, effectuez les actions suivantes:
</p>
<ul>
<li class="level1"><div class="li"> <a href="../../../tutoriel/comment_installer_un_paquet" class="wikilink1" title="tutoriel:comment_installer_un_paquet">Installez le paquet</a> <strong>dnsmasq</strong> (il faut avoir l&#039;accès aux <a href="../../../depots#universe_et_multiverse" class="wikilink1" title="depots">dépots &quot;universes&quot;</a>)</div>
</li>
<li class="level1"><div class="li"> Sauvegardez le fichier de configuration original (Et vous pouvez le consulter, il contient plein d&#039;exemples pour comprendre): </div>
</li>
</ul>
<pre class="code">sudo cp -p /etc/dnsmasq.conf /etc/dnsmasq.conf.ori</pre>
<ul>
<li class="level1"><div class="li"> <a href="../../../tutoriel/comment_modifier_un_fichier" class="wikilink1" title="tutoriel:comment_modifier_un_fichier">Éditez le fichier</a> <strong>/etc/dnsmasq.conf</strong>, et adaptez le en fonction de votre besoin : si vous avez une adresse IP dynamique (votre <abbr title="Fournisseur d&#039;Accès à Internet">FAI</abbr> change votre adresse tous les jours), commentez la ligne &quot;no-poll&quot; (mettez un # devant).</div>
</li>
</ul>
<pre class="file"># Configuration file for dnsmasq.
#
# pour éviter de fournir du trafic DHCP/DNS inutile du coté internet
##domain-needed
bogus-priv
# pour permettre a dnsmasq de suivre vos changement d&#039;IP:
# commentez cette ligne si vous avez une IP qui change
no-poll
# pour limiter l&#039;écoute de requêtes DHCP du coté réseau local
interface=eth0
# nom de votre domaine pour dnsmasq
domain=inet
# activez le serveur DHCP:
dhcp-range=192.168.10.100,192.168.10.150,255.255.255.0,12h</pre>

</div>
<!-- EDIT8 SECTION "1. dnsmasq" [13130-14319] -->
<h3 class="sectionedit9" id="iptables">2. iptables</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> Il faut maintenant créer le fichier de démarrage d&#039;iptables. <a href="../../../tutoriel/comment_modifier_un_fichier" class="wikilink1" title="tutoriel:comment_modifier_un_fichier">Éditez le fichier</a> <strong>/etc/init.d/iptables</strong></div>
</li>
</ul>

<p>
Voici son contenu:
</p>
<pre class="file">#!/bin/sh
#
# Script de démarrage qui lance l&#039;interface réseau internet,
# met en place un firewall basique et un partage de connexion
#
# Inspiré du script de Mjules_at_ifrance.com
#

start() {
# init du la périphérique internet (ici derrière un modem ADSL ethernet, DHCP client)

/sbin/ifup eth1

# Dans cette partie, on met en place le firewall
#vidage des chaînes
iptables -F
#destruction des chaînes personnelles
iptables -X

#stratégies par défaut
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

#init des tables NAT et MANGLE (pas forcément nécessaire)
iptables -t nat -F
iptables -t nat -X
iptables -t nat -P PREROUTING ACCEPT
iptables -t nat -P POSTROUTING ACCEPT
iptables -t nat -P OUTPUT ACCEPT

iptables -t mangle -F
iptables -t mangle -X
iptables -t mangle -P PREROUTING ACCEPT
iptables -t mangle -P OUTPUT ACCEPT


# Acceptation de toutes les connexions en local (un process avec l&#039;autre)
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# PORT FORWARDING:
# attention : on ne peut &lt;del&gt;malheureusement&lt;/del&gt; heureusement pas mettre un nom de machine en destination, il faut mettre l&#039;adresse IP.
# exemple : on veut qu&#039;un serveur HTTP installé sur une machine du réseau local soit visible depuis l&#039;extérieur.
###iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j DNAT --to-destination 192.168.10.121:80
###iptables -A FORWARD -p tcp -i eth1 --dport 80 -j ACCEPT


#création d&#039;une nouvelle règle
iptables -N MAregle

#définition de la règle : accepter les nouvelles connexions ne venant pas de l&#039;interface internet
# et accepter toutes les connexions établies et reliées (ex: une demande de page HTML provoque l&#039;ouverture
# d&#039;une connexion reliée pour acheminer cette page vers l&#039;ordinateur)

iptables -A MAregle -m state --state NEW -i! eth1 -j ACCEPT
iptables -A MAregle -m state --state ESTABLISHED,RELATED -j ACCEPT

#application de la règle au partage de connexion
iptables -A INPUT -j MAregle
iptables -A FORWARD -j MAregle

# activation du forwarding dans le noyau
# mise en place du partage de connexion sur le réseau local

echo 1 &gt;/proc/sys/net/ipv4/ip_forward
iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -o eth1 -j MASQUERADE

}

stop() {
        echo 0 &gt;/proc/sys/net/ipv4/ip_forward
        ifdown eth1
}

case &quot;$1&quot; in
 start)
        start
        ;;

stop)
        stop
        ;;
restart)
        stop &amp;&amp; start
        ;;
*)
        echo &quot;Usage $0 {start|stop|restart}&quot;
        exit 1
esac

exit 0</pre>
<ul>
<li class="level1"><div class="li"> Une fois le script créé, il faut le rendre exécutable:</div>
</li>
</ul>
<pre class="code">sudo chmod +x /etc/init.d/iptables</pre>
<ul>
<li class="level1"><div class="li"> Puis, on va intégrer ce script dans les séquences de démarrage et d&#039;arrêt de notre machine ICS.</div>
</li>
</ul>
<pre class="code">sudo update-rc.d iptables start 99 2 . stop 00 2 0 1 6 .</pre>

<p>
<strong>Attention</strong> : n&#039;oubliez pas les points, ils font partie de la syntaxe
</p>

<p>
Pour plus d&#039;information sur les scripts de démarrage, voir <a href="http://www.andesi.org/administration/gerer-les-services-lances-au-demarrage" class="urlextern" title="http://www.andesi.org/administration/gerer-les-services-lances-au-demarrage"  rel="nofollow">http://www.andesi.org/administration/gerer-les-services-lances-au-demarrage</a>
</p>

</div>
<!-- EDIT9 SECTION "2. iptables" [14320-17541] -->
<h3 class="sectionedit10" id="ajustements">3. ajustements</h3>
<div class="level3">

<p>
Il reste quelques ajustements à effectuer sur notre serveur ICS:
</p>

</div>

<h4 id="interfaces">Interfaces</h4>
<div class="level4">

<p>
Il faut <a href="../../../tutoriel/comment_modifier_un_fichier" class="wikilink1" title="tutoriel:comment_modifier_un_fichier">modifier le fichier</a> <strong>/etc/network/interfaces</strong>
En effet, on a pu voir que le script iptables s&#039;occupait de démarrer l&#039;interface eth1. Il ne faut donc plus la faire démarrer au boot du serveur ICS.
Dans le principe, il faut retirer la mention <em>eth1</em> de la ligne qui commence par <em>auto</em>.
</p>

<p>
Vous noterez au passage que le fichier contient aussi le paramétrage en IP fixe pour eth0 (rappel : eth0 est en IP fixe, c&#039;est obligatoire (voir contraintes au début du tutoriel)).
</p>
<pre class="file"># The loopback network interface
auto lo eth0
iface lo inet loopback

# This is a list of hotpluggable network interfaces.
# They will be activated automatically by the hotplug subsystem.
mapping hotplug
        script grep
        map eth0

# The primary network interface
iface eth0 inet static
        address 192.168.10.1
        netmask 255.255.255.0
# Interface vers internet : eth1
# cette interface est demarree par le script iptables
# donc elle est absente de la ligne &quot;auto&quot;
iface eth1 inet dhcp</pre>

</div>

<h4 id="hotes">Hôtes</h4>
<div class="level4">

<p>
Il faut aussi <a href="../../../tutoriel/comment_modifier_un_fichier" class="wikilink1" title="tutoriel:comment_modifier_un_fichier">modifier le fichier</a>  <strong>/etc/hosts</strong> de notre serveur ICS :
</p>
<pre class="file">127.0.0.1      localhost.localdomain   localhost
192.168.10.1   serveurICS</pre>

<p>
Explication : après une installation d&#039;Ubuntu, <em>serveurICS</em> est sur la même ligne que <em>localhost</em>.
Sur toutes les machines de notre réseau, c&#039;est désiré : ça permet à chaque machine de se reconnaître elle-même.
L&#039;ennui, c&#039;est que toutes les informations contenues dans le fichier /etc/hosts de notre serveur ICS vont être disponibles à travers notre réseau local. (via le relais <abbr title="Domain Name System">DNS</abbr>)
Si on ne modifiait pas /etc/hosts, un <strong>ping serveurICS</strong> à partir de gandalf répondrait que <strong>Réponse de 127.0.0.1 : octets=32 temps&lt;1ms TTL=128</strong>, sauf que 127.0.0.1 n&#039;est pas notre serveur ICS, mais gandalf lui-même.
</p>

</div>

<h4 id="dhcclient">dhcclient</h4>
<div class="level4">

<p>
Cette manipulation est à faire sous réserve que votre serveur ICS est configuré en <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> client auprès de votre fournisseur d&#039;accès.
C&#039;est grâce au <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> client que le fichier /etc/resolv.conf est automatiquement renseigné sur le serveur ICS. De même, l&#039;adresse IP de la carte eth1, ainsi que la route par défaut sont fournies via <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>.
Le problème, c&#039;est que comme /etc/resolv.conf a été alimenté par <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>, il contient donc les <abbr title="Domain Name System">DNS</abbr> du fournisseur d&#039;accès. Aucune chance que votre founisseur d&#039;accès ne connaisse votre machine &quot;pippin&quot;. Donc à partir du serveur ICS, un <strong>ping pippin</strong> n&#039;a aucune chance d&#039;aboutir.
Voici ce qu&#039;il faut faire :
</p>
<ul>
<li class="level1"><div class="li"> <a href="../../../tutoriel/comment_modifier_un_fichier" class="wikilink1" title="tutoriel:comment_modifier_un_fichier">Éditez le fichier</a> <strong>/etc/dhcp3/dhclient.conf</strong></div>
</li>
<li class="level2"><div class="li"> recherchez et décommentez la ligne <em>prepend domain-name-servers 127.0.0.1;</em></div>
</li>
<li class="level2"><div class="li"> sauvegardez la modification.</div>
</li>
</ul>

<p>
En clair, cette modification indique ceci au serveur ICS : &quot;Pour rechercher un nom, adresse-toi d&#039;abord à toi-même , et si tu n&#039;y arrives pas, alors fait comme d&#039;habitude&quot;.
</p>

</div>
<!-- EDIT10 SECTION "3. ajustements" [17542-20616] -->
<h3 class="sectionedit11" id="les_autres_machines">4. les autres machines</h3>
<div class="level3">

<p>
Pour que tout fonctionne, il faut faire en sorte que les autres machines de notre réseau s&#039;intègrent correctement dans le réseau.
</p>

<p>
Si vous aviez configuré les cartes eth0 en dur, il faut les remettre en <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>
</p>

<p>
Il faut modifier (un peu) le fichier /etc/dhcp3/dhclient.conf :
</p>

<p>
Cette modification est nécessaire pour que vos machines inscrivent leurs nom dans le serveur <abbr title="Domain Name System">DNS</abbr> relais (installé sur le serveur ICS).
</p>
<ul>
<li class="level1"><div class="li"> <a href="../../../tutoriel/comment_modifier_un_fichier" class="wikilink1" title="tutoriel:comment_modifier_un_fichier">Éditez le fichier</a> <strong>/etc/dhcp3/dhclient.conf</strong></div>
</li>
<li class="level2"><div class="li"> recherchez la ligne contenant <em>send host-name</em></div>
</li>
<li class="level2"><div class="li"> complétez-la et décommentez-la : <em>send host-name &quot;monpc&quot;;</em> ou <em>monpc</em> est le nom du poste (attention à la syntaxe, mettez bien les guillemets)</div>
</li>
</ul>

</div>
<!-- EDIT11 SECTION "4. les autres machines" [20617-21373] -->
<h3 class="sectionedit12" id="comment_ca_marche">5. Comment ça marche ?</h3>
<div class="level3">

<p>
Et voilà, rebootez votre serveur ICS, puis rebootez les autres machines de votre réseau local.
</p>

<p>
Quand une machine du réseau local démarre, voici ce qu&#039;elle fait :
</p>
<ul>
<li class="level1"><div class="li"> Recherche d&#039;un serveur <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>, le serveur ICS répond.</div>
</li>
<li class="level1"><div class="li"> Le serveur ICS fournit une adresse <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> dans la plage 192.168.10.100 à 192.168.10.150</div>
</li>
<li class="level1"><div class="li"> Le serveur ICS renseigne le fichier /etc/resolv.conf de votre machine : il se met lui-même (192.168.10.1), car il est serveur relais <abbr title="Domain Name System">DNS</abbr>.</div>
</li>
<li class="level1"><div class="li"> Le serveur ICS renseigne la route par défaut. Il se nomme lui-même en route par défaut car c&#039;est lui qui effectue le partage de la connexion Internet.</div>
</li>
</ul>

<p>
À ce stade, on peut aussi installer une machine Windows dans le réseau local : en laissant le paramétrage <abbr title="Transmission Control Protocol">TCP</abbr>/IP et les <abbr title="Domain Name System">DNS</abbr> sur &quot;obtenir automatiquement&quot; (par défaut), elle sera reconnue par tout le réseau.
</p>

<p>
Quand vous faites <strong>ping gandalf</strong>, ce n&#039;est pas forcément 192.168.10.103 qui va répondre (par exemple), mais vous serez sûr que c&#039;est bien gandalf.
</p>

</div>
<!-- EDIT12 SECTION "5. Comment ça marche ?" [21374-22392] -->
<h3 class="sectionedit13" id="en_cas_de_probleme">6. En cas de problème</h3>
<div class="level3">

<p>
Voici les pièges dans lesquels je suis tombé :
</p>
<ul>
<li class="level1"><div class="li"> Ma plage <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> n&#039;était pas dans le même réseau local que mon interface ethernet (ex: plage 192.168.0.100-192.168.0.150 alors que l&#039;interface est en 192.168.1.1)</div>
</li>
<li class="level1"><div class="li"> Le réseau local référencé dans la commande POSTROUTING du script iptables  ne correspondait pas au réseau local dans lequel était la patte locale de mon serveur</div>
</li>
<li class="level1"><div class="li"> J&#039;ai confondu eth0 et eth1 dans iptables, du coup, mon serveur n&#039;était pas joignable en local…</div>
</li>
</ul>

<p>
Si vous avez des questions ou des commentaires, voici un lien vers le forum :
<a href="http://forum.ubuntu-fr.org/viewtopic.php?id=6468" class="urlextern" title="http://forum.ubuntu-fr.org/viewtopic.php?id=6468"  rel="nofollow">http://forum.ubuntu-fr.org/viewtopic.php?id=6468</a>
</p>

</div>
<!-- EDIT13 SECTION "6. En cas de problème" [22393-23047] -->
<h3 class="sectionedit14" id="version_simple_pour_se_connecter_a_une_machine_d_un_reseau">7. Version simple pour se connecter à une machine d&#039;un réseau</h3>
<div class="level3">

<p>
Configurer le réseau en ip Statique sur les deux machines
</p>

<p>
Graphiquement :
</p>
<div class="table sectionedit15"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> ?         </th><th class="col1 leftalign"> Jaunty Jackalope 9.04                          </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Système → Administration → Réseau</strong>   </td><td class="col1 leftalign"> <strong>Système → Préférences → Connexions Réseau</strong>     </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> Sélectionner la carte concernée puis <strong>Propriétés</strong> <br/>
remplir comme suit :   </td><td class="col1"> Dans l&#039;onglet <strong>Filaire</strong><br/>
Choisir la carte réseau concernée<br/>
Puis Modifier</td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign"> IP statique : 192.168.1.X<br/>
Masque : 255.255.255.0<br/>
Passerelle :<br/>
passerelle du modem pour avoir internet<br/>
(avec alice : 192.168.1.1) (avec freebox : 192.168.0.254) (avec livebox: 192.168.1.1)   </td><td class="col1">Dans l&#039;onglet IPv4<br/>
Choisir Méthode: Mannuel<br/>
Puis remplir comme ci contre</td>
	</tr>
</table></div>
<!-- EDIT15 TABLE [23200-23815] -->
<p>
<br/>

</p>

<p>
Installer les serveurs SSH :
<strong>Système → Administration → gestionnaire de paquets</strong>
</p>

<p>
Chercher SSH et installer 2 paquets SSH ainsi que openssh-server
</p>

<p>
<br/>

</p>

<p>
Créer un utilisateur en plus sur le serveur (il peut y avoir 2 ou plus de serveurs) :
<strong>Système → Administration → utilisateurs et groupes</strong>
</p>

<p>
<br/>

</p>

<p>
On se connecte :
<strong>Raccourcis → se connecter à un serveur</strong>
</p>

<p>
sélectionner SSH et entrer l&#039;adresse ip de l&#039;ordinateur serveur ainsi que le nom d&#039;utilisateur créé précédemment
</p>

<p>
Et voilà !
</p>

<p>
[14-12-08] Documentation mise à jour <a href="../../../partage_de_connexion_internet" class="wikilink1" title="partage_de_connexion_internet"> ici </a>
</p>
<hr />

<p>
<em> Contributeurs : <a href="../../../utilisateurs/sksbir" class="wikilink2" title="utilisateurs:sksbir" rel="nofollow">sksbir</a>, <a href="../../../utilisateurs/borislehachoir" class="wikilink2" title="utilisateurs:borislehachoir" rel="nofollow">BorisLeHachoir</a>, </em>
</p>

</div>
<!-- EDIT14 SECTION "7. Version simple pour se connecter à une machine d'un réseau" [23048-] -->
<!-- cachefile /srv/www/doc.ubuntu-fr.org/htdocs/data/cache/3/393bd72487cb51eec779c9d63649e52e.xhtml used -->
</div>
</body>
</html>
