<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>installation:raid1_software</title>
<meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="date" content="2012-12-26T09:13:51+0100"/>
<meta name="keywords" content="installation,systeme,securite,tutoriel,raid,brouillon,vetuste"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../../lib/exe/opensearch.php" title="Documentation Ubuntu Francophone"/>
<link rel="start" href="../../../index.html"/>
<link rel="contents" href="../../../installation/raid1_software?do=index" title="Plan du site"/>
<link rel="alternate" type="application/rss+xml" title="Derniers changements" href="../../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Namespace actuel" href="../../../feed.php?mode=list&amp;ns=installation"/>
<link rel="alternate" type="text/html" title="HTML brut" href="raid1_software"/>
<link rel="alternate" type="text/plain" title="Wiki balise" href="../../raw/installation/raid1_software"/>
<link rel="canonical" href="../../../installation/raid1_software"/>
<link rel="stylesheet" type="text/css" href="../../../lib/exe/css.php?t=ubuntu-2010&amp;tseed=4af22dedc19f28c99fa67afabbb173df"/>
<script type="text/javascript">/*<![CDATA[*/var NS='installation';var JSINFO = {"id":"installation:raid1_software","namespace":"installation"};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../../lib/exe/js.php?tseed=4af22dedc19f28c99fa67afabbb173df"></script>
</head>
<body>
<div class="dokuwiki export">
<!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table des matières</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="raid1_software#introduction">Introduction</a></div></li>
<li class="level1"><div class="li"><a href="raid1_software#preambule">Préambule</a></div></li>
<li class="level1"><div class="li"><a href="raid1_software#installation">Installation</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="raid1_software#partitionnement">Partitionnement</a></div></li>
<li class="level2"><div class="li"><a href="raid1_software#premier_demarrage">Premier démarrage</a></div></li>
<li class="level2"><div class="li"><a href="raid1_software#duplication_du_boot">Duplication du boot</a></div></li>
<li class="level2"><div class="li"><a href="raid1_software#installer_un_raid1_en_mode_terminal_a_la_main">Installer un RAID1 en mode terminal &quot;à la main&quot;</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="raid1_software#utilisation_du_systeme_raid-1_logiciel">Utilisation du système RAID-1 logiciel</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="raid1_software#comment_obtenir_des_informations_sur_le_statut_du_raid">Comment obtenir des informations sur le statut du RAID ?</a></div></li>
<li class="level2"><div class="li"><a href="raid1_software#comment_invalider_un_disque">Comment invalider un disque ?</a></div></li>
<li class="level2"><div class="li"><a href="raid1_software#comment_demarrer_en_cas_de_panne_d_un_des_disques">Comment démarrer en cas de panne d&#039;un des disques ?</a></div></li>
<li class="level2"><div class="li"><a href="raid1_software#comment_remplacer_le_disque_defectueux_et_reactiver_le_raid">Comment remplacer le disque défectueux et réactiver le RAID ?</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="raid1_software#agrandir_un_systeme_raid-1_logiciel">Agrandir un système RAID-1 logiciel</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="raid1_software#ajout_de_nouveaux_disques">Ajout de nouveaux disques</a></div></li>
<li class="level2"><div class="li"><a href="raid1_software#remplacement_des_disques_existants">Remplacement des disques existants</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="raid1_software#notes">Notes</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="raid1_software#concernant_les_fake-raid">Concernant les fake-RAID</a></div></li>
<li class="level2"><div class="li"><a href="raid1_software#concernant_le_demarrage_avec_des_controleurs_promise">Concernant le démarrage avec des contrôleurs Promise</a></div></li>
<li class="level2"><div class="li"><a href="raid1_software#boot_directement_sur_la_partition_raid">Boot directement sur la partition RAID</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="raid1_software#liens">Liens</a></div></li>
</ul>
</div>
</div>
<!-- TOC END -->
<div class="tags"><span>
	<a href="../../../installation.1" class="wikilink1" title="installation" rel="tag">installation</a>,
	<a href="../../../systeme" class="wikilink1" title="systeme" rel="tag">système</a>,
	<a href="http://doc.ubuntu-fr.org/securite" class="wikilink1" title="securite" rel="tag">sécurité</a>,
	<a href="http://doc.ubuntu-fr.org/tutoriel" class="wikilink1" title="tutoriel" rel="tag">tutoriel</a>,
	<a href="../../../raid" class="wikilink1" title="raid" rel="tag">raid</a>,
	<a href="../../../brouillon" class="wikilink1" title="brouillon" rel="tag">brouillon</a>,
	<a href="../../../vetuste" class="wikilink1" title="vetuste" rel="tag">vétuste</a>
</span></div>

<p>
<p><div class="noteclassic"> A déplacer
</div></p>
</p>
<hr />

<h1 class="sectionedit1" id="comment_installer_ubuntu_sur_un_raid-1_logiciel">Comment installer Ubuntu sur un RAID-1 logiciel ?</h1>
<div class="level1">

</div>
<!-- EDIT1 SECTION "Comment installer Ubuntu sur un RAID-1 logiciel ?" [109-177] -->
<h2 class="sectionedit2" id="introduction">Introduction</h2>
<div class="level2">

<p>
Une des plus grandes hantises pour l&#039;utilisateur de l&#039;outil informatique est de perdre ses précieuses données ; ses lettres, ses morceaux de musiques préférés, la configuration de sa machine,… mais également (surtout depuis l&#039;explosion de la photo numérique) les photos du petit dernier.
</p>

<p>
Une des causes les plus fréquentes de cette perte de données est le crash du disque dur. Un composant matériel qui peut flancher (comme tout composants) et qui peut vous causer de gros tracas surtout si vous n&#039;avez pas fait de sauvegarde de vos données.
</p>

<p>
Si vous avez un peu d&#039;argent dans votre tirelire, une solution simple et pas trop onéreuse peut vous prémunir de ce genre de désagrément ; il s&#039;agit du RAID. Le concept du RAID est d&#039;écrire simultanément sur plusieurs disques les mêmes données afin d&#039;éviter toute perte en cas de panne de l&#039;un des disques.
</p>

<p>
La solution que je vais vous expliquer repose sur un RAID-1. Le RAID-1 est en fait, une copie miroir d&#039;un disque sur un autre (ou plus mais alors, je vous conseille d&#039;utiliser le RAID-5). Pour installer une solution de type RAID-5 ou RAID-1 avec plusieurs disques, vous pouvez vous baser sur cet article et l&#039;adapter légèrement à vos besoins.
</p>

<p>
<strong>ATTENTION : bien que le risque de perdre vos données soit limité avec l&#039;usage d&#039;une solution RAID, cela ne vous dispense pas d&#039;effectuer des backups !!!</strong>
</p>

<p>
Quelques idées pour les backups :
</p>
<ul>
<li class="level1"><div class="li"> Les CDs ou les DVDs et plus encore (<a href="../../../backup-manager" class="wikilink1" title="backup-manager">backup-manager</a>).</div>
</li>
<li class="level1"><div class="li"> Les synchronisations avec une autre machine (<a href="../../../rsync" class="wikilink1" title="rsync">rsync</a>).</div>
</li>
<li class="level1"><div class="li"> Une sauvegarde automatique et incrémentielle de son répertoire <em>home</em> (<a href="http://doc.ubuntu-fr.org/rdiff-backup" class="wikilink1" title="rdiff-backup">rdiff-backup</a>)</div>
</li>
</ul>

<p>
<em>Remarque : l&#039;article ci-dessous repose sur le fait que vous possédez <em class="u">deux disques dans une même machine</em>; si les deux disques sont dans deux machines différentes, je vous conseille de lire l&#039;article concernant le <a href="http://doc.ubuntu-fr.org/drbd" class="wikilink1" title="drbd">RAID-1 over IP avec DRBD</a>.</em>
</p>

<p>
La solution RAID-1 proposée ci-dessous est une solution <strong>logicielle</strong>. Il ne s&#039;agit pas d&#039;une carte contrôleur RAID que l&#039;on installe dans la machine. Remarquez cependant que plusieurs contrôleurs RAID grand public <em class="u">ne font pas du RAID en hardware</em>, une explication les concernant est disponible en fin de l&#039;article.
</p>

</div>
<!-- EDIT2 SECTION "Introduction" [178-2429] -->
<h2 class="sectionedit3" id="preambule">Préambule</h2>
<div class="level2">

<p>
Je vais vous exposer comment j&#039;ai installé un RAID-1 logiciel sur un serveur <em>Fujitsu Siemens RX100 S2</em> équipé d&#039;un contrôleur fake-RAID <em>Promise Fasttrack S150 TX4</em>. Les disques durs sont deux disques <abbr title="Serial Advanced Technology Attachment">SATA</abbr> de 80 Go et sont reconnus comme étant les devices <code>/dev/sda</code> et <code>/dev/sdb</code>. Si vous ne disposez pas d&#039;un système <em>fake-RAID</em>, la technique est identique à l&#039;exception de la récupération en cas de panne qui nécessite quelques ajustements.
</p>

<p>
Cet article considère que vous savez comment installer une Ubuntu Hoary de manière normale et que vous possédez une gravure sur CD d&#039;Hoary; vous trouverez plus d&#039;information concernant l&#039;installation d&#039;Hoary sur <a href="../../../installation.1" class="wikilink1" title="installation">cette page</a>.
</p>

</div>
<!-- EDIT3 SECTION "Préambule" [2430-3168] -->
<h2 class="sectionedit4" id="installation">Installation</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Pour commencer l&#039;installation, démarrer sur le CD-ROM Ubuntu. Personnellement, j&#039;ai installé Ubuntu en mode <code>server</code>. Ce n&#039;est pas nécessaire mais il est utile de préciser que tout ce qui suit sera en ligne de commande car aucune interface X n&#039;est installée lors d&#039;une installation en mode <code>Server</code><sup><a href="raid1_software#fn__1" id="fnt__1" class="fn_top">1)</a></sup>.</div>
</li>
</ul>

<p>
<strong>Attention : Il est impératif d&#039;utiliser le CD &quot;Server&quot; ou le CD &quot;Alternate&quot;, car il n&#039;y a pas les options pour le RAID avec le CD &quot;Desktop&quot;.</strong>
</p>
<ul>
<li class="level1"><div class="li"> Effectuez l&#039;installation normalement jusqu&#039;au partitionnement des disques avec l&#039;outil <code>partman</code>.</div>
</li>
</ul>

</div>
<!-- EDIT4 SECTION "Installation" [3169-3964] -->
<h3 class="sectionedit5" id="partitionnement">Partitionnement</h3>
<div class="level3">

<p>
A ce moment, vous devriez avoir à l&#039;écran l&#039;ensemble des disques durs détectés ainsi qu&#039;une option permettant de modifier les tables de partitions manuellement.
</p>
<ul>
<li class="level1"><div class="li"> Choisissez <code>Modifier manuellement la table de partition</code>.</div>
</li>
<li class="level1"><div class="li"> Partitionnez les disques et gardez en tête que les deux disques doivent être parfaitement identiques. C&#039;est-à-dire que si vous avez deux disques de tailles différentes, veillez à garder le début des disques identiques et ajoutez une partition au plus grand que vous monterez plus tard si nécessaire (Attention, cette partition ne sera pas en RAID-1).</div>
</li>
<li class="level1"><div class="li"> Avec des disques de 80 Go, j&#039;ai choisi de partitionner de la manière suivante :</div>
</li>
</ul>
<pre class="code">sda1         /boot        509.9 MB  (amorçable)
sda2         swap         1.0 GB
sda3         raid         78.5 GB</pre>
<ul>
<li class="level1"><div class="li"> Voici un autre exemple avec 2 disques de 250 Go :</div>
</li>
</ul>

<p>
Je crée d&#039;abord 3 partitions RAID sur chacun des disques.
</p>

<p>
Disque 1
</p>
<pre class="code">sda1         raid         1 GB
sda2         raid         2 GB
sda3         raid         247 GB</pre>

<p>
Disque 2
</p>
<pre class="code">sdb1         raid         1 GB
sdb2         raid         2 GB
sdb3         raid         247 GB</pre>

<p>
Puis je crée 3 périphériques multidisques RAID.
Et enfin je formate ces 3 périphériques comme suit :
</p>
<pre class="code">raid1         /boot     1 GB
raid2         swap      2 GB
raid3         /         247 GB</pre>
<ul>
<li class="level1"><div class="li"> Pour d&#039;autres informations sur cette étape voir aussi <a href="../../../tutoriel/comment_installer_ubuntu_sur_raid0_logiciel" class="wikilink1" title="tutoriel:comment_installer_ubuntu_sur_raid0_logiciel">Comment installer</a> Ubuntu sur un RAID-0 logiciel ?</div>
</li>
</ul>

<p>
<strong>Important :</strong> notez les informations concernant l&#039;ordre et les tailles des partitions que vous venez de créer car ces informations pourraient (j&#039;espère pour vous que non) vous être utiles si un des disques devait être remplacé.
</p>

<p>
<strong>Remarque :</strong> on m&#039;a indiqué que GRUB et LILO sont capables de booter directement sur une device de type RAID software (<code>/dev/mdX</code>). Je n&#039;ai cependant pas eu l&#039;occasion d&#039;essayer la procédure. La machine qui est à ma disposition est maintenant en production. Je mettrai cette page à jour dès que possible; vous trouverez les informations concernant GRUB et LILO dans les notes (en fin d&#039;article).
</p>
<ul>
<li class="level1"><div class="li"> Pour indiquez que <code>sda3</code> est un volume RAID, il vous suffit de créer une partition et de sélectionner <code>Volume physique RAID</code> pour le champ <code>Utiliser comme</code>.</div>
</li>
<li class="level1"><div class="li"> Répercutez la même table de partition sur le second disque <code>sdb</code>. Mais, <strong>attention</strong> : veillez bien à ne pas indiquer de point de montage pour la première partition (<code>/boot</code>), ni pour la seconde partition (<code>swap</code>). Indiquez ces partitions comme étant <code>Ne pas utiliser cette partition</code> pour le champ <code>Utiliser comme</code>.</div>
</li>
<li class="level1"><div class="li"> <strong>Remarque importante :</strong> N&#039;oubliez pas d&#039;indiquer à chaque fois que la première partition est amorçable.</div>
</li>
<li class="level1"><div class="li"> Maintenant, vous pouvez définir votre RAID-1 logiciel en allant sur le champ <code>Configurer le RAID logiciel</code>.</div>
</li>
<li class="level1"><div class="li"> Ubuntu va vous demander si vous voulez appliquer les changements, faites <code>oui</code>.</div>
</li>
<li class="level1"><div class="li"> Choisissez <code>Configurer un périphérique multi-disques</code>.</div>
</li>
<li class="level1"><div class="li"> Choisissez l&#039;option <code>RAID-1</code>, nombre de périphériques actifs : <code>2</code>, nombre de périphériques de réserves : <code>0</code>.</div>
</li>
<li class="level1"><div class="li"> Sélectionnez les deux périphériques actifs; chez moi, il s&#039;agit de :</div>
</li>
</ul>
<pre class="code">/dev/scsi/host1/bus0/target0/lun0/part3
/dev/scsi/host0/bus0/target0/lun0/part3</pre>
<ul>
<li class="level1"><div class="li"> Choisissez <code>Continuer</code> et <code>Terminer</code>.</div>
</li>
<li class="level1"><div class="li"> Vous avez maintenant une ligne supplémentaire avec quelque chose ressemblant à ceci, dans le cas du premier exemple de disques 80 Go, :</div>
</li>
</ul>
<pre class="code">Périphérique RAID1 n°0 - 78.5 GB    Périph. RAID1 logiciel
  n°1   78.5 GB</pre>
<ul>
<li class="level1"><div class="li"> Allez sur <code>n°1   78.5 <abbr title="Gigabyte">GB</abbr></code> et faites <code>ENTER</code>.</div>
</li>
<li class="level1"><div class="li"> Changez le champ <code>Utiliser comme</code> pour obtenir <code>Système de fichiers journalisé ext3</code> et changez le point de montage en <code>/</code>.</div>
</li>
<li class="level1"><div class="li"> Sélectionnez <code>Fin  du paramètrage pour cette partition</code>.</div>
</li>
<li class="level1"><div class="li"> Tout en bas de l&#039;écran, allez sur l&#039;élément <code>Terminer le partitionnement et appliquer les changements</code> et faites <code>ENTER</code>.</div>
</li>
<li class="level1"><div class="li"> Confirmez le fait qu&#039;il faut appliquer les changements sur les disques.</div>
</li>
<li class="level1"><div class="li"> A partir de maintenant, vous pouvez terminer l&#039;installation normalement.</div>
</li>
</ul>

</div>

<h5 id="quelques_explications">Quelques explications</h5>
<div class="level5">

<p>
Tout d&#039;abord, vous avez sans doute remarqué la création d&#039;une partition <code>/boot</code>. Cette partition <code>/boot</code> est nécessaire car elle va nous permettre de stocker le noyau afin qu&#039;il soit accessible par le <abbr title="Basic Input-Output System">BIOS</abbr>. En effet, le <abbr title="Basic Input-Output System">BIOS</abbr> n&#039;est pas capable de lire une partition RAID-1 logicielle; seul le noyau Linux peut le faire. Or, à ce moment du démarrage, on doit être capable de charger le noyau, c&#039;est pour cela qu&#039;on va placer le noyau et la base du système nécessaire au démarrage dans cette partition <code>/boot</code>.
</p>

<p>
Ensuite, vous me direz que les données RAID-1 seront sauvegardées mais pas les informations de démarrage (ce qui se trouve dans <code>/boot</code>). C&#039;est exact. Comme cette partition ne peut pas être mise sur le RAID, on va devoir la dupliquer manuellement à chaque modification du noyau ou des paramètres de démarrage (GRUB,…).
</p>

<p>
Enfin, les partitions ne sont pas utilisées sur le second disque (notamment, <code>sdb1</code> et <code>sdb2</code>) afin que l&#039;installeur Ubuntu ne configure pas les accès à ces partitions (qui serviront en cas de panne du premier disque).
</p>

</div>
<!-- EDIT5 SECTION "Partitionnement" [3965-9292] -->
<h3 class="sectionedit6" id="premier_demarrage">Premier démarrage</h3>
<div class="level3">

<p>
<del><strong>Attention</strong> : n&#039;effectuez pas de reboot ou d&#039;arrêt lors du premier démarrage tant que la construction du RAID n&#039;est pas finie !!!</del>
(s&#039;il vous arrive de redémarrer votre machine avant la fin de la construction du Raid, celle ci reprendra quasiment là ou elle s&#039;est arreté)
</p>

<p>
Pour savoir si la construction est finie, vous trouverez les informations en affichant le fichier <code>/proc/mdstat</code> via la commande suivante:
</p>
<pre class="code">cat /proc/mdstat</pre>

<p>
ou mieux : 
</p>
<pre class="code">watch -n 10 cat /proc/mdstat</pre>

<p>
qui affiche l&#039;état de la construction toutes les 10 secondes (à interrompre sans danger par un Ctrl-C).
</p>

<p>
Lorsque la construction est en cours, vous obtenez quelques lignes ressemblant à ceci :
</p>
<pre class="code">Personalities : [raid1]
md0 : active raid1 sdb3[0] sda3[1]
      76670144 blocks [2/2] [UU]
      [=================&gt;...]  resync = 88.9% (68220800/76670144) finish=4.3min speed=32422K/sec
unused devices: &lt;none&gt;</pre>

<p>
Lorsque la construction est terminée, vous obtenez quelques lignes ressemblant à cela :
</p>
<pre class="code">Personalities : [raid1]
md0 : active raid1 sdb3[0] sda3[1]
      76670144 blocks [2/2] [UU]

unused devices: &lt;none&gt;</pre>

<p>
<del>Je me répète mais c&#039;est important : <strong>SURTOUT, NE REDEMARRER PAS LA MACHINE TANT QUE LA CONSTRUCTION N&#039;EST PAS FINIE !!!</strong>.</del>
</p>

</div>

<h5 id="quelques_explications1">Quelques explications</h5>
<div class="level5">

<p>
Cette phase de construction prend un certain temps mais rassurez-vous, elle ne se produit que lorsque vous installez le RAID pour la première fois, ou que vous avez subi une avarie et que vous remettez votre système à la normale.
</p>

<p>
<del>Si vous redémarrez la machine alors que le système RAID n&#039;est pas cohérent, le noyau ne saura pas déterminer quel est le disque qui contient les données valables et quel est le disque qui était en train d&#039;être reconstruit. Dès lors, le noyau se retrouve face à deux disques sans savoir lequel est valide… Ce qui est relativement problématique.</del>
</p>

<p>
En RAID 1, chaque disque physique a un numéro d&#039;ordre et un status, le système sait donc toujours ce qu&#039;il est nécessaire de mettre à jour, même en cas de reboot. Les super-blocs récents (version 1.2) permettent même de marquer quelles parties du disque ne sont pas synchronisées.
</p>

<p>
En RAID 5, il est possible que le système ne sache pas quels sont les données à utiliser dans le cas où la matrice est désynchronisée ET est en mode dégradé (il manque un disque); il faut alors forcer la construction de la matrice pour pouvoir reprendre la synchronisation, avec le risque que quelques blocs contiennent des données obsolètes ou pire, aléatoires (il faut alors faire un fsck sur le système).
</p>

</div>
<!-- EDIT6 SECTION "Premier démarrage" [9293-11971] -->
<h3 class="sectionedit7" id="duplication_du_boot">Duplication du boot</h3>
<div class="level3">

<p>
<strong>Remarque :</strong> Si vous avez configuré GRUB ou LILO pour un démarrage direct sur <code>/dev/mdX</code>, il n&#039;est pas nécessaire de dupliquer le boot. (voir notes en fin d&#039;article)
</p>

<p>
Maintenant que la construction du RAID-1 est terminée, vous possédez deux disques partitionnés de manière identique. Cependant, un seul des disques contient une partition <code>/boot</code> (qui permet donc le démarrage du système) et une partition <code>swap</code> (pas indispensable mais utile de temps à autre). Le second disque possède juste une partition RAID-1.
</p>

<p>
Dans l&#039;état actuel des choses, cela signifie que si votre premier disque tombe en panne, vous ne savez pas démarrer sur le second. Ce qui pose problème car le but de cet article est d&#039;avoir un système qui peut démarrer <em>surtout</em> si un des deux disques flanche.
</p>

<p>
Pour faire cela, nous devons configurer une partition <code>/boot</code> avec les <strong>mêmes informations que le premier disque</strong> ainsi qu&#039;une partition <code>swap</code> qui sera utilisée lorsqu&#039;on démarrera sur le disque &quot;de réserve&quot;. Les utilisations des partitions n&#039;ont pas été définie lors de l&#039;installation pour éviter que le fichier <code>fstab</code> soit configuré comme connaissant 2 partitions supplémentaires.
</p>

</div>

<h4 id="preparation_des_partitions_et_formatage">Préparation des partitions et formatage</h4>
<div class="level4">

<p>
Voici comment nous allons préparer ces deux partitions non-RAID afin que notre système puisse quand même démarrer sans le premier disque.
</p>

<p>
Pour ce faire, nous allons lancer <code>fdisk</code> afin d&#039;examiner les partitions de notre second disque (dans mon cas <code>sdb</code>) :
</p>
<pre class="code">sudo fdisk -l</pre>

<p>
Cette commande va nous indiquer quelque chose de similaire à ce qui suit :
</p>
<pre class="code">Disk /dev/sda: 80.0 GB, 80026361856 bytes
255 heads, 63 sectors/track, 9729 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes

   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *           1          62      497983+  83  Linux
/dev/sda2              63         184      979965   82  Linux swap / Solaris
/dev/sda3             185        9729    76670212+  fd  Linux raid autodetect

Disk /dev/sdb: 80.0 GB, 80026361856 bytes
255 heads, 63 sectors/track, 9729 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1   *           1          62      497983+  83  Linux
/dev/sdb2              63         184      979965   83  Linux
/dev/sdb3             185        9729    76670212+  fd  Linux raid autodetect

Disk /dev/md0: 78.5 GB, 78510227456 bytes
2 heads, 4 sectors/track, 19167536 cylinders
Units = cylinders of 8 * 512 = 4096 bytes

Disk /dev/md0 doesn&#039;t contain a valid partition table</pre>

<p>
Vous remarquerez que <code>sdb2</code>, notre future partition <code>swap</code> de secours n&#039;est pas reconnue en tant que telle comme une <code>swap</code>. Pour ce faire, nous devons légèrement modifier la table de partition de <code>/dev/sdb2</code>. Pour ce faire, introduisez la commande suivante :
</p>
<pre class="code">sudo fdisk /dev/sdb</pre>

<p>
Ensuite, vous demandez de changer le code d&#039;identification de la partition en entrant la commande <code>t</code> (pour <code>toggle</code>), ensuite le numéro de partition <code>2</code> (dans mon cas) et enfin, le code d&#039;identification <code>82</code> qui signifie qu&#039;il s&#039;agit d&#039;une partition <code>swap</code>.
</p>

<p>
Enfin, entrez la commande <code>w</code> (pour <code>write</code>) afin d&#039;écrire la table de partition définitivement sur le disque.
</p>

<p>
Il nous reste plus qu&#039;à formater les partitions, pour la partition <code>/boot</code> de réserve, nous introduisons la commande suivante (dans mon cas) :
</p>
<pre class="code">sudo mkfs.ext3 /dev/sdb1</pre>

<p>
Et pour formater la partition <code>swap</code>, il vous suffit d&#039;introduire la commande suivante (dans mon cas) :
</p>
<pre class="code">sudo mkswap /dev/sdb2</pre>

<p>
Redémarrez la machine pour que tout soit propre (en ligne de commande : <code>sudo reboot</code>).
</p>

</div>

<h4 id="copie_des_informations_de_boot">Copie des informations de boot</h4>
<div class="level4">

<p>
<strong>Remarque :</strong> Si vous avez configuré GRUB ou LILO pour un démarrage direct sur <code>/dev/mdX</code>, il n&#039;est pas nécessaire de dupliquer le boot. (voir notes en fin d&#039;article)
</p>

<p>
Une fois le démarrage effectué, il ne vous reste plus qu&#039;à copier les données boot du premier disque vers le deuxième. C&#039;est cette procédure qu&#039;il faut suivre si vous effectuer une modification de GRUB ou du Kernel (en fait, <strong>vous devez mettre à jour les partitions /boot à chaque fois qu&#039;elle est modifiée !!!</strong>).
</p>

<p>
Pour ce faire, c&#039;est très simple. Si ce n&#039;est pas fait, créer un répertoire <code>/boot2</code> via la commande suivante :
</p>
<pre class="code">sudo mkdir /boot2</pre>

<p>
Montez la partition <code>/boot</code> du second disque avec la commande qui suit (dans mon cas) :
</p>
<pre class="code">sudo mount /dev/sdb1 /boot2</pre>

<p>
Copiez l&#039;intégralité des fichiers de la partition <code>/boot</code> avec la commande suivante :
</p>
<pre class="code">sudo cp -Rf /boot/* /boot2/</pre>

<p>
Il ne vous reste plus qu&#039;à démonter la partition <code>/boot</code> de réserve (qui est actuellement montée en <code>/boot2</code>) : 
</p>
<pre class="code">sudo umount /boot2</pre>

<p>
Maintenant, vous devez configurer Grub2 pour le deuxième disque (il faut bien pouvoir démarrer si le sda crash).
Tapez :
</p>
<pre class="code">sudo umount /boot</pre>

<p>
Montez alors le deuxième disque à la place :
</p>
<pre class="code">sudo mount /dev/sdb1 /boot</pre>

<p>
Configurez Grub2 :
</p>
<pre class="code">sudo dpkg-reconfigure grub-pc</pre>

<p>
Faites ok et ok (rien à changer jusque là). Ensuite vient le choix entre sda1 et sdb1. Décochez alors sda1 pour cocher sdb1. Puis faites ok. Votre ordinateur est maintenant prêt à démarrer avec le deuxième disque. Redémarrez pour constater par vous même en choississant votre disque au démarrage Bios à l&#039;aide de &quot;F8&quot;.
</p>

<p>
Votre système est maintenant prêt à subir une panne de disque dur.
</p>

</div>
<!-- EDIT7 SECTION "Duplication du boot" [11972-17606] -->
<h3 class="sectionedit8" id="installer_un_raid1_en_mode_terminal_a_la_main">Installer un RAID1 en mode terminal &quot;à la main&quot;</h3>
<div class="level3">

<p>
Exécuter le terminal <code>Applications → Accessoires → terminal</code>
Puis passer en root (Plus simple)
</p>
<pre class="code">sudo -i</pre>

<p>
On part du principe que vous avez installé 2 disques durs identiques comme moi de 500 Go. (sdb et sdc) comme il sont gros nous allons faire 2 partitions.
</p>
<pre class="code">fdisk /dev/sdb</pre>

<p>
créer une partition principale donc <code>n</code> puis <code>p</code> puis <code>1</code> de 1 à 25000
créer une autre partition pricipale  donc <code>n</code> puis <code>p</code> puis <code>2</code> de 25001 à la fin du disque.
</p>

<p>
Cela donne ceci :
</p>
<pre class="code">Commande (m pour l&#039;aide): p

Disque /dev/sdb: 500.1 Go, 500107862016 octets
255 têtes, 63 secteurs/piste, 60801 cylindres
Unités = cylindres de 16065 * 512 = 8225280 octets

Périphérique Amorce    Début         Fin      Blocs    Id  Système
/dev/sdb1               1       24316   195318238+  83  Linux
/dev/sdb2           24317       60801   293065762+  83  Linux</pre>

<p>
maintenant il faut installer le flag sur les deux partitions donc <code>t</code> puis <code>1</code> puis <code>fd</code> idem sur la deuxième partition donc <code>t</code> puis <code>2</code> puis <code>fd</code> cela va donner ceci :
</p>
<pre class="code">Commande (m pour l&#039;aide): p

Disque /dev/sdb: 500.1 Go, 500107862016 octets
255 têtes, 63 secteurs/piste, 60801 cylindres
Unités = cylindres de 16065 * 512 = 8225280 octets

Périphérique Amorce    Début         Fin      Blocs    Id  Système
/dev/sdb1               1       24316   195318238+  fd  Linux raid autodetect
/dev/sdb2           24317       60801   293065762+  fd  Linux raid autodetect</pre>

<p>
sauver les modifications <code>w</code> et puis faire exactement la même chose sur le second disque <code>/dev/sdc</code>
</p>

<p>
Après, formater les 4 partitions (je ne sais pas si c&#039;est utile, mais bon) ;
</p>

<p>
<p><div class="notetip">Non, ce n&#039;est pas utile
</div></p>
</p>
<pre class="code">mkfs.ext3 /dev/sdb1; mkfs.ext3 /dev/sdb2; mkfs.ext3 /dev/sdc1; mkfs.ext3 /dev/sdc2</pre>

<p>
C&#039;est un peu long…
</p>

<p>
Maintenant, créer deux nouveaux devices
</p>
<pre class="code">mknod /dev/md0 b 9 0
mknod /dev/md1 b 9 1</pre>

<p>
c&#039;est à ce stade que nous avons besoin de mdadm (donc installez-le)
</p>
<pre class="code">apt-get install mdadm</pre>

<p>
C&#039;est presque fini. Enfin, là, ça va prendre beaucoup de temps mais c&#039;est le plus simple : Il suffit de créer les deux volumes raid en raid1 et taper <code>y</code> à la question 
</p>
<pre class="code">mdadm --create --metadata=0.90 --verbose /dev/md0 --level=raid1 --raid-devices=2 /dev/sdb1 /dev/sdc1
mdadm --create --verbose /dev/md1 --level=raid1 --raid-devices=2 /dev/sdb2 /dev/sdc2</pre>

<p>
<p><div class="noteimportant">Le –metadata=0.90 est nécessaire pour pouvoir booter sur /dev/md0 !
</div></p>
</p>

<p>
ça affiche ceci
</p>
<pre class="code"> mdadm --create --verbose /dev/md1 --level=raid1 --raid-devices=2 /dev/sdb2 /dev/sdc2
mdadm: /dev/sdb2 appears to contain an ext2fs file system
    size=293065760K  mtime=Thu Jan  1 01:00:00 1970
mdadm: /dev/sdc2 appears to contain an ext2fs file system
    size=293065760K  mtime=Thu Jan  1 01:00:00 1970
mdadm: size set to 293065664K
Continue creating array? y
mdadm: array /dev/md1 started.</pre>

<p>
On peut contrôler tout de suite avec 
</p>
<pre class="code">mdadm --detail -scan</pre>

<p>
ce qui doit afficher ceci
</p>
<pre class="code">ARRAY /dev/md0 level=raid1 num-devices=2 UID=b0be37d4:54202dc1:0e9efb29:244465d1
ARRAY /dev/md1 level=raid1 num-devices=2 UID=17538a36:6bce6973:73fafbc4:d6a357b0</pre>

<p>
<p><div class="noteimportant">à partir de la version 11.04, ubuntu peut assigner la grappe sous le périphérique md127 lors du démarrage de l&#039;ordinateur. Pour éviter cela, il faut enregistrez la grappe
</div></p>
</p>
<pre class="code">mdadm -Es | grep md/0  &gt;&gt;/etc/mdadm/mdadm.conf
mdadm -Es | grep md/1  &gt;&gt;/etc/mdadm/mdadm.conf</pre>

<p>
initramfs doit contenir le fichier de configuration mdadm.conf durant le démarrage de l&#039;ordinateur donc on le met à jour :
</p>
<pre class="code">sudo update-initramfs -u</pre>

<p>
Maintenant vous devez attendre la construction du raid. Vous pouvez voir le détail de l&#039;avancement comme ceci :
</p>
<pre class="code">mdadm --detail /dev/md0</pre>

<p>
ça affiche ceci :
</p>
<pre class="code">/dev/md0:
        Version : 00.90.03
  Creation Time : Tue Dec 18 12:36:06 2007
     Raid Level : raid1
     Array Size : 195318144 (186.27 GiB 200.01 GB)
    Device Size : 195318144 (186.27 GiB 200.01 GB)
   Raid Devices : 2
  Total Devices : 2
Preferred Minor : 0
    Persistence : Superblock is persistent

    Update Time : Tue Dec 18 12:36:06 2007
          State : clean, resyncing
 Active Devices : 2
Working Devices : 2
 Failed Devices : 0
  Spare Devices : 0

 Rebuild Status : 44% complete

           UUID : b0be37d4:54202dc1:0e9efb29:244465d1
         Events : 0.1

    Number   Major   Minor   RaidDevice State
       0       8       17        0      active sync   /dev/sdb1
       1       8       33        1      active sync   /dev/sdc1</pre>

<p>
Là il est a 44%. Il parait que l&#039;on peut le formater pendant la création du raid mais j&#039;attendrais avant de lancer la commande de formatage. Il ne faut absolument pas interrompre la création du raid. Il n&#039;y a plus qu&#039;a monter les volumes ou vous voulez. Par exemple :
</p>
<pre class="code">mount /dev/md0 /home/ftp
mount /dev/md1 /home/samba</pre>

<p>
Pour le reste suivre les procédures habituelles voir l&#039;utilisation de mount et de fstab.
</p>

</div>
<!-- EDIT8 SECTION "Installer un RAID1 en mode terminal à la main" [17607-22759] -->
<h2 class="sectionedit9" id="utilisation_du_systeme_raid-1_logiciel">Utilisation du système RAID-1 logiciel</h2>
<div class="level2">

</div>
<!-- EDIT9 SECTION "Utilisation du système RAID-1 logiciel" [22760-22812] -->
<h3 class="sectionedit10" id="comment_obtenir_des_informations_sur_le_statut_du_raid">Comment obtenir des informations sur le statut du RAID ?</h3>
<div class="level3">

<p>
Pour obtenir des informations sur le statut du RAID, vous pouvez le faire soit de manière non détaillée avec la commande suivante :
</p>
<pre class="code">cat /proc/mdstat</pre>

<p>
Et vous obtenez une sortie de la sorte :
</p>
<pre class="code">Personalities : [raid1]
md0 : active raid1 sdb3[0] sda3[1]
      76670144 blocks [2/2] [UU]

unused devices: &lt;none&gt;</pre>

<p>
Pour obtenir les RAID existant dans le système : 
</p>
<pre class="code">sudo mdadm --detail -scan</pre>

<p>
Qui génère ceci chez moi :
</p>
<pre class="code">ARRAY /dev/md0 level=raid1 num-devices=2 UUID=48b74990:15f454d9:93947193:76d9ea46
   devices=/dev/sdb3,/dev/sda3</pre>

<p>
Ou alors, vous pouvez demander des informations beaucoup plus détaillée via la commande suivante (chez moi le RAID est sur la device <code>/dev/md0</code>) :
</p>
<pre class="code">sudo mdadm --detail /dev/md0</pre>

<p>
Avec cette commande, vous savez tout <img src="../../../lib/images/smileys/icon_wink.gif" class="icon" alt=";-)" /> :
</p>
<pre class="code">/dev/md0:
        Version : 00.90.01
  Creation Time : Wed Aug 31 09:38:34 2005
     Raid Level : raid1
     Array Size : 76670144 (73.12 GiB 78.51 GB)
    Device Size : 76670144 (73.12 GiB 78.51 GB)
   Raid Devices : 2
  Total Devices : 2
Preferred Minor : 0
    Persistence : Superblock is persistent

    Update Time : Fri Sep  9 10:50:48 2005
          State : active
 Active Devices : 2
Working Devices : 2
 Failed Devices : 0
  Spare Devices : 0

           UUID : 48b74990:15f454d9:93947193:76d9ea46
         Events : 0.60924

    Number   Major   Minor   RaidDevice State
       0       8       19        0      active sync   /dev/sdb3
       1       8        3        1      active sync   /dev/sda3</pre>

</div>
<!-- EDIT10 SECTION "Comment obtenir des informations sur le statut du RAID ?" [22813-24437] -->
<h3 class="sectionedit11" id="comment_invalider_un_disque">Comment invalider un disque ?</h3>
<div class="level3">

<p>
Quand un disque à l&#039;air de poser problème (ou qu&#039;il pose réellemment problème), il est de bonne pratique de l&#039;invalider le temps que l&#039;on puisse le retirer physiquement. 
</p>

<p>
Par exemple, si votre disque tombe en panne et que vous ne pouvez pas arrêter le serveur tout de suite, vous allez être inondé de messages d&#039;erreurs et le système sera plus lent. Dans ce cas, vous l&#039;invalidez le temps de pouvoir arrêter le serveur pour effectuer le remplacement physique (à moins d&#039;avoir l&#039;HotPlug bien entendu).
</p>

<p>
Pour marquer le disque comme étant invalide (ou <code>faulty</code>), on introduit la commande suivante (ici, j&#039;invalide la partition <code>/dev/sdb3</code> de l&#039;array RAID <code>/dev/md0</code>) :
</p>
<pre class="code">sudo mdadm /dev/md0 -f /dev/sdb3</pre>

</div>
<!-- EDIT11 SECTION "Comment invalider un disque ?" [24438-25216] -->
<h3 class="sectionedit12" id="comment_demarrer_en_cas_de_panne_d_un_des_disques">Comment démarrer en cas de panne d&#039;un des disques ?</h3>
<div class="level3">

<p>
J&#039;ai effectué plusieurs tests dans le cas où un disque viendrait à tomber en panne. Ces tests ont été effectués sur le serveur ci-dessus avec le fake-RAID. Si vous n&#039;avez pas de contrôleur, il y a certaines choses qui doivent être effectuées.
</p>

</div>

<h4 id="sans_controleur">Sans contrôleur</h4>
<div class="level4">

<p>
Voici une solution qui fonctionne :  
</p>
<pre class="code">   
*invoquer le shell grub : 
grub&gt;
* Dans le shell de grub exécuter: 

#Ecrire le MBR de /dev/sda
root (hd0,0)
setup (hd0)
#Ecrire le MBR de /dev/sdb
device (hd0) /dev/sdb
root (hd0,0)
setup (hd0)</pre>

<p>
Grâce à l&#039;écriture dans le MBR des deux disques, ils démarrent l&#039;un sans l&#039;autre.
J&#039;ai simulé tour à tour la panne de sdb puis de sda, sans problème, il faut simplement taper ctrl+D pour continuer le lancement quand on vous le demande.
</p>

</div>

<h4 id="avec_controleur_fake-raid">Avec contrôleur fake-RAID</h4>
<div class="level4">

<p>
C&#039;est le charme du contrôleur fake-RAID, il n&#039;y a rien à faire <img src="../../../lib/images/smileys/icon_wink.gif" class="icon" alt=";-)" />.
</p>

<p>
En fait, votre Linux est configuré pour travailler sur le disque <code>sda</code>, ce qui signifie que vous trouverez uniquement des allusions à <code>sda</code> dans les fichiers de configuration (comme <code>fstab</code> par exemple). Le disque <code>sdb</code> sert juste de réserve. 
</p>

<p>
Si vous retirez le disque <code>sda</code>, le contrôleur montrera au système que le disque <code>sdb</code> devient le <code>sda</code> et dès lors, tous vos fichiers de configuration se rapporteront au bon <code>device</code>.
</p>

</div>
<!-- EDIT12 SECTION "Comment démarrer en cas de panne d'un des disques ?" [25217-26617] -->
<h3 class="sectionedit13" id="comment_remplacer_le_disque_defectueux_et_reactiver_le_raid">Comment remplacer le disque défectueux et réactiver le RAID ?</h3>
<div class="level3">

<p>
Pour remplacer un disque défectueux, vous devez retirer le disque, en placer un nouveau et le partitionner de la même manière que celui qui est tombé en panne (<strong>c&#039;est pour cette raison qu&#039;il faut noter les différentes tailles de partitions utilisées</strong>).
</p>

<p>
Ensuite, vous indiquez correctement les identifications des partitions (<code>Linux</code>, <code>swap</code> et <code>raid</code> dans mon cas) avec <code>fdisk</code>. Vous suivez la procédure décrite ci-dessus <em>Copie des informations de boot</em> et enfin, vous ajoutez la partition RAID à l&#039;array dégradé (le RAID auquel il manque un disque) via la commande suivante (dans mon cas) :
</p>
<pre class="code">sudo mdadm /dev/md0 -a /dev/sdb3</pre>

<p>
<strong>Attention :</strong> la reconstruction du système RAID commence. Veillez à ne pas éteindre ou redémarrer la machine tant que ce n&#039;est pas fini. (pour savoir quand c&#039;est fini et le pourquoi, relisez la section <em>Premier démarrage</em> ci-dessus.
</p>

<p>
Une fois la reconstruction finie, votre système est comme neuf.
</p>

</div>
<!-- EDIT13 SECTION "Comment remplacer le disque défectueux et réactiver le RAID ?" [26618-27668] -->
<h2 class="sectionedit14" id="agrandir_un_systeme_raid-1_logiciel">Agrandir un système RAID-1 logiciel</h2>
<div class="level2">

<p>
Le principe même d&#039;un RAID-1 est particulièrement gourmant en espace disque: pour deux disques de capacité égales, vous ne disposerez que de la capacité d&#039;un seul.
</p>

<p>
Il est donc très probable que vous en arriviez à vouloir agrandir l&#039;espace disponible:
</p>
<ul>
<li class="level1"><div class="li"> Soit en ajoutant de nouveaux disques</div>
</li>
<li class="level1"><div class="li"> Soit en remplaçant les disques existants par des disques de plus grande capacité</div>
</li>
</ul>

</div>
<!-- EDIT14 SECTION "Agrandir un système RAID-1 logiciel" [27669-28105] -->
<h3 class="sectionedit15" id="ajout_de_nouveaux_disques">Ajout de nouveaux disques</h3>
<div class="level3">

<p>
Dans un RAID-1, l&#039;information est recopiée sur l&#039;ensemble des disques contenus dans chaque système, cette copie a un coût en terme de performance. A moins que vous ayez vraiment très peu de confiance dans vos disques, il est souvent superflu d&#039;utiliser du mirroring sur plus de deux disques. 
</p>

<p>
Dans tous les cas, ajouter des disques à un système RAID-1 existant n&#039;augmentera pas l&#039;espace disponible mais la fiabilité de votre stockage. 
Ainsi pour augmenter la capacité d&#039;un système en RAID-1 en ajoutant des disques, cela revient à créer de nouveaux points de montage ou a recourir aux partitions logiques (LVM).
</p>

<p>
En effet, si votre périphérique RAID est le support de partition logique, il est en fait vu comme un PV (ou physical volume) au sein d&#039;un VG (Virtual Group) et dans ce VG vous avez défini des LV (Logical Volume). Ajouter des disques reviens à ajouter des PV au VG actuel puis à étendre vos partitions logiques. De cette manière vous aurez agrandis l&#039;espace disponible sur vos partitions existantes.
</p>

<p>
<p><div class="noteimportant">
Si vous ajoutez à votre VG comportant des PV en RAID1, des PV qui ne sont pas en RAID1, vous fragilisez votre stockage et le premier RAID1 devient inutile. 
</p>

<p>
En cas de défaillance d&#039;un Physical Volume vous perdez les informations contenues dans le Volume Group. Il n&#039;y a donc aucun sens d&#039;ajouter un périphérique RAID0 (dont la fiabilité est faible) à un VG contenant des périphériques en RAID1 (beaucoup plus robustes mais plus couteux).

</div></p>
</p>

</div>
<!-- EDIT15 SECTION "Ajout de nouveaux disques" [28106-29647] -->
<h3 class="sectionedit16" id="remplacement_des_disques_existants">Remplacement des disques existants</h3>
<div class="level3">

<p>
Tout d&#039;abord on vérifie que le sytème actuel n&#039;est pas en défaut et que les deux disques sont correctement synchronisés:
</p>
<pre class="code">$sudo cat /proc/mdstat
Personalities : [raid1] 
md1 : active raid1 sdb2[0] sda2[1]
  312440064 blocks [2/2] [UU]
      
md0 : active raid1 sdb1[0] sda1[1]
  128384 blocks [2/2] [UU]
      
unused devices: &lt;none&gt;</pre>

<p>
<p><div class="noteclassic"> Ici chaque disque possède une partition de boot d&#039;une centaine de Mo et une partition avec le reste de l&#039;espace utilisable.
</p>
<ul>
<li class="level1"><div class="li"> La première partition de chacun des deux disques est attribué à un md0 qui sert de /boot.</div>
</li>
<li class="level1"><div class="li"> La seconde partition de chacun des deux disques est attribué à un md1 qui sert de support pour LVM (md1 est un PV).</div>
</li>
</ul>

<p>

</div></p>
On va ensuite vérifier que chacune des partition de /boot est bien bootable:
</p>
<pre class="code">fdisk /dev/sda

WARNING: DOS-compatible mode is deprecated. It&#039;s strongly recommended to
         switch off the mode (command &#039;c&#039;) and change display units to
         sectors (command &#039;u&#039;).

Command (m for help): p

Disk /dev/sda: 2000.4 GB, 2000398934016 bytes
255 heads, 63 sectors/track, 243201 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x494ca524

   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *           1          16      128488+  fd  Linux raid autodetect
/dev/sda2              17      19452   156151800   fd  Linux raid autodetect</pre>

<p>
Il y a bien une étoile dans la colonne &quot;Boot&quot; en face de /dev/sda1.
</p>

<p>
On répète l&#039;opération avec /dev/sdb.
</p>

<p>
Si tout est bon, on peut arrêter la machine afin de procéder au premier échange.
<p><div class="noteclassic"> En théorie les disques sata peuvent être connectés et déconnectés à chaud (sans éteindre la machine), personnellement je ne m&#039;y risque pas.
</div></p>
</p>

<p>
On redémarre ensuite, il est possible qu&#039;au cours du démarrage le démon mdadm qui gère le RAID vous dise que le RAID1 est endommagé et vous demande si vous souhaitez quand même continuer à utiliser la machine, c&#039;est normal puisque vous avez volontairement retiré un disque.
</p>

<p>
Vous pouvez vérifier l&#039;état du RAID avec la commande 
</p>
<pre class="code">cat /proc/mdstat

Personalities : [raid1] 
md1 : active raid1 sda2[1]
      312440064 blocks [2/1] [_U]
      
md0 : active raid1 sda1[1]
      128384 blocks [2/1] [_U]
</pre>

<p>
Il y a donc un seul volume de disponible sur les deux qui le compose.
</p>

<p>
Un fois le système démarré, on partitionne le nouveau disque de manière à avoir :
</p>
<ul>
<li class="level1"><div class="li"> la partition /boot de la même taille que l&#039;ancienne (pas besoin de davantage) et bootable</div>
</li>
<li class="level1"><div class="li"> l&#039;autre partition aussi grande que possible</div>
</li>
</ul>
<pre class="code">fdisk /dev/sdb
Device contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel
Building a new DOS disklabel with disk identifier 0x1c8e53bb.
Changes will remain in memory only, until you decide to write them.
After that, of course, the previous content won&#039;t be recoverable.

Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)

WARNING: DOS-compatible mode is deprecated. It&#039;s strongly recommended to
         switch off the mode (command &#039;c&#039;) and change display units to
         sectors (command &#039;u&#039;).

Command (m for help): p

Disk /dev/sdb: 2000.4 GB, 2000398934016 bytes
255 heads, 63 sectors/track, 243201 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x1c8e53bb

   Device Boot      Start         End      Blocks   Id  System

Command (m for help): n
Command action
   e   extended
   p   primary partition (1-4)
p
Partition number (1-4): 1
First cylinder (1-243201, default 1): 
Using default value 1
Last cylinder, +cylinders or +size{K,M,G} (1-243201, default 243201): 16

Command (m for help): n
Command action
   e   extended
   p   primary partition (1-4)
p
Partition number (1-4): 2
First cylinder (17-243201, default 17): 
Using default value 17
Last cylinder, +cylinders or +size{K,M,G} (17-243201, default 243201): 
Using default value 243201

Command (m for help): a
Partition number (1-4): 1

Command (m for help): p

Disk /dev/sdb: 2000.4 GB, 2000398934016 bytes
255 heads, 63 sectors/track, 243201 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x1c8e53bb

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1   *           1          16      128488+  83  Linux
/dev/sdb2              17      243201  1953383512+  83  Linux

Command (m for help): t
Partition number (1-4): 1
Hex code (type L to list codes): fd
Changed system type of partition 1 to fd (Linux raid autodetect)

Command (m for help): t
Partition number (1-4): 2
Hex code (type L to list codes): fd
Changed system type of partition 2 to fd (Linux raid autodetect)

Command (m for help): p

Disk /dev/sdb: 2000.4 GB, 2000398934016 bytes
255 heads, 63 sectors/track, 243201 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x1c8e53bb

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1   *           1          16      128488+  fd  Linux raid autodetect
/dev/sdb2              17      243201  1953383512+  fd  Linux raid autodetect

Command (m for help): w
The partition table has been altered!

Calling ioctl() to re-read partition table.
Syncing disks.</pre>

<p>
Ensuite, il suffit de rajouter les partitions aux volumes RAID-1:
</p>
<pre class="code">sudo mdadm /dev/md0 --add /dev/sdb1</pre>

<p>
et
</p>
<pre class="code">sudo mdadm /dev/md1 --add /dev/sdb2</pre>

<p>
La reconstruction commence immédiatement, elle est très rapide pour md0, le volume étant très faible, un peu plus longue pour md1 (le temps qu&#039;il recopie toutes les informations octets par octets d&#039;un disque sur l&#039;autre.
</p>
<pre class="code">cat /proc/mdstat 
Personalities : [raid1] 
md1 : active raid1 sdb2[2] sda2[1]
      312440064 blocks [2/1] [_U]
      [=&gt;...................]  recovery =  5.9% (18516224/312440064) finish=52.4min speed=93437K/sec
      
md0 : active raid1 sdb1[0] sda1[1]
      128384 blocks [2/2] [UU]
      
unused devices: &lt;none&gt;</pre>

<p>
Une fois la reconstruction finie, il faut renouveler l&#039;opération en remplaçant le second disque.
<p><div class="notehelp">
Il est possible que le grub vous joue des tours (une partie se trouve sur le MBR qui n&#039;est pas recopié lors de la reconstruction). Je vous engage à vous renseigner selon le grub que vous utilisez et à garder vos anciens disques intacts tant que les nouveaux ne sont pas pleinement fonctionnels.

</div></p>
</p>

<p>
Lorsque la synchro est terminée avec vos deux nouveaux disques en place, vous pouvez alors augmenter la taille des volumes en partant du plus bas (plus proche de la couche physique) jusqu&#039;à celui qui est le plus éloigné de la couche physique, en ce qui me concerne c&#039;est à dire:
</p>
<ol>
<li class="level1"><div class="li"> Redimensionnement du md <pre class="code">mdadm -G /dev/md1 -z max
mdadm: component size of /dev/md1 has been set to 1953383424K</pre>
</div>
</li>
<li class="level1"><div class="li"> Redimensionnement du pv <pre class="code"> pvresize /dev/md1</pre>
</div>
</li>
<li class="level1"><div class="li"> Redimensionnement d&#039;une partition logique (LV) <pre class="code"> lvextend -L +800 /dev/mynew_vg/vol01 </pre>
</div>
</li>
<li class="level1"><div class="li"> Redimensionnement du système de fichier sur la partition logique en question: <pre class="code">resize2fs  /dev/mynew_vg/vol01 </pre>
</div>
</li>
</ol>

</div>
<!-- EDIT16 SECTION "Remplacement des disques existants" [29648-37175] -->
<h2 class="sectionedit17" id="notes">Notes</h2>
<div class="level2">

</div>
<!-- EDIT17 SECTION "Notes" [37176-37194] -->
<h3 class="sectionedit18" id="concernant_les_fake-raid">Concernant les fake-RAID</h3>
<div class="level3">

<p>
La plupart des contrôleurs RAID ATA (ou <abbr title="Serial Advanced Technology Attachment">SATA</abbr>) (à l&#039;exception de 3Ware Escalade, Adaptec 24x0, Areca, HP/Compaq, IBM ServeRAID, Intel SRC*/ICP Vortex, LSI Logic MegaRAID 150-4/150-6 et Tekram) ne sont pas des RAID réellement hardware mais ce sont plutôt des RAID software ou des fake-RAID dépendant du <abbr title="Basic Input-Output System">BIOS</abbr>. Les fonctionnalités matérielles manquantes sont traditionnellement émulés de manière particulière, non documentée et avec des pilotes propriétaires pour pouvoir sortir du matériel à des prix compétitifs.
</p>

<p>
Les fake-RAID sont difficiles à supporter sous Linux. En effet, le reverse-engineering est difficile, les pilotes sont propriétaires et particuliers et il y a peu de coopération avec les constructeurs.
</p>

<p>
Le plus souvent, <strong>Linux est incapable de lire des volumes fake-RAID existants</strong> avec ce type de contrôleur; <strong>à moins que</strong> vous n&#039;utilisiez les pilotes fake-RAID propriétaire (quand ils existent…). A moins de vouloir avoir un dual-boot avec MS-Windows, vous ne devez pas vous soucier de ces pilotes. Car le RAID logiciel (software) Linux (le pilote <code>md</code> du noyau) est <em class="u">plus rapide et plus fiable</em>. (vous trouverez une série de tests comparatifs reproductibles sur cette page : <a href="http://spamaps.org/raidtests.php" class="urlextern" title="http://spamaps.org/raidtests.php"  rel="nofollow">http://spamaps.org/raidtests.php</a>)
</p>

<p>
Vous serez donc bien avisé de fuir les volumes fake-RAID, d&#039;utiliser vos disques <abbr title="Serial Advanced Technology Attachment">SATA</abbr> comme des périphériques blocs et d&#039;activer le RAID software Linux durant l&#039;installation <img src="../../../lib/images/smileys/icon_wink.gif" class="icon" alt=";-)" />.
</p>

<p>
<em>Remarque d&#039;un utilisateur:</em>
J&#039;ai fait l&#039;expérience sur mon poste de travail avec un contrôleur NVIDIA qui était géré par Linux en natif (Avec Ubuntu 8.10) et cela a fonctionné quelques temps. Puis le RAID 1 s&#039;est corrompu pour je ne sais quelle raison. J&#039;ai été dans l&#039;incapacité de récupérer le RAID 1. Donc depuis je gère mes partitions en RAID logiciel purement Linux et exit les RAIDs irrécupérables ;)
</p>

<p>
<strong>Remarque importante :</strong> La critique énoncée ci-dessus à propos des fake-RAID est justifiée mais il n&#039;en est pas moins vrai que les contrôleurs (même si il ne s&#039;occupe pas du RAID) sont très pratiques pour la séquence de boot lorsqu&#039;un disque tombe en panne. Voir la section ci-dessus : <em>Comment démarrer en cas de panne d&#039;un des disques ?</em>.
</p>

</div>
<!-- EDIT18 SECTION "Concernant les fake-RAID" [37195-39452] -->
<h3 class="sectionedit19" id="concernant_le_demarrage_avec_des_controleurs_promise">Concernant le démarrage avec des contrôleurs Promise</h3>
<div class="level3">

<p>
Lors de l&#039;installation d&#039;Ubuntu sur le serveur décrit ci-dessus, j&#039;ai été confronté à un problème peu ordinaire (enfin, c&#039;était la première fois que j&#039;ai rencontré un tel problème et qui plus est, n&#039;était pas documenté sur le web).
</p>

<p>
En fait, après plusieurs tentatives d&#039;installation infructueuse sur les disques <abbr title="Serial Advanced Technology Attachment">SATA</abbr> de ce serveur, j&#039;en suis arrivé à essayer de comprendre comment fonctionnait le contrôleur Promise. 
</p>

<p>
Le problème auquel j&#039;étais confronté était le suivant :
</p>
<ul>
<li class="level1"><div class="li"> Les deux disques sont connectés sur le contrôleur.</div>
</li>
<li class="level1"><div class="li"> Le contrôleur m&#039;indique à l&#039;écran que les disques sont en <code>1x2 mirror</code>.</div>
</li>
<li class="level1"><div class="li"> Je boote sur le CD d&#039;installation Ubuntu.</div>
</li>
<li class="level1"><div class="li"> Premier problème, Ubuntu détecte 2 disques et ne voit pas les disques comme un périphérique RAID.</div>
</li>
<li class="level1"><div class="li"> Je me dis &quot;Pas grave, j&#039;installe sur le premier et à priori, le second devrait avoir les mêmes données.&quot;</div>
</li>
<li class="level1"><div class="li"> J&#039;installes Ubuntu sur le premier disque.</div>
</li>
<li class="level1"><div class="li"> A la fin de l&#039;installation, je redémarre la machine et là j&#039;obtiens un message du style <code>No operating system</code>.</div>
</li>
</ul>

<p>
Après quelques recherches, j&#039;ai appris que les contrôleurs Promise de ce type ne sont pas des contrôleurs RAID hardware mais bien des <strong>fake-RAID</strong> (voir note ci-dessus à ce propos).
</p>

<p>
Je me dis, bon ok mais ça n&#039;explique pas que mon système ne boote pas (même lorsque je déconnecte physiquement le second disque).
</p>

<p>
Voici ce que j&#039;ai fait :
</p>
<ol>
<li class="level1"><div class="li"> J&#039;ai désactivé tous les arrays dans le <abbr title="Basic Input-Output System">BIOS</abbr> du contrôleur (CTRL+F au démarrage),</div>
</li>
<li class="level1"><div class="li"> j&#039;ai retiré physiquement le second disque</div>
</li>
<li class="level1"><div class="li"> et j&#039;ai installé Ubuntu sur le premier comme si de rien était.</div>
</li>
<li class="level1"><div class="li"> Ensuite, j&#039;ai reconnecté le second disque et j&#039;ai créé un nouvel array dans le <abbr title="Basic Input-Output System">BIOS</abbr> du contrôleur. <strong>Attention :</strong> lors de la création du nouvel array, j&#039;ai demandé au contrôleur de faire un <code>Create and duplicate</code>. A partir de ce moment, Ubuntu bootait (sans RAID mais le système démarrait).</div>
</li>
<li class="level1"><div class="li"> Enfin, j&#039;ai suivi la procédure expliquée dans cet article pour avoir du RAID-1.</div>
</li>
</ol>

<p>
Ma théorie concernant ce comportement pour le moins étrange…
</p>

<p>
Je pense que le MBR pour le RAID est stocké dans le contrôleur et non sur le disque. Etant donné qu&#039;on utilise pas les pilotes de Promise, le MBR (qui indique où booter) est inscrit uniquement sur le disque d&#039;installation et dès lors, il n&#039;est pas connu au niveau du contrôleur. En effectuant une duplication, le MBR Grub/Ubuntu inscrit sur le premier disque est copié sur le second <strong>et</strong> dans le contrôleur.
</p>

<p>
Cependant, lors de la mise à jour du kernel via apt-get, le reboot est impossible.
</p>

</div>
<!-- EDIT19 SECTION "Concernant le démarrage avec des contrôleurs Promise" [39453-42104] -->
<h3 class="sectionedit20" id="boot_directement_sur_la_partition_raid">Boot directement sur la partition RAID</h3>
<div class="level3">

<p>
Comme dit plus haut, on m&#039;a indiqué que GRUB et LILO sont capables de booter directement sur une device de type RAID software (/dev/mdX). Je n&#039;ai cependant pas eu l&#039;occasion d&#039;essayer la procédure. La machine qui est a ma disposition est maintenant en production. Je mettrai cette page à jour dès que possible.
</p>

<p>
Il s&#039;agit d&#039;un cas idylique, aucune modification n&#039;est à effectuer en cas de mise à jour du noyau.
</p>

</div>

<h5 id="avec_grub">Avec GRUB</h5>
<div class="level5">

<p>
Exécutez
</p>
<pre class="code">login@hostname:~$ sudo grub</pre>

<p>
Pour trouver où sont installés les fichiers de configuration du chargeur de démarrage GRUB du RAID 1 (Ici la partition est dédiée au boot donc elle est montée dans le répertoire /boot de la partition racine /, <em class="u">si les fichiers de boot sont directement sur la partition racine</em> / saisissez <strong>grub&gt;find /boot/grub/stage1</strong>):
</p>
<pre class="code">Grub&gt;find /grub/stage1
(hd0,0)
(hd1,0)</pre>

<p>
Si vos disques du RAID 1 sont <strong>/dev/sda</strong> et <strong>/dev/sdb</strong>.
Pour installer le chargeur de démarrage GRUB dans le <strong>MBR de /dev/sda</strong>: 
</p>
<pre class="code">Grub&gt;device (hd0) /dev/sda
Grub&gt;root (hd0,0)
Grub&gt;setup (hd0)</pre>

<p>
Pour installer le chargeur de démarrage GRUB dans le <strong>MBR de /dev/sdb</strong>:
</p>
<pre class="code">Grub&gt;device (hd0) /dev/sdb
Grub&gt;root (hd0,0)
Grub&gt;setup (hd0)</pre>

<p>
Éditez le fichier de configuration du chargeur de démarrage GRUB:
</p>
<pre class="code">login@hostname:~$ sudo nano /boot/grub/menu.lst</pre>

<p>
Modifiez la configuration du chargeur de démarrage GRUB pour une partition racine / sur le RAID 1 /dev/md1:
</p>
<pre class="code">title           Ubuntu n°version, kernel n°kernel-generic
root            (hd0,0)
kernel          /vmlinuz-n°kernel-generic root=/dev/md1 ro quiet splash
initrd          /initrd.img-n°kernel-generic
quiet</pre>

<p>
Mise à jour de la configuration du chargeur de démarrage GRUB
</p>
<pre class="code">login@hostname:~$  sudo update-grub</pre>

</div>

<h5 id="avec_lilo">Avec Lilo</h5>
<div class="level5">

<p>
Voici l&#039;état des partitions (pas comme décrite ci-dessus) et la configuration :
</p>
<pre class="code"># fdisk -l

Disk /dev/sda: 36.4 GB, 36401479680 bytes
255 heads, 63 sectors/track, 4425 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes

  Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *           1          13      104391   fd  Linux raid autodetect
/dev/sda2              14          17       32130   fd  Linux raid autodetect
/dev/sda3              18        4425    35407260   fd  Linux raid autodetect

Disk /dev/sdb: 36.4 GB, 36401479680 bytes
255 heads, 63 sectors/track, 4425 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes

  Device Boot      Start         End      Blocks   Id  System
/dev/sdb1   *           1          13      104391   fd  Linux raid autodetect
/dev/sdb2              14          17       32130   fd  Linux raid autodetect
/dev/sdb3              18        4425    35407260   fd  Linux raid autodetect

# cat /etc/lilo.conf

disk=/dev/md0
partition=/dev/md1
map=/boot/map
prompt
delay=20
timeout=20
vga=normal
default=Linux

image=/boot/vmlinuz
       root=/dev/md0
       label=Linux
       read-only


# df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/md0               99M   19M   75M  20% /
tmpfs                1013M     0 1013M   0% /dev/shm
/dev/md1               31M  5.9M   23M  21% /boot
/dev/mapper/svg-home  496M   31M  440M   7% /home
/dev/mapper/svg-tmp   248M  8.1M  228M   4% /tmp
/dev/mapper/svg-usr   2.0G  776M  1.2G  41% /usr
/dev/mapper/svg-var   248M  207M   29M  89% /var
/dev/mapper/svg-log  1008M   33M  924M   4% /var/log
/dev/mapper/svg-loc    20G   12G  7.9G  59% /local</pre>

<p>
<p><div class="noteimportant">
Si vous insérez un périphérique de stockage amovible boutable, il risque de perturber l&#039;ordre des disques!
donc si votre ensemble raid1 est sur /dev/sdb1 et /dev/sdc1, il se peut que le périphérique de stockage utilise un de ces dev et que votre partition raid soit déplacée sur /dev/sdd1 !
Vous obtenez alors un message d&#039;erreur du type &#039;invalid RAID superblock on sd??&#039;

</div></p>
</p>

<p>
Pour éviter le problème ci-dessus, soit vous boutez sans périphérique de stockage branché, soit vous mettez tous les noms éventuels sous lequel peuvent se retrouver les partitions RAID à assembler. Par exemple, pour un RAID 1 avec deux disques je mets dans mdadm.conf :
</p>
<pre class="code">DEVICE /dev/sdb1 /dev/sdc1 /dev/sdd1 /dev/sde1 /dev/sdf1</pre>

<p>
ET mdadm trouvera les deux bonnes partitions de type RAID là-dedans!
</p>

</div>
<!-- EDIT20 SECTION "Boot directement sur la partition RAID" [42105-46513] -->
<h2 class="sectionedit21" id="liens">Liens</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <a href="http://spamaps.org/raidtests.php" class="urlextern" title="http://spamaps.org/raidtests.php"  rel="nofollow">http://spamaps.org/raidtests.php</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://gentoo-wiki.com/HOWTO_Gentoo_Install_on_Software_RAID_mirror_and_LVM2_on_top_of_RAID" class="urlextern" title="http://gentoo-wiki.com/HOWTO_Gentoo_Install_on_Software_RAID_mirror_and_LVM2_on_top_of_RAID"  rel="nofollow">http://gentoo-wiki.com/HOWTO_Gentoo_Install_on_Software_RAID_mirror_and_LVM2_on_top_of_RAID</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://guitou.serveftp.org/geek/index.php?option=com_content&amp;task=view&amp;id=14" class="urlextern" title="http://guitou.serveftp.org/geek/index.php?option=com_content&amp;task=view&amp;id=14"  rel="nofollow">http://guitou.serveftp.org/geek/index.php?option=com_content&amp;task=view&amp;id=14</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www200.pair.com/mecham/raid/raid1.html" class="urlextern" title="http://www200.pair.com/mecham/raid/raid1.html"  rel="nofollow">http://www200.pair.com/mecham/raid/raid1.html</a> (anglais)</div>
</li>
<li class="level1"><div class="li"> <a href="http://users.piuha.net/martti/comp/ubuntu/raid.html" class="urlextern" title="http://users.piuha.net/martti/comp/ubuntu/raid.html"  rel="nofollow">http://users.piuha.net/martti/comp/ubuntu/raid.html</a> (anglais)</div>
</li>
</ul>
<hr />

<p>
<em>Contributeurs : ostaquet, houyeux, <a href="../../../utilisateurs/claudiux" class="wikilink1" title="utilisateurs:claudiux">claudiux</a>, <a href="../../../utilisateurs/cot_al" class="wikilink1" title="utilisateurs:cot_al">cot_al</a></em>
</p>

</div>
<!-- EDIT21 SECTION "Liens" [46514-] --><div class="footnotes">
<div class="fn"><sup><a href="raid1_software#fnt__1" id="fn__1" class="fn_bot">1)</a></sup> 
Pour rajouter l&#039;environnement graphique à la fin de l&#039;installation en mode <code>Server</code>, il suffit d&#039;ajouter les paquets kubuntu-desktop pour KDE, ubuntu-desktop pour Gnome ou xubuntu-desktop pour XFCE.</div>
</div>

<!-- no cachefile used, but created /srv/www/doc.ubuntu-fr.org/htdocs/data/cache/0/0cc4b083e896ce32f56381f37608c4b6.xhtml -->
</div>
</body>
</html>
