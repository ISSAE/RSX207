<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr" dir="ltr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Script-Type" content="text/javascript"/>
    <meta http-equiv="Content-Style-Type" content="text/css"/>
    <meta http-equiv="Content-Language" content="fr"/>
    <title>utilisateurs:lildadou:mediabunker - Documentation Ubuntu Francophone</title>
    <meta name="Description" content="Documentation francophone pour la distribution Ubuntu" lang="fr" />
    <meta name="language" content="fr-FR" />

    <!--[if IE 8]>
    <meta http-equiv="X-UA-Compatible" content="IE=8" />
    <![endif]-->
        <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="date" content="2013-04-23T01:24:09+0200"/>
<meta name="keywords" content="precise,installation,media center,securite,raid,tutoriel,brouillon"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../lib/exe/opensearch.php" title="Documentation Ubuntu Francophone"/>
<link rel="start" href="../../index.html"/>
<link rel="contents" href="http://doc.ubuntu-fr.org/utilisateurs/lildadou/mediabunker?do=index" title="Plan du site"/>
<link rel="alternate" type="application/rss+xml" title="Derniers changements" href="../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Namespace actuel" href="http://doc.ubuntu-fr.org/feed.php?mode=list&amp;ns=utilisateurs:lildadou"/>
<link rel="alternate" type="text/html" title="HTML brut" href="http://doc.ubuntu-fr.org/_export/xhtml/utilisateurs/lildadou/mediabunker"/>
<link rel="alternate" type="text/plain" title="Wiki balise" href="http://doc.ubuntu-fr.org/_export/raw/utilisateurs/lildadou/mediabunker"/>
<link rel="canonical" href="mediabunker"/>
<link rel="stylesheet" type="text/css" href="../../lib/exe/css.php?t=ubuntu-2010&amp;tseed=4af22dedc19f28c99fa67afabbb173df"/>
<script type="text/javascript">/*<![CDATA[*/var NS='utilisateurs:lildadou';var JSINFO = {"id":"utilisateurs:lildadou:mediabunker","namespace":"utilisateurs:lildadou"};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../lib/exe/js.php?tseed=4af22dedc19f28c99fa67afabbb173df"></script>
    <link rel="shortcut icon" href="http://www-static.ubuntu-fr.org/theme2010/images/commun/ubuntu/icone.png" type="image/x-icon" />
    <link rel="apple-touch-icon" href="http://www-static.ubuntu-fr.org/theme2010/images/commun/ubuntu/touch-ico.png" />

    <link rel="stylesheet" media="screen" type="text/css" title="Design Ubuntu-fr" href="http://www-static.ubuntu-fr.org/theme2010/css/doc.css" />
    <link rel="stylesheet" media="screen" type="text/css" title="Design Ubuntu-fr" href="http://www-static.ubuntu-fr.org/theme2010/css/doc-ubuntu.css" />
    <link rel="stylesheet" media="print" type="text/css" title="Design Ubuntu-fr" href="http://www-static.ubuntu-fr.org/theme2010/css/doc-print.css" />

    <script type="text/javascript">
      var menu_hidden;
      var static_url = "UFR_STATIC";
    </script>
    <script src="http://www-static.ubuntu-fr.org/theme2010/js/menu.js" type="text/javascript"></script>
    <script src="http://www-static.ubuntu-fr.org/theme2010/js/common.js" type="text/javascript"></script>
  </head>
  <body>

    <div id="accessibar">
      <a href="mediabunker#main" tabindex="1">Contenu</a> | <a href="mediabunker#qsearch__in" tabindex="2">Rechercher</a> | <a href="mediabunker#navigation" tabindex="3">Menus</a>
    </div>

    <div id="page">

      <div id="header">

        <div id="logo">
          <h1>Ubuntu-fr</h1>
          <a href="../../index.html" title="Accueil de la documentation">Communauté francophone d'utilisateurs d'Ubuntu</a>
        </div>

        <form action="http://ubuntu-fr.org/recherche" accept-charset="utf-8" id="search" onsubmit="if (document.getElementById('qsearch__in').value == 'Recherche rapide....') {document.getElementById('qsearch__in').value = '';}">
          <fieldset>
            <label for="qsearch__in">Recherche : </label><input type="text" value="Recherche rapide...." id="qsearch__in" accesskey="f" name="sk_q" alt="[F]" size="34" tabindex="4" />
            <label for="tsearch_field">Chercher dans : </label><select name="sk_engine" tabindex="5" id="tsearch_field" title="Chercher dans">
              <option value="all">Site</option>
              <option selected="selected" value="doc">Documentation</option>
              <option value="forum">Forum</option>
              <option value="planet">Planet</option>
            </select>
            <input type="submit" value="ok" class="button" alt="Lancer la recherche" tabindex="5" />
          </fieldset>
        </form>
        <!--[if lte IE 7]><div class="clear"></div><![endif]-->

        <form action="mediabunker" accept-charset="utf-8" id="login_top" method="post">
          <fieldset>
            <label for="u_field">Identifiant : </label><input type="text" value="Identifiant" name="u" id="u_field" size="9" /><label for="p_field">Mot de passe : </label><input type="password" value="Mot de passe" name="p" id="p_field" size="9" alt="Mot de passe" /><input type="submit" value="connexion" id="connect" /> / <a href="http://forum.ubuntu-fr.org/register.php">inscription</a>
          </fieldset>
        </form>
 

      </div>

      <div id="navbar">
          <h2 id="pagetitle"><a href="mediabunker" >utilisateurs:lildadou:mediabunker</a></h2>
      </div>

      
      <div id="main" class="dokuwiki">

        <div id="hidemenu" title="Masquer le menu"></div>

        <div id="pagerror"></div>
                <!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table des matières</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="mediabunker#avant-propos">Avant-Propos</a></div></li>
<li class="level1"><div class="li"><a href="mediabunker#limites_du_concept">Limites du concept</a></div></li>
<li class="level1"><div class="li"><a href="mediabunker#preparation_du_domaine_de_stockage">Préparation du domaine de stockage</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="mediabunker#nettoyage_des_support_physique">Nettoyage des support physique</a></div></li>
<li class="level2"><div class="li"><a href="mediabunker#partitionnement">Partitionnement</a></div></li>
<li class="level2"><div class="li"><a href="mediabunker#adjonction_de_la_couche_raid">Adjonction de la couche RAID</a></div></li>
<li class="level2"><div class="li"><a href="mediabunker#adjonction_de_la_couche_de_chiffrement">Adjonction de la couche de chiffrement</a></div></li>
<li class="level2"><div class="li"><a href="mediabunker#adjonction_de_la_couche_de_gestion_des_volumes_logiques">Adjonction de la couche de gestion des volumes logiques</a></div></li>
<li class="level2"><div class="li"><a href="mediabunker#adjonction_de_la_couche_des_systemes_de_fichiers">Adjonction de la couche des systèmes de fichiers</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="mediabunker#installation_et_parametrage_du_systeme">Installation et paramétrage du système</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="mediabunker#installation_d_ubuntu">Installation d&#039;Ubuntu</a></div></li>
<li class="level2"><div class="li"><a href="mediabunker#parametrage_des_services_d_amorcage">Paramètrage des services d&#039;amorçage</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="mediabunker#installation_des_services_mediacenter">Installation des services mediacenter</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="mediabunker#protection_contre_les_spiders_indesirables">Protection contre les spiders indésirables</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="mediabunker#avanceevoluer_son_raid0_vers_un_raid56">Avancé : Évoluer son RAID0 vers un RAID5/6</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="mediabunker#preparation">Préparation</a></div></li>
<li class="level2"><div class="li"><a href="mediabunker#la_sauvegarde">La sauvegarde</a></div></li>
<li class="level2"><div class="li"><a href="mediabunker#raidlukslvmfilesytem">RAID / LUKS / LVM / FileSytem</a></div></li>
<li class="level2"><div class="li"><a href="mediabunker#actualisation_des_fichiers_de_configuration">Actualisation des fichiers de configuration</a></div></li>
<li class="level2"><div class="li"><a href="mediabunker#integration_du_nouveau_disque">Intégration du nouveau disque</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="mediabunker#voir_aussi">Voir aussi</a></div></li>
</ul>
</div>
</div>
<!-- TOC END -->
<div class="tags"><span>
	<a href="../../precise" class="wikilink1" title="precise" rel="tag">Precise</a>,
	<a href="../../installation.1" class="wikilink1" title="installation" rel="tag">installation</a>,
	<a href="http://doc.ubuntu-fr.org/media_center" class="wikilink1" title="media_center" rel="tag">media center</a>,
	<a href="http://doc.ubuntu-fr.org/securite" class="wikilink1" title="securite" rel="tag">sécurité</a>,
	<a href="../../raid" class="wikilink1" title="raid" rel="tag">raid</a>,
	<a href="http://doc.ubuntu-fr.org/tutoriel" class="wikilink1" title="tutoriel" rel="tag">tutoriel</a>,
	<a href="../../brouillon" class="wikilink1" title="brouillon" rel="tag">BROUILLON</a>
</span></div>
<hr />

<h1 class="sectionedit1" id="installation_d_un_centre_multimedia_de_salon_securise">Installation d&#039;un centre multimédia de salon sécurisé</h1>
<div class="level1">

<p>
<p><div class="noteclassic"><em class="u"><strong>Installation d&#039;Ubuntu</strong></em>
</p>
<ol>
<li class="level1"><div class="li"> <a href="../../tutoriel/obtenir_cd_ubuntu" class="wikilink1" title="tutoriel:obtenir_cd_ubuntu">Obtention du CD-ROM d&#039;installation d&#039;Ubuntu</a></div>
</li>
<li class="level1"><div class="li"> <strong>Installation</strong></div>
</li>
<li class="level1"><div class="li"> <a href="../../tutoriel/completer_installation_ubuntu" class="wikilink1" title="tutoriel:completer_installation_ubuntu">Compléter l&#039;installation d&#039;Ubuntu</a></div>
</li>
</ol>

<p>

</div></p>
</p>

</div>

<h2 class="sectionedit2" id="avant-propos">Avant-Propos</h2>
<div class="level2">

<p>
Cet article vise à fournir la démarche pour l&#039;installation d&#039;un ordinateur de salon avec comme préoccupations :
</p>
<ol>
<li class="level1"><div class="li"> La sécurité, à travers l&#039;utilisation de chiffrement total de disque-dur et un renforcement de l&#039;accès par le réseau.</div>
</li>
<li class="level1"><div class="li"> La performance, avec l&#039;utilisation d&#039;un RAID.</div>
</li>
<li class="level1"><div class="li"> L&#039;accessibilité à l&#039;usage, en optant pour une Wiimote comme outil de contrôle.</div>
</li>
<li class="level1"><div class="li"> <strong>TODO:</strong> Backup, backup, backup… sinon tout ça ne sert à rien!</div>
</li>
</ol>

<p>
Ce tutorial pars des pré-requis suivant :
</p>
<ul>
<li class="level1"><div class="li"> Vous envisagez de n&#039;installer qu&#039;un seul système d&#039;exploitation sur votre machine</div>
</li>
<li class="level1"><div class="li"> Toutes les données de vos disques-durs sont conservées sur un autre support</div>
</li>
<li class="level1"><div class="li"> Vous avez déjà <a href="../../amorcage" class="wikilink1" title="amorcage">amorcé</a> le Live-CD</div>
</li>
<li class="level1"><div class="li"> Votre <a href="http://doc.ubuntu-fr.org/wiki/glossaire#bios" class="wikilink1" title="wiki:glossaire">BIOS</a> supporte l&#039;amorçage sur un disque qui dispose d&#039;une table de partition <a href="http://fr.wikipedia.org/wiki/GUID_Partition_Table" class="urlextern" title="http://fr.wikipedia.org/wiki/GUID_Partition_Table"  rel="nofollow">GPT</a></div>
</li>
</ul>

</div>

<h2 class="sectionedit3" id="limites_du_concept">Limites du concept</h2>
<div class="level2">

<p>
Les 2 derniers points sont déjà relativement bien traités sur Internet, ce tutoriel se concentrera donc sur la première problématique. Même si le niveau de sécurité n&#039;est pas optimum, il représentera malgré tout un niveau qui pourra dissuader un bon nombre de personnes malveillantes. Le concept vise à placer une grande partie du système sur un support chiffré. Seul le /boot sera accessible à l&#039;attaquant, votre machine sera donc vulnérable aux attaques de type <a href="http://theinvisiblethings.blogspot.com/2009/10/evil-maid-goes-after-truecrypt.html" class="urlextern" title="http://theinvisiblethings.blogspot.com/2009/10/evil-maid-goes-after-truecrypt.html"  rel="nofollow">evil maiden (en)</a> (l&#039;attaquant accède à votre machine pour y placer un /boot corrompu qui interceptera la clé de déchiffrement de votre système de fichiers).
</p>

<p>
Des solutions existent pour parer ces attaques mais ne serons pas mise en place dans un premier temps :
</p>
<ol>
<li class="level1"><div class="li"> La première solution consiste à placer le /boot sur un support qui ne sera pas accessible à l&#039;attaquant ; classiquement une clef <abbr title="Universal Serial Bus">USB</abbr> que vous placerez sous surveillance constante. La machine sera toujours vulnérable à une attaque de type <a href="http://theinvisiblethings.blogspot.com/2009/10/evil-maid-goes-after-truecrypt.html" class="urlextern" title="http://theinvisiblethings.blogspot.com/2009/10/evil-maid-goes-after-truecrypt.html"  rel="nofollow">evil maiden (en)</a>, mais compliquera considérablement la tâche de l&#039;attaquant puisque celui-ci devra s&#039;attaquer au <a href="../../grub" class="wikilink1" title="grub">GRUB</a> ou au <a href="http://doc.ubuntu-fr.org/wiki/glossaire#bios" class="wikilink1" title="wiki:glossaire">BIOS</a>. Il devient plus simple de placer un <a href="http://fr.wikipedia.org/wiki/Keylogger" class="urlextern" title="http://fr.wikipedia.org/wiki/Keylogger"  rel="nofollow">keylogger</a> matériel sur le clavier.</div>
</li>
<li class="level1"><div class="li"> Une deuxième solution s&#039;appuie sur les puces dites <a href="http://fr.wikipedia.org/wiki/Trusted_Platform_Module" class="urlextern" title="http://fr.wikipedia.org/wiki/Trusted_Platform_Module"  rel="nofollow">TPM</a>. Des mécanismes matériels entrent en scène pour s&#039;assurer que le <a href="http://doc.ubuntu-fr.org/wiki/glossaire#bios" class="wikilink1" title="wiki:glossaire">BIOS</a> n&#039;a pas été modifié, le <a href="http://doc.ubuntu-fr.org/wiki/glossaire#bios" class="wikilink1" title="wiki:glossaire">BIOS</a> vérifie que le GRUB n&#039;a pas été modifié, et le <a href="../../grub" class="wikilink1" title="grub">GRUB</a> vérifie que le /boot n&#039;a pas été modifié. On obtient ainsi une chaine de confiance qui garanti que le système n&#039;a pas été corrompu. Cette technique est complexe à mettre en place et la communauté du libre n&#039;est pas encore enclin à promouvoir un système qui cachent aussi des effets secondaires pervers <a href="http://www.gnu.org/philosophy/can-you-trust.fr.html" class="urlextern" title="http://www.gnu.org/philosophy/can-you-trust.fr.html"  rel="nofollow">source</a>.</div>
</li>
</ol>

<p>
Côté sécurité réseau, nous mettrons en place une protection contre les indésirables avec l&#039;outil PeerGuardian Linux  (anciennement appelé <a href="../../moblock" class="wikilink1" title="moblock">blockcontrol</a> et encore avant, moblocker). Cet outil permet par exemple d&#039;empêcher les connexions vers ou depuis des IPs appartenant à des sociétés qui relève les addresses IP procédant à un téléchargement illicite.
</p>

</div>

<h2 class="sectionedit4" id="preparation_du_domaine_de_stockage">Préparation du domaine de stockage</h2>
<div class="level2">

<p>
La topologie cible est la suivante :
</p>
<pre class="code">DISK0 : [[gpt][bios-grub][classic ][classic ][========== raid-linux ===========]]
DISK1 : [[gpt][bios-grub][classic ][classic ][========== raid-linux ===========]]
LUKS  : [                          [swapLUKS][========== LUKS contnr ==========]]
LVM   : [                                    [=========== raid0mvg ============]]
FS    : [                [= /boot=][==swap==][= / =][========= /home ==========]]</pre>
<ul>
<li class="level1"><div class="li"> Nous allons utilisez le système de partitionnement <a href="http://fr.wikipedia.org/wiki/GUID_Partition_Table" class="urlextern" title="http://fr.wikipedia.org/wiki/GUID_Partition_Table"  rel="nofollow">GPT</a> à la place du traditionnel (et obsolète-né) <a href="http://fr.wikipedia.org/wiki/Master_Boot_Record" class="urlextern" title="http://fr.wikipedia.org/wiki/Master_Boot_Record"  rel="nofollow">MBR</a> pour permettre l&#039;installation d&#039;un secteur d&#039;amorçage supérieur à 512KiB. En effet notre <a href="../../grub" class="wikilink1" title="grub">GRUB</a> risque de rapidement devenir obèse avec tout ce qu&#039;on attends de lui. Pour des questions de performance, nous allons aligner les partitions nous aurons donc 2 <a href="../../grub" class="wikilink1" title="grub">GRUBs</a> et 2 /boot.</div>
</li>
<li class="level1"><div class="li"> Les 2 partitions /boot profiterons d&#039;un <a href="http://fr.wikipedia.org/wiki/RAID_%28informatique%29#RAID_1_:_Disques_en_miroir" class="urlextern" title="http://fr.wikipedia.org/wiki/RAID_%28informatique%29#RAID_1_:_Disques_en_miroir"  rel="nofollow">RAID1</a> logiciel.</div>
</li>
<li class="level1"><div class="li"> Les partitions de <a href="http://fr.wikipedia.org/wiki/M%C3%A9moire_virtuelle#Swapping" class="urlextern" title="http://fr.wikipedia.org/wiki/M%C3%A9moire_virtuelle#Swapping"  rel="nofollow">swap</a> ne seront pas dans le RAID pour des questions de performances mais seront chiffrés malgré tout. Les données stockés dans le <a href="http://fr.wikipedia.org/wiki/M%C3%A9moire_virtuelle#Swapping" class="urlextern" title="http://fr.wikipedia.org/wiki/M%C3%A9moire_virtuelle#Swapping"  rel="nofollow">swap</a> peuvent en effet contenir des informations sensibles ou utiles à un attaquant. L&#039;utilisation de ces partitions de swap est optionnelle. Vous pouvez à la place utiliser un <a href="http://doc.ubuntu-fr.org/swap#definir_un_fichier_comme_fichier_d_echange_avance" class="wikilink1" title="swap">fichier d&#039;échange</a>, ce qui simplifiera votre installation.</div>
</li>
<li class="level1"><div class="li"> Le reste du système sera placé dans un conteneur <a href="../../lvm.1" class="wikilink1" title="lvm">LVM2</a>, lui-même dans un conteneur <a href="http://www.k-tux.com/luks-quelques-grammes-de-paranoia-pour-des-donnees-bien-protegees" class="urlextern" title="http://www.k-tux.com/luks-quelques-grammes-de-paranoia-pour-des-donnees-bien-protegees"  rel="nofollow">LUKS</a>, lui-même dans une grappe RAID une combinaison de performance, sécurité et flexibilité.</div>
</li>
</ul>

</div>

<h3 class="sectionedit5" id="nettoyage_des_support_physique">Nettoyage des support physique</h3>
<div class="level3">

<p>
<p><div class="notewarning">Toutes les données sur vos disques seront supprimées et impossible à récupérées (même avec un logiciel de récupération). C&#039;est un peu le but aussi.
</div></p>
Cette opération peut être très longue mais il est conseillé de le faire. Pour chaque disques durs, lancez cette commande qui tournera en tâche de fond :
</p>
<pre class="code">shred --iterations=N --verbose /dev/sda &amp;
shred --iterations=N --verbose /dev/sdb &amp;
...</pre>

<p>
N correspond au nombre de passes de nettoyage. Adaptez cette valeur en fonction du degré de confidentialité des données présentes en clair sur le support. 1 est déjà une bonne valeur.
</p>

</div>

<h3 class="sectionedit6" id="partitionnement">Partitionnement</h3>
<div class="level3">

<p>
Voici le schéma de partionnement ciblé :
</p>
<div class="table sectionedit7"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> Nom    </th><th class="col1 centeralign">             Taille            </th><th class="col2 centeralign">   FS   </th><th class="col3 centeralign">      Type de partition     </th>
	</tr>
	</thead>
	<tr class="row1">
		<th class="col0"> GRUB-x </th><td class="col1 centeralign">            0,008 Go           </td><td class="col2 centeralign">  Vide  </td><td class="col3">Partition de démarrage <abbr title="Basic Input-Output System">BIOS</abbr> </td>
	</tr>
	<tr class="row2">
		<th class="col0"> Boot-x </th><td class="col1 centeralign">              1 Go             </td><td class="col2 centeralign">  Vide  </td><td class="col3 leftalign">Partition RAID Linux        </td>
	</tr>
	<tr class="row3">
		<th class="col0"> Swap-x </th><td class="col1"> 1/2 à 1 votre quantité de RAM </td><td class="col2 centeralign">  Vide  </td><td class="col3 leftalign">Partition d&#039;échange Linux   </td>
	</tr>
	<tr class="row4">
		<th class="col0"> MyFS-x </th><td class="col1 centeralign">            le reste           </td><td class="col2 centeralign">  Vide  </td><td class="col3 leftalign">Partition RAID Linux        </td>
	</tr>
</table></div>

</div>

<h4 id="la_methode_graphique">La méthode graphique</h4>
<div class="level4">

<p>
Pour le <a href="http://fr.wikipedia.org/wiki/Partition_de_disque_dur" class="urlextern" title="http://fr.wikipedia.org/wiki/Partition_de_disque_dur"  rel="nofollow">partitionnement</a> nous allons utiliser l&#039;utilitaire de disque, plutôt que GParted, qui nous simplifiera la vie.
Lancez l&#039;Utilitaire de disque : System &gt; Administration &gt; Disk Utility.
Pour chacun de vos disque-durs, créez une <a href="http://fr.wikipedia.org/wiki/Partition_de_disque_dur#Tables_de_partitions" class="urlextern" title="http://fr.wikipedia.org/wiki/Partition_de_disque_dur#Tables_de_partitions"  rel="nofollow">table de partition</a> <a href="http://fr.wikipedia.org/wiki/GUID_Partition_Table" class="urlextern" title="http://fr.wikipedia.org/wiki/GUID_Partition_Table"  rel="nofollow">GPT</a> : Sélectionnez le disque &gt; Formater le disque &gt; Table de partitions GUID.
</p>

<p>
Pour chacun de vos disque-durs, créez ces 4 <a href="http://fr.wikipedia.org/wiki/Partition_de_disque_dur" class="urlextern" title="http://fr.wikipedia.org/wiki/Partition_de_disque_dur"  rel="nofollow">partitions</a> dans cet ordre.
Sélectionnez votre disque-dur &gt; Cliquez sur l&#039;espace <em>libre</em> &gt; Créer une partition.
Pour changez le type de partition, créez d&#039;abord votre partition. Ensuite sélectionnez là et cliquez sur Modifier la partition.
</p>

</div>

<h4 id="la_methode_en_ligne_de_commande">La méthode en ligne de commande</h4>
<div class="level4">

<p>
Vous n&#039;êtes pas bleusaille? Très bien. Débrouillez-vous avec ce bref rappel :
</p>
<div class="table sectionedit8"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Action </th><th class="col1"> Commande </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> Lancer le logiciel de partionnement </td><td class="col1"> sudo parted /dev/sdX </td>
	</tr>
	<tr class="row2">
		<td class="col0"> Écrire une table de partitions GPT </td><td class="col1"> mklabel gpt </td>
	</tr>
	<tr class="row3">
		<td class="col0"> Ajouter une partition </td><td class="col1"> mkpart nom debut fin </td>
	</tr>
</table></div>

</div>

<h3 class="sectionedit9" id="adjonction_de_la_couche_raid">Adjonction de la couche RAID</h3>
<div class="level3">

<p>
Pour assembler les grappes RAID nous avons besoin de <a href="apt://mdadm" class="urlextern" title="apt://mdadm"  rel="nofollow">apt://mdadm</a>. Notre <em>/boot</em> sera dans un <a href="http://fr.wikipedia.org/wiki/RAID_%28informatique%29#RAID_1_:_Disques_en_miroir" class="urlextern" title="http://fr.wikipedia.org/wiki/RAID_%28informatique%29#RAID_1_:_Disques_en_miroir"  rel="nofollow">RAID1</a> et <a href="../../grub" class="wikilink1" title="grub">GRUB</a> impose que si la partition de <em>/boot</em> est dans un RAID alors la version des <a href="http://doc.ubuntu-fr.org/utilisateurs/lildadou/metadata" class="wikilink2" title="utilisateurs:lildadou:metadata" rel="nofollow">metadata</a> <a href="http://grub.enbug.org/LVMandRAID" class="urlextern" title="http://grub.enbug.org/LVMandRAID"  rel="nofollow">doit être la 0.90</a>. Pour cette raison, nous n&#039;utiliserons pas l&#039;Utilitaire de disque pour la création du RAID (qui utilise la version 1.20). Par contre, pour le RAID qui contiendra la racine nous utiliserons les metadata version 1.20. Pourquoi? La version 0.90 place les metadata à la fin de la partition. Pour notre dernière partition, la fin de la partition correspond aussi à la fin du disque. Lorsque mdadm cherche les metadata sur le disque il peut croire que tout le disque appartient au RAID (expérience vécu). Mais utiliser la v1.20 des metadata entraine un autre problème comme l&#039;alignement des block LUKS et LVM, ce qui peut nous empêcher d&#039;atteindre des performances optimales.
N&#039;hésitez pas à changer votre schéma de partitions pour combiner l&#039;utilisation de plusieurs famille de RAID par exemple.
</p>

<p>
Dans tout les cas, <strong>ne mettez pas</strong> vos partitions de <a href="http://fr.wikipedia.org/wiki/M%C3%A9moire_virtuelle#Swapping" class="urlextern" title="http://fr.wikipedia.org/wiki/M%C3%A9moire_virtuelle#Swapping"  rel="nofollow">swap</a> dans un RAID. Le <a href="http://fr.wikipedia.org/wiki/M%C3%A9moire_virtuelle#Swapping" class="urlextern" title="http://fr.wikipedia.org/wiki/M%C3%A9moire_virtuelle#Swapping"  rel="nofollow">swap</a> n&#039;est pas connu pour sa séquentialité des accès, il vaut mieux avoir de petits blocs de 4ko plutôt que les 128ko tout boudinés d&#039;un RAID…
</p>
<pre class="code">mdadm --create /dev/md0 --metadata=0.90 --raid-devices=2 --level=1 /dev/sd[ab]2
mdadm --create /dev/md1 --metadata=1.2 --raid-devices=2 --chunk=128 --level=0 /dev/sd[ab]4</pre>

</div>

<h3 class="sectionedit10" id="adjonction_de_la_couche_de_chiffrement">Adjonction de la couche de chiffrement</h3>
<div class="level3">

<p>
Le <a href="http://fr.wikipedia.org/wiki/Mode_d%27op%C3%A9ration_%28cryptographie%29" class="urlextern" title="http://fr.wikipedia.org/wiki/Mode_d%27op%C3%A9ration_%28cryptographie%29"  rel="nofollow">mode d&#039;opération</a> que nous allons utiliser est <a href="http://en.wikipedia.org/wiki/Disk_encryption_theory#XTS" class="urlextern" title="http://en.wikipedia.org/wiki/Disk_encryption_theory#XTS"  rel="nofollow">XTS (en)</a>, plus adapté au chiffrement de disque.
</p>

<p>
Nous n&#039;utiliserons pas d&#039;<a href="http://en.wikipedia.org/wiki/Disk_encryption_theory#ESSIV" class="urlextern" title="http://en.wikipedia.org/wiki/Disk_encryption_theory#ESSIV"  rel="nofollow">ESSIV (en)</a> car <a href="http://en.wikipedia.org/wiki/Disk_encryption_theory#XTS" class="urlextern" title="http://en.wikipedia.org/wiki/Disk_encryption_theory#XTS"  rel="nofollow">XTS (en)</a> embarque son propre mécanisme pour choisir son <a href="http://fr.wikipedia.org/wiki/Vecteur_d%27initialisation" class="urlextern" title="http://fr.wikipedia.org/wiki/Vecteur_d%27initialisation"  rel="nofollow">vecteur d&#039;initialisation</a> (IV). Ajouter l&#039;<a href="http://en.wikipedia.org/wiki/Disk_encryption_theory#ESSIV" class="urlextern" title="http://en.wikipedia.org/wiki/Disk_encryption_theory#ESSIV"  rel="nofollow">ESSIV (en)</a> apporterai un gain négligeable de protection comparé à son impact sur les performances <a href="http://seclists.org/basics/2009/May/253" class="urlextern" title="http://seclists.org/basics/2009/May/253"  rel="nofollow">source</a> <a href="http://code.google.com/p/cryptsetup/wiki/FrequentlyAskedQuestions#5._Security_Aspects" class="urlextern" title="http://code.google.com/p/cryptsetup/wiki/FrequentlyAskedQuestions#5._Security_Aspects"  rel="nofollow">source officielle</a>. Nous utiliserons du plain64 pour nos IV parce qu&#039;en fonction de la taille de vos disques et de la taille des blocs, l&#039;utilisation du plain(32bits) peut introduire une faille de sécurité du à la répétition des IV.
</p>

<p>
Le chiffrement que nous utiliserons est l&#039;<a href="http://fr.wikipedia.org/wiki/Rijndael" class="urlextern" title="http://fr.wikipedia.org/wiki/Rijndael"  rel="nofollow">AES</a>. Le chiffrage <a href="http://fr.wikipedia.org/wiki/Serpent_%28cryptographie%29" class="urlextern" title="http://fr.wikipedia.org/wiki/Serpent_%28cryptographie%29"  rel="nofollow">Serpent</a>, même s&#039;il est cryptographiquement plus sûr, est suffisamment lourd pour former un goulot d&#039;étranglement sur le débit des disques.
</p>

<p>
Pour le container <a href="http://www.k-tux.com/luks-quelques-grammes-de-paranoia-pour-des-donnees-bien-protegees" class="urlextern" title="http://www.k-tux.com/luks-quelques-grammes-de-paranoia-pour-des-donnees-bien-protegees"  rel="nofollow">LUKS</a> en RAID, on va utiliser l&#039;option <em>align-payload</em> (qui permet de modifier la où commence les blocs de données du container) pour aligner le container avec notre RAID. Par défaut cette valeur est de 8 (secteurs x 512o = 4Ko) que nous plaçons à 512. 
La formule optimale est : <em>(chunk_size/512o)*qt_data_disk</em>. Un RAID5 de 3 disques aura une valeur de qt_data_disk de 2 un RAID0 de 3 disques aura une valeur de 3. Pensez à adapter cette valeur si vous avez personnalisé la taille du chunk de vos RAIDs.
</p>
<pre class="code">cryptsetup luksFormat --cipher=aes-xts-plain64 --hash=sha256 --key-size=512 /dev/sda3
cryptsetup luksFormat --cipher=aes-xts-plain64 --hash=sha256 --key-size=512 /dev/sdb3
cryptsetup luksFormat --cipher=aes-xts-plain64 --hash=sha256 --key-size=512 --align-payload=512 /dev/md1</pre>

<p>
Vous pouvez maintenant déverrouiller les conteneurs <a href="http://www.k-tux.com/luks-quelques-grammes-de-paranoia-pour-des-donnees-bien-protegees" class="urlextern" title="http://www.k-tux.com/luks-quelques-grammes-de-paranoia-pour-des-donnees-bien-protegees"  rel="nofollow">LUKS</a> pour obtenir vos partitions mappées dans /dev/mapper/ : 
</p>
<pre class="code">cryptsetup luksOpen /dev/sda3 unlocked-swapa
cryptsetup luksOpen /dev/sdb3 unlocked-swapb
cryptsetup luksOpen /dev/md1 unlocked-md1</pre>

</div>

<h3 class="sectionedit11" id="adjonction_de_la_couche_de_gestion_des_volumes_logiques">Adjonction de la couche de gestion des volumes logiques</h3>
<div class="level3">

<p>
Les disques sont partitionnés, les RAID assemblés et les conteneurs LUKS en place et déverrouillés ; nous allons pouvoir segmenter notre espace de stockage pour y placer les système de fichiers (ou <em>formater</em>).
</p>

<p>
La création d&#039;un <a href="../../lvm.1" class="wikilink1" title="lvm">LVM</a> se fait en 4 petites étapes :
</p>
<ol>
<li class="level1"><div class="li"> L&#039;installation <a href="apt://lvm2" class="urlextern" title="apt://lvm2"  rel="nofollow">apt://lvm2</a></div>
</li>
<li class="level1"><div class="li"> On désigne les volumes physique (disques-durs, RAIDs, conteneur LUKS déverrouillés, …) qui seront gérés par LVM.</div>
</li>
<li class="level1"><div class="li"> On regroupe ensuite ces volumes physiques pour former un groupe de volumes, un gros volume physique en somme.</div>
</li>
<li class="level1"><div class="li"> On découpe ensuite ce groupe de volumes en volumes logiques, des partitions en somme.</div>
</li>
</ol>

<p>
<p><div class="noteclassic">Même si le LVM permet de regrouper plusieurs volumes physique pour n&#039;en former qu&#039;un, ce n&#039;est pas un équivalent au RAID. Le LVM se concentre sur l&#039;exploitation logique des volumes (partionnement, redimenssionnement des partitions, augmentation de la taille d&#039;un volume, …) tandis que le RAID se préoccupe de l&#039;exploitation matériel (meilleurs performances, tolérance aux pannes, …)
</div></p>
</p>

<p>
Les 3 premières étapes se font simplement :
</p>
<pre class="code">apt-get install lvm2
pvcreate /dev/mapper/unlocked-md1
vgcreate rootvg /dev/mapper/unlocked-md1</pre>

<p>
<p><div class="noteclassic"><em>pvcreate</em> est suffisamment bien foutu pour s&#039;aligner tout seul avec votre grappe RAID.
</div></p>
</p>

<p>
Créons maintenant le volume logique (partition) qui accueillera la racine de notre système de fichier, ici de 80Gio :
</p>
<pre class="code">lvcreate --name systemlv --size 80g rootvg</pre>

<p>
On veut maintenant créer un autre volume logique pour accueillir notre <em>/home</em> avec le reste d&#039;espace disponible.
Commençons par se renseigner sur l&#039;espace qu&#039;il nous reste :
</p>
<pre class="code">&gt;&gt;&gt; vgdisplay

 --- Volume group ---
 VG Name               rootvg
 System ID             
 Format                lvm2
 Metadata Areas        1
 Metadata Sequence No  2
 VG Access             read/write
 VG Status             resizable
 MAX LV                0
 Cur LV                1
 Open LV               0
 Max PV                0
 Cur PV                1
 Act PV                1
 VG Size               966,51 GiB
 PE Size               4,00 MiB
 Total PE              237187
 Alloc PE / Size       20480 / 80,00 GiB
 Free  PE / Size       226947 / 886,51 GiB
 VG UUID               bslw15-...-dsf54f</pre>

<p>
Il nous reste 226.947 PE de 4Mio soit 907788Mio. Affectons-les :
</p>
<pre class="code">lvcreate --name homelv --size 907788m rootvg</pre>

</div>

<h3 class="sectionedit12" id="adjonction_de_la_couche_des_systemes_de_fichiers">Adjonction de la couche des systèmes de fichiers</h3>
<div class="level3">

<p>
Nous avons certes fini de créer nos <em>partitions</em> mais aux yeux d&#039;Ubuntu ce sont chacune des volumes distinct. Ubuntu n&#039;acceptera pas de s&#039;installer sur ces volumes sans table de partitions. On va lui jouer un petit tour pour le piéger en créant nous mêmes le système de fichier. Cette étape est d&#039;autant plus importante que nous devons de plus créer des systèmes de fichiers qui alignés à nos blocs logiques, on en profitera aussi pour désactiver la journalisation sur la partition de <em>/boot</em>
</p>

<p>
Cet alignement se fait en paramètrant les valeurs <em>stride</em> et <em>stripe-width</em> lors de la création du système de fichier. Les formules optimales sont :
</p>
<ul>
<li class="level1"><div class="li"> stride = chunk_size / 4096o</div>
</li>
<li class="level1"><div class="li"> stripe-width = stride x qt_data_disk (n pour RAID0, 1 pour RAID1, n-1 pour RAID5, …)</div>
</li>
</ul>
<pre class="code">mkfs.ext4 -b 4096 -E stride=16,stripe-width=16 -O ^has_journal -L boot /dev/md0
mkfs.ext4 -b 4096 -E stride=32,stripe-width=64 -L system /dev/mapper/rootvg-systemlv
mkfs.ext4 -b 4096 -E stride=32,stripe-width=64 -L home /dev/mapper/rootvg-homelv
mkswap /dev/mapper/unlocked-swapa
mkswap /dev/mapper/unlocked-swapb</pre>

</div>

<h2 class="sectionedit13" id="installation_et_parametrage_du_systeme">Installation et paramétrage du système</h2>
<div class="level2">

<p>
La préparation du domaine de stockage est maintenant terminée et Ubuntu peut y être installé.
</p>

</div>

<h3 class="sectionedit14" id="installation_d_ubuntu">Installation d&#039;Ubuntu</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> Démarrez maintenant <em>Installer Ubuntu 10.10</em> sur votre Bureau.</div>
</li>
<li class="level1"><div class="li"> Choisissez de mettre les mises à jour.</div>
</li>
<li class="level1"><div class="li"> A l&#039;écran <strong>Allouer de l&#039;espace disque</strong> choisissez <em>Définir les partitions manuellement</em></div>
</li>
<li class="level1"><div class="li"> Modifiez les <em>Périphériques</em> suivant avec ces paramètres :</div>
</li>
</ul>
<div class="table sectionedit15"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign">Périphérique  </th><th class="col1"> Utiliser comme </th><th class="col2"> Formater? </th><th class="col3"> Point de montage </th>
	</tr>
	</thead>
	<tr class="row1">
		<th class="col0 leftalign">/dev/mapper/rootvg-homelv  </th><td class="col1"> ext4 </td><td class="col2"> Non </td><td class="col3"> /home </td>
	</tr>
	<tr class="row2">
		<th class="col0 leftalign">/dev/mapper/rootvg-systemlv  </th><td class="col1"> ext4 </td><td class="col2"> Non </td><td class="col3"> / </td>
	</tr>
	<tr class="row3">
		<th class="col0 leftalign">/dev/md0  </th><td class="col1"> ext4 </td><td class="col2"> Non </td><td class="col3"> /boot </td>
	</tr>
	<tr class="row4">
		<th class="col0 centeralign" colspan="4">  En chargeur d&#039;amorçage, choisissez : <strong>/dev/sda</strong>  </th>
	</tr>
</table></div>
<ul>
<li class="level1"><div class="li"> Lancez l&#039;installation, préparez-vous un café et prenez le temps de répondre au quelques questions de l&#039;installateur.</div>
</li>
<li class="level1"><div class="li"> Lorsque l&#039;installation est terminée, <strong>ne redémarrer pas</strong> votre ordinateur.</div>
</li>
</ul>

</div>

<h3 class="sectionedit16" id="parametrage_des_services_d_amorcage">Paramètrage des services d&#039;amorçage</h3>
<div class="level3">

<p>
Ubuntu est sur votre RAID chiffré! sauf qu&#039;avec toutes ces couches (RAID, LUKS et LVM), l&#039;installateur ne s&#039;y retrouve plus et à besoin d&#039;un coup de pouce pour comprendre comment démarrer votre machine. Nous allons rentrer dans notre installation toute fraîche et lui expliquer tout ça.
</p>

<p>
Pour entrer, on va se <em><a href="http://doc.ubuntu-fr.org/chroot" class="wikilink1" title="chroot">chrooter</a></em> ; on pourra lancer des commandes comme si nous avions démarrer notre nouvelle installation : 
</p>
<pre class="code">mount /dev/mapper/rootvg-systemlv /target
mount /dev/mapper/rootvg-homelv /target/home
mount /dev/md0 /target/boot
mount -t devpts devpts /target/dev/pts
mount -t proc /proc /target/proc
mount -t sysfs /sys /target/sys
mount --bind /dev /target/dev
chroot /target/</pre>

<p>
Notre installation ne sait démarrer ni le RAID, ni le LVM, ni le LUKS. On va devoir installer ces logiciels comme au début de notre installation :
</p>
<pre class="code">apt-get install mdadm lvm2 cryptsetup</pre>

<p>
Lorsque la machine démarre, un mini-linux (initrd) est lancé pour en démarrer un plus gros (le notre) ensuite. Il faut que ajouter des modules à initrd pour qu&#039;il puisse démarrer le RAID, le LVM et le LUKS. Tout ces modules vont beaucoup alourdir l&#039;initrd jusqu&#039;à atteindre une taille non-standard et normalement interdite. C&#039;est pour ces raisons que nous avions utiliser GPT et des partition bios-grub au tout début. Pour ajouter les modules, éditez ce fichier comme suit:
</p>
<dl class="file">
<dt><a href="http://doc.ubuntu-fr.org/_export/code/utilisateurs/lildadou/mediabunker?codeblock=12" title="Télécharger un extrait" class="mediafile mf_">/etc/initramfs-tools/modules</a></dt>
<dd><pre class="code file text">raid1
raid0
#raid5
dm-crypt
dm-mod
aes
sha256
xts
sd_mod
blkcipher</pre>
</dd></dl>

<p>
Il faut aussi faire en sorte que cet l&#039;initrd nous demande de saisir un mot de passe pour qu&#039;il puisse déverrouiller les conteneur.
</p>
<pre class="code">ln --symbolic /usr/share/initramfs-tools/hooks/cryptroot /etc/initramfs-tools/hooks/
ln --symbolic /usr/share/initramfs-tools/scripts/local-top/cryptroot /etc/initramfs-tools/scripts/local-top/
touch /etc/initramfs-tools/conf.d/cryptroot</pre>

<p>
Vous vous souvenez que les partitions de swap ont chacune leurs propres conteneur LUKS? Plutôt que d&#039;avoir à saisir à chaque démarrage leurs clefs, nous allons <a href="../../dd#creer_un_fichier_de_100_octets_aleatoires" class="wikilink1" title="dd">générer des clefs</a> très sures (plus sure que n&#039;importe quel mot de passe) que l&#039;on va stocker à l&#039;intérieur du conteneur chiffré du système (pour qu&#039;elle ne soit pas exposées). Ainsi, lorsque l&#039;on déverrouillera le premier conteneur chiffré les clefs seront disponible et nous déverrouilleront alors les partitions de swap. Ces commandes générer les clefs, les placent dans /etc/ssl/private puis supprime les anciens mots de passe du swap:
</p>
<pre class="code">dd if=/dev/urandom of=/etc/ssl/private/swapa.key bs=64k count=1
dd if=/dev/urandom of=/etc/ssl/private/swapb.key bs=64k count=1
dd if=/dev/urandom of=/etc/ssl/private/system.key bs=64k count=1
cryptsetup luksAddKey /dev/sda3 /etc/ssl/private/swapa.key
cryptsetup luksAddKey /dev/sdb3 /etc/ssl/private/swapb.key
cryptsetup luksAddKey /dev/md1 /etc/ssl/private/system.key
cryptsetup luksKillSlot --key-file /etc/ssl/private/swapa.key /dev/sda3 0
cryptsetup luksKillSlot --key-file /etc/ssl/private/swapb.key /dev/sdb3 0</pre>

<p>
Vous connaissez <a href="http://doc.ubuntu-fr.org/fstab#le_fichier_fstab" class="wikilink2" title="fstab" rel="nofollow">fstab</a>? <a href="../../cryptsetup" class="wikilink1" title="cryptsetup">crypttab</a> c&#039;est son complément pour les volumes chiffrés. Ce fichier explique où sont les conteneur chiffrés et comment le système doit les déverrouiller:
</p>
<dl class="file">
<dt><a href="http://doc.ubuntu-fr.org/_export/code/utilisateurs/lildadou/mediabunker?codeblock=15" title="Télécharger un extrait" class="mediafile mf_">/etc/crypttab</a></dt>
<dd><pre class="code file text"># &lt;target name&gt;	&lt;source device&gt;					&lt;key file&gt;			&lt;options&gt;
unlocked-md1	/dev/md1					none				luks,retry=1
unlocked-swapa	UUID=x x x x -uuid- de -/dev/sda3 x x x x	/etc/ssl/private/swapa.key	luks,swap
unlocked-swapb	UUID=x x x x -uuid- de -/dev/sdb3 x x x x	/etc/ssl/private/swapb.key	luks,swap</pre>
</dd></dl>

<p>
Maintenant qu&#039;on a bien détailler au système la procédure de démarrage, on installe le nouvelle initrd :
</p>
<pre class="code">update-initramfs -k all -c</pre>

<p>
Vous pouvez maintenant redémarrer :)
</p>
<pre class="code">exit
umount /target/boot
umount /target/proc
umount /target/sys
umount /target/dev/pts
umount /target/dev
umount /target/home
umount /target/
vgchange -an rootvg
cryptsetup luksClose /dev/mapper/unlocked-swapa
cryptsetup luksClose /dev/mapper/unlocked-swapb
cryptsetup luksClose /dev/mapper/unlocked-md1
reboot now</pre>

</div>

<h2 class="sectionedit17" id="installation_des_services_mediacenter">Installation des services mediacenter</h2>
<div class="level2">

<p>
Nous avons maintenant une plateforme qui démarre. Nous allons transformer cette brique chiffrée en mediacenter fonctionnel.
</p>

<p>
Script d&#039;installation rapide:
</p>
<ul>
<li class="level1"><div class="li"> ssh, screen: Pour le tâche d&#039;administration à distance</div>
</li>
<li class="level1"><div class="li"> fglrx: Pour l&#039;accélération matérielle</div>
</li>
<li class="level1"><div class="li"> xbmc, xbmc-wiiremote: Pour le multimédia et la prise en charge de la wiimmote</div>
</li>
<li class="level1"><div class="li"> deluge-web: Client bittorrent et son interface web</div>
</li>
<li class="level1"><div class="li"> nginx: Front-end Web performant pour tout nos services accessible depuis le Web</div>
</li>
<li class="level1"><div class="li"> php5-fpm: Pour d&#039;autre service Web</div>
</li>
<li class="level1"><div class="li"> python-pip: Pour installer Flexget</div>
</li>
<li class="level1"><div class="li"> pgld: Pour filtrer les communications vers des machines indésirables (sniffer, botnet, hadopi, …)</div>
</li>
<li class="level1"><div class="li"> smartmontools: pour le monitoring des disques durs</div>
</li>
<li class="level1"><div class="li"> postfix, opendkim: pour l&#039;envoi de mail (notamment pour prévenir des pannes détectés par smartmontools)</div>
</li>
<li class="level1"><div class="li"> dnssec: pour une résolution sans faille (notamment pour que opendkim arrête de nous insulter)</div>
</li>
<li class="level1"><div class="li"> spamassin, spamass-milter: pour recevoir des mails</div>
</li>
</ul>
<pre class="code">add-apt-repository ppa:wsnipex/xbmc-xvba
add-apt-repository ppa:nginx/development
add-apt-repository ppa:deluge-team/ppa
add-apt-repository ppa:jre-phoenix/pgl-experimental
apt-get update
apt-get autoremove transmission-gtk
apt-get install ssh screen \
fglrx xbmc-standalone xbmc-eventclients-wiiremote \
nginx-full php5-fpm php5-gd php5-mysql mysql-server mysql-client \
deluged deluge-web python-pip pgld
pip install flexget
# Copier les script dans /etc/init.d/
update-rc.d deluge-daemon defaults
update-rc.d xbmc-wiiremote defaults</pre>
<dl class="file">
<dt><a href="http://doc.ubuntu-fr.org/_export/code/utilisateurs/lildadou/mediabunker?codeblock=19" title="Télécharger un extrait" class="mediafile mf_d_deluge-daemon">/etc/init.d/deluge-daemon</a></dt>
<dd><pre class="file"></pre>
</dd></dl>
<dl class="file">
<dt><a href="http://doc.ubuntu-fr.org/_export/code/utilisateurs/lildadou/mediabunker?codeblock=20" title="Télécharger un extrait" class="mediafile mf_d_xbmc-wiiremote">/etc/init.d/xbmc-wiiremote</a></dt>
<dd><pre class="file"></pre>
</dd></dl>
<dl class="file">
<dt><a href="http://doc.ubuntu-fr.org/_export/code/utilisateurs/lildadou/mediabunker?codeblock=21" title="Télécharger un extrait" class="mediafile mf_">/etc/nginx/sites-available/mediabunker</a></dt>
<dd><pre class="file"></pre>
</dd></dl>

<p>
A virer:
</p>
<ol>
<li class="level1"><div class="li"> Remplacer les clef SSH. Générer de nouveaux groupes d&#039;échanges Diffie-Hellman :</div>
</li>
</ol>
<pre class="code">ssh-keygen -G candidates -b 4096</pre>

<p>
Tester la primalité du groupe d&#039;échange :
</p>
<pre class="code">ssh-keygen -f candidates -T moduli</pre>

<p>
Remplacer l&#039;ancien groupe d&#039;échange (/etc/ssh/moduli) par le nouveau. Vous pouvez re-générer d&#039;avantage de groupes et les concatener ensemble pour plus de sécurité (il faut juste qu&#039;ils soient de la même taille).
</p>
<ol>
<li class="level1"><div class="li"> Installer fail2ban</div>
</li>
<li class="level1"><div class="li"> <a href="http://doc.ubuntu-fr.org/xbmc" class="wikilink1" title="xbmc">Installation de XBMC</a></div>
</li>
<li class="level1"><div class="li"> wiimote 64bits :</div>
</li>
</ol>
<pre class="code">apt-get install libbluetooth-dev g++ libcwiid1 xbmc-eventclients-common</pre>

<p>
compile, copier libwiiuse.so dans /usr/local/bin, modifier le makefile pour utiliser /usr/local/bin/libwiiuse.so, compiler
</p>
<ol>
<li class="level1"><div class="li"> aparté sur les nom de domaine (Free, dyndns, …)</div>
</li>
<li class="level1"><div class="li"> ajout autorité racine</div>
</li>
<li class="level1"><div class="li"> génération certificat SSL</div>
</li>
</ol>

<p>
Générer une clef privée RSA :
</p>
<pre class="code">openssl genrsa -out /etc/ssl/private/transmission.4096.key 4096
openssl dhparam -out /etc/ssl/private/transmission.dh2048.key 2048
chmod o-r /etc/ssl/private/transmission.*
chown root:www-data /etc/ssl/private/transmission.*</pre>

<p>
On génère ensuite une <a href="http://en.wikipedia.org/wiki/Certificate_signing_request" class="urlextern" title="http://en.wikipedia.org/wiki/Certificate_signing_request"  rel="nofollow">CSR</a> :
</p>
<pre class="code">openssl req -new -key /etc/ssl/private/transmission.4096.key</pre>

<p>
Cette demande de signature ne dévoile pas d&#039;informations à un attaquant cryptographiques, vous pouvez maintenant fournir cette requête de signature auprès d&#039;une autorité de certification racine. Vous en trouverez pour quelques centaines d&#039;euros… ou bien il y a CaCert (Open-source, soutenu par <abbr title="GNU&#039;s Not Unix">GNU</abbr>) et StartSSL (privé, gratuit, d&#039;avantage reconnu) :)
Ne pas oublier de concatener les certificats de la chaine de certification au votre (de l&#039;intermediaire le plus bas au plus haut et commencant par le votre).
</p>
<ol>
<li class="level1"><div class="li"> <a href="../../tutoriel/comment_installer_un_paquet" class="wikilink1" title="tutoriel:comment_installer_un_paquet">installer transmission-daemon</a> : <a href="apt://transmission-daemon" class="urlextern" title="apt://transmission-daemon"  rel="nofollow">apt://transmission-daemon</a>. Binder l&#039;interface d&#039;écoute en IPv6 sur le localhost à cause des listes p2p incompletes.</div>
</li>
<li class="level1"><div class="li"> install nginx série depuis les dépots des concepteurs (à jour et avec d&#039;avantages d&#039;options) :</div>
</li>
</ol>
<pre class="code">add-apt-repository ppa:nginx/development
apt-get update
apt-get install nginx-full</pre>
<dl class="file">
<dt><a href="http://doc.ubuntu-fr.org/_export/code/utilisateurs/lildadou/mediabunker?codeblock=28" title="Télécharger un extrait" class="mediafile mf_">/etc/nginx/sites-available/mediabunker</a></dt>
<dd><pre class="file"></pre>
</dd></dl>

<p>
<a href="http://wiki.cchtml.com/index.php/Ubuntu_Maverick_Installation_Guide#Installing_Proprietary_Drivers_a.k.a._Catalyst.2Ffglrx" class="urlextern" title="http://wiki.cchtml.com/index.php/Ubuntu_Maverick_Installation_Guide#Installing_Proprietary_Drivers_a.k.a._Catalyst.2Ffglrx"  rel="nofollow">Activer l&#039;accélération matérielle pour ATI (obsolète)</a>
<a href="http://forum.xbmc.org/showthread.php?tid=116996" class="urlextern" title="http://forum.xbmc.org/showthread.php?tid=116996"  rel="nofollow">XvBA (décompression vidéo materielle)</a>
</p>

</div>

<h3 class="sectionedit18" id="protection_contre_les_spiders_indesirables">Protection contre les spiders indésirables</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> install de <del>blockcontrol</del> pgld (PeerGuardian Daemon). <a href="http://papillon-butineur.blogspot.com/2010/05/ip-filter-peergardian-linux-pgl-succede.html" class="urlextern" title="http://papillon-butineur.blogspot.com/2010/05/ip-filter-peergardian-linux-pgl-succede.html"  rel="nofollow">Tuto suivi</a></div>
</li>
</ul>

</div>

<h2 class="sectionedit19" id="avanceevoluer_son_raid0_vers_un_raid56">Avancé : Évoluer son RAID0 vers un RAID5/6</h2>
<div class="level2">

<p>
On l&#039;a vu précédemment, votre système dispose en partie d&#039;une protection contre les pannes car votre <em>GRUB</em> et votre <em>/boot</em> sont sur une grappe RAID1. Par contre, votre /home et le reste du système sont sur un RAID0 ; une partie du système est donc plus sensible à la panne (le défaut d&#039;un seul disque d&#039;une grappe RAID0 entraine le défaut de toute la grappe). Des solutions RAID proposent de tolérer le défaut d&#039;un (RAID5) ou de deux disques (RAID6) sans mettre en défaut toute la grappe. De cette façon, si un disque tombe en panne vous aurez un avertissement et pourrez changer le(s) disque(s) défaillant(s) sans avoir perdu vos données!
</p>

<p>
<em>Ce qui suit s&#039;appuie sur <a href="../../deplacer_root" class="wikilink1" title="deplacer_root">un</a>, voire <a href="http://doc.ubuntu-fr.org/tutoriel/deplacer_home" class="wikilink1" title="tutoriel:deplacer_home">deux</a> articles de ce site.</em>
</p>

</div>

<h3 class="sectionedit20" id="preparation">Préparation</h3>
<div class="level3">
<ol>
<li class="level1"><div class="li"> Démarrage sur Live-CD</div>
</li>
<li class="level1"><div class="li"> Installation des paquets lvm2, cryptsetup et mdadm</div>
</li>
<li class="level1"><div class="li"> Assemblage du RAID</div>
</li>
<li class="level1"><div class="li"> Déverrouillage du container existant</div>
</li>
<li class="level1"><div class="li"> Montage du container déverrouillé</div>
</li>
</ol>

</div>

<h3 class="sectionedit21" id="la_sauvegarde">La sauvegarde</h3>
<div class="level3">

<p>
On ne peut plus convertir une grappe RAID de niveau 0 vers un autre niveau atteignable (niveaux 5 et 6, par exemple). Je vous propose d&#039;envoyer un paquet de café d&#039;arabica de Colombie aux développeurs de mdadm accompagné d&#039;une requête d&#039;ajout de fonctionnalité (ou plutôt de correction de regression par rapport à <em>raidreconf</em>).
</p>

<p>
Admettez qu&#039;il serait plutôt cocasse de sauvegarder nos données si durement protégées…
</p>
<ol>
<li class="level1"><div class="li"> <span class="curid"><a href="mediabunker#nettoyage_des_support_physique" class="wikilink1" title="utilisateurs:lildadou:mediabunker">Commencer par neutraliser cryptographiquement votre disque de sauvegarde</a></span></div>
</li>
<li class="level1"><div class="li"> <span class="curid"><a href="mediabunker#raid_luks_lvm" class="wikilink1" title="utilisateurs:lildadou:mediabunker">Créez-y ensuite un conteneur LUKS (sans vous préoccuper de l&#039;alignement ou du partionnement)</a></span></div>
</li>
<li class="level1"><div class="li"> <span class="curid"><a href="mediabunker#raid_luks_lvm" class="wikilink1" title="utilisateurs:lildadou:mediabunker">Déverrouillez le conteneur LUKS</a></span></div>
</li>
<li class="level1"><div class="li"> Formatez le conteneur déverrouillé, montez-le et transférez-y vos données</div>
</li>
</ol>
<pre class="code">shred --iterations=N --verbose /dev/sdX
cryptsetup luksFormat --cipher=aes-xts-plain64 --hash=sha256 --key-size=512 /dev/sdX
cryptsetup luksOpen /dev/sdX unlocked-sdX
mkfs.ext4 /dev/mapper/unlocked-sdX
mkdir ./myBackup
mount /dev/mapper/unlocked-sdX ./myBackup
mkdir ./myBackup/root
mkdir ./myBackup/home
cp -axv ./mySystem/root/. ./myBackup/root/
cp -axv ./mySystem/home/. ./myBackup/home/</pre>

<p>
Une fois la sauvegarde terminée, on désactive une-à-une les couches logicielle de notre ancien RAID pour les rendre disponibles :
</p>
<pre class="code">umount  ./mySystem/root
umount ./mySystem/home
vgchange --available n rootvg
vgremove rootvg
pvremove /dev/md1
cryptsetup luksClose unlocked-md1
mdadm --stop /dev/md1</pre>

</div>

<h3 class="sectionedit22" id="raidlukslvmfilesytem">RAID / LUKS / LVM / FileSytem</h3>
<div class="level3">

<p>
Vous pouvez maintenant reproduire l&#039;<span class="curid"><a href="mediabunker#raid_luks_lvm" class="wikilink1" title="utilisateurs:lildadou:mediabunker">étape de création des différentes couches logiques</a></span>, RAID, LUKS et LVM. Seul la commande de création du RAID diffère : au lieu d&#039;un RAID0 de 2 disques nous souhaitons un RAID5 de 3 disques en précisant que le 3ème disque n&#039;est pas encore disponible (puisqu&#039;il sert à contenir notre sauvegarde). Ce qui donne la commande :
</p>
<pre class="code">mdadm --create /dev/md1 --metadata=1.2 --raid-devices=3 --chunk=128 --level=5 /dev/sd[ab]4 missing</pre>

<p>
Une fois que vous avez créer les autres couches, reste la création du système de fichier, le remontage et le transfère de votre sauvegarde sur votre nouvel assemblage :
</p>
<pre class="code">mkfs.ext4 -b 4096 -E stride=32,stripe-width=64 -L system /dev/mapper/rootvg-systemlv
mkfs.ext4 -b 4096 -E stride=32,stripe-width=64 -L home /dev/mapper/rootvg-homelv
mount /dev/mapper/rootvg-systemlv ./mySystem/root
mount /dev/mapper/rootvg-homelv ./mySystem/home
cp -axv ./myBackup/root/. ./mySystem/root/
cp -axv ./myBackup/home/. ./mySystem/home/</pre>

<p>
On libère notre disque de sauvegarde pour sa future mission : intégrer la nouvelle grappe RAID.
</p>
<pre class="code">umount  ./myBackup/root
umount ./myBackup/home
cryptsetup luksClose unlocked-sdX</pre>

</div>

<h3 class="sectionedit23" id="actualisation_des_fichiers_de_configuration">Actualisation des fichiers de configuration</h3>
<div class="level3">
<ol>
<li class="level1"><div class="li"> Actualisez /etc/mdadm/mdadm.conf</div>
</li>
<li class="level1"><div class="li"> Updatez l&#039;initramfs, <em>au cas où</em></div>
</li>
</ol>

</div>

<h3 class="sectionedit24" id="integration_du_nouveau_disque">Intégration du nouveau disque</h3>
<div class="level3">

<p>
Pour des questions d&#039;alignement, vous devez reproduire le même schèma de partitionnement que sur vos autres disques. Personnellement, j&#039;affiche avec précision mon schéma de partionnement avec la commande :
</p>
<pre class="code">parted /dev/sdX unit s print</pre>

<p>
pour ensuite les ré-appliquer sur le nouveau disque. Pour les habitués du RAID, sfdisk ne fonctionnera pas avec nos tables de partitions GPT.
</p>

<p>
Faite ensuite participer votre disque à vos grappe RAID (celle de <em>/boot</em> et de <em>root</em>) :
</p>
<pre class="code">mdadm --grow /dev/md0 --raid-devices=3
mdadm --add /dev/md0 /dev/sdX2
mdadm --add /dev/md1 /dev/sdX4</pre>

<p>
Le système entame ensuite une phase de synchronisation qui peut être extrêmement longue. Observez patiemment l&#039;évolution de votre synchronisation avec la commande :
</p>
<pre class="code">watch cat /proc/mdstat</pre>

</div>

<h2 class="sectionedit25" id="voir_aussi">Voir aussi</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <strong>(fr)</strong> <a href="http://2010.rmll.info/IMG/pdf/06_denis_article-2.pdf" class="urlextern" title="http://2010.rmll.info/IMG/pdf/06_denis_article-2.pdf"  rel="nofollow">Le chiﬀrement de disque sous linux : Vrai ou faux sentiment de sécurité ?</a> - Le document à lire qui explique les attaques possibles sur un système, presque ou intégralement, chiffré et les contre-attaques possibles.</div>
</li>
<li class="level1"><div class="li"> <a href="http://alephnull.com/benchmarks/sata2009/index.html" class="urlextern" title="http://alephnull.com/benchmarks/sata2009/index.html"  rel="nofollow">Benchmark sur les différents niveaux de RAID avec plusieurs chunk-size et disque ainsi que l&#039;impact de LUKS sur un RAID5 avec différents alignement-payload</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.korben.info/comment-chiffrer-une-partition-systeme-linux-ici-ubuntu.html" class="urlextern" title="http://www.korben.info/comment-chiffrer-une-partition-systeme-linux-ici-ubuntu.html"  rel="nofollow">Comment chiffrer une partition système Linux (Korben)</a></div>
</li>
<li class="level1"><div class="li"> <strong>(en)</strong> <a href="http://lfde.org/" class="urlextern" title="http://lfde.org/"  rel="nofollow">Linux Full Disk Encryption</a></div>
</li>
<li class="level1"><div class="li"> <strong>(en)</strong> <a href="https://wiki.archlinux.org/index.php/RAID_Encryption_LVM" class="urlextern" title="https://wiki.archlinux.org/index.php/RAID_Encryption_LVM"  rel="nofollow">RAID Encryption LVM</a></div>
</li>
<li class="level1"><div class="li"> <strong>(fr,pdf)</strong> <a href="http://www.amossys.fr/publications/C&amp;ESAR_2008-Amossys_article_TPM.pdf" class="urlextern" title="http://www.amossys.fr/publications/C&amp;ESAR_2008-Amossys_article_TPM.pdf"  rel="nofollow">Composant cryptographique TPM - Retours d&#039;expériences et perspectives</a></div>
</li>
<li class="level1"><div class="li"> <strong>(en)</strong> <a href="https://help.ubuntu.com/community/EncryptedFilesystemOnIntrepid" class="urlextern" title="https://help.ubuntu.com/community/EncryptedFilesystemOnIntrepid"  rel="nofollow">Documentation de la communauté offcielle</a> (un peu vieux mais m&#039;a débloqué pour le cryptroot script-hooking)</div>
</li>
<li class="level1"><div class="li"> <strong>(en)</strong> <a href="http://xercestech.com/full-system-encryption-for-linux.geek" class="urlextern" title="http://xercestech.com/full-system-encryption-for-linux.geek"  rel="nofollow">(Du vrai) Full system encryption for Linux</a> <a href="http://michael.gorven.za.net/cgi-bin/hgwebdir.fcgi/grub/luks-old/" class="urlextern" title="http://michael.gorven.za.net/cgi-bin/hgwebdir.fcgi/grub/luks-old/"  rel="nofollow">Lien pour le patch</a></div>
</li>
<li class="level1"><div class="li"> <strong>(en)</strong> <a href="https://calomel.org/nginx.html" class="urlextern" title="https://calomel.org/nginx.html"  rel="nofollow">Reference : Configuration nginx</a></div>
</li>
<li class="level1"><div class="li"> <strong>(fr)</strong> <a href="http://www.gnu.org/philosophy/can-you-trust.html" class="urlextern" title="http://www.gnu.org/philosophy/can-you-trust.html"  rel="nofollow">Pouvez-vous faire confiance à votre ordinateur ?</a> (????), Richard Stallman. Traduit de <em>Free Software Free Society: Selected Essays of Richard</em></div>
</li>
</ul>

</div>

<!-- cachefile /srv/www/doc.ubuntu-fr.org/htdocs/data/cache/c/cf425b066be24a42d0bbfaff3c3ab459.xhtml used -->

        <br style="clear:both;" />
        <div id="pageinfo">
            <!--  |  | -->
            <!-- ?tpl_pageinfo()? -->
            <br />
            Le contenu de ce wiki est sous licence : <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" rel="license" target="_blank">CC BY-SA v3.0</a>
        </div> 
      </div>

      
      <div id="navigation">

        <ul>
          <li class="menu"><a href="http://www.ubuntu-fr.org" class="title" id="menu-accueil"><span>Accueil</span></a></li>
          <li class="menu" id="active">
            <a href="../../index.html"  class="title" id="menu-doc"><span>Documentation</span></a>
            <ul>
              <li id="navWiki" class="cat">
                <h2>Actions</h2>
                <ul>
                  <li><a href="http://doc.ubuntu-fr.org/utilisateurs/lildadou/mediabunker?do=index"  class="action index" accesskey="x" rel="nofollow" title="Plan du site [X]">Plan du site</a></li>
                  <li><a href="http://doc.ubuntu-fr.org/utilisateurs/lildadou/mediabunker?do=edit&amp;rev=0"  class="action source" accesskey="v" rel="nofollow" title="Afficher le texte source [V]">Afficher le texte source</a></li>
                  <li><a href="http://doc.ubuntu-fr.org/utilisateurs/lildadou/mediabunker?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]">Anciennes révisions</a></li>
                  <li></li>
                  <li><a href="http://doc.ubuntu-fr.org/utilisateurs/lildadou/mediabunker?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Derniers changements [R]">Derniers changements</a></li>
                  <li><a href="http://doc.ubuntu-fr.org/utilisateurs/lildadou/mediabunker?do=backlink"  class="action backlink" rel="nofollow" title="Liens vers cette page">Liens vers cette page</a></li>
                  <li></li>
                  <li></li>
                  <li></li>
                </ul>
              </li>
              <li id="navDivers" class="cat">
                <h2>Divers</h2>
                <ul>
                  <li><bdi><a href="../../wiki/participer_wiki" class="wikilink1" title="wiki:participer_wiki">Participer à la documentation</a></bdi></li>
                  <li><bdi><a href="../../documentation_hors_ligne" class="wikilink1" title="documentation_hors_ligne">Documentation hors ligne</a></bdi></li>
                  <li><a href="http://www.ubuntu-fr.org/telechargement" title="T&eacute;l&eacute;charger Ubuntu">T&eacute;l&eacute;charger Ubuntu</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li class="menu"><a href="http://forum.ubuntu-fr.org"  class="title" id="menu-forum"><span>Forum</span></a></li>
          <li class="menu"><a href="http://planet.ubuntu-fr.org"  class="title" id="menu-planet"><span>Planet</span></a></li>
        </ul>

      </div>
      <div id="references-ufr">
        <ul id="legal-ufr">
          <li><a href="http://www.ubuntu-fr.org/contacts">Contact</a></li>
        </ul>

        <ul id="sponsors-ufr">
          <li><a href="http://www.dokuwiki.org/dokuwiki" id="dokuwiki">Propulsé par Dokuwiki</a></li>
        </ul>
      </div>

    </div>
    <!-- $Id$ -->

    <!-- Piwik Image Tracker -->
    <!-- img src="http://piwik.infra.ubuntu-fr.org/piwik.php?idsite=2&amp;rec=1" style="border:0" alt="" /-->
    <!-- End Piwik -->

  </body>
</html>
